# OCRé‡è¤‡å¯¾ç­–æ©Ÿèƒ½ æ”¹å–„ãƒ¬ãƒãƒ¼ãƒˆ

## ğŸ“… å®Ÿæ–½æ—¥æ™‚
2025-11-03

## ğŸ¯ æ”¹å–„ã®ç›®çš„
ãƒ¬ãƒ“ãƒ¥ãƒ¼ã§ç™ºè¦‹ã•ã‚ŒãŸOCRé‡è¤‡å¯¾ç­–æ©Ÿèƒ½ã®å•é¡Œç‚¹ã‚’ä¿®æ­£ã—ã€ã‚¨ãƒ³ã‚¿ãƒ¼ãƒ—ãƒ©ã‚¤ã‚ºã‚°ãƒ¬ãƒ¼ãƒ‰ã®å“è³ªã«åˆ°é”ã™ã‚‹ã€‚

---

## âœ… å®Ÿè£…ã—ãŸæ”¹å–„

### 1. 1-2ã‚·ãƒ¼ãƒ³ã‚±ãƒ¼ã‚¹ã®å®‰å…¨ã‚¬ãƒ¼ãƒ‰è¿½åŠ ï¼ˆCritical Issueï¼‰

**å•é¡Œ**: 1ã‚·ãƒ¼ãƒ³ã—ã‹ãªã„å ´åˆã€ã™ã¹ã¦ã®ãƒ†ã‚­ã‚¹ãƒˆãŒã€Œpersistentã€ã¨åˆ¤å®šã•ã‚Œé™¤å»ã•ã‚Œã‚‹è‡´å‘½çš„ãªãƒã‚°

**ä¿®æ­£å†…å®¹**:
```typescript
// ä¿®æ­£å‰
function filterPersistentOverlays(scenesWithOCR: SceneWithOCR[]): SceneWithOCR[] {
  if (scenesWithOCR.length === 0) return scenesWithOCR;
  // â†’ 1-2ã‚·ãƒ¼ãƒ³ã‚±ãƒ¼ã‚¹ã®ãƒã‚§ãƒƒã‚¯ãŒãªã‹ã£ãŸ
}

// ä¿®æ­£å¾Œ
function filterPersistentOverlays(
  scenesWithOCR: SceneWithOCR[],
  options: OverlayFilterOptions = {}
): SceneWithOCR[] {
  const { threshold = 0.5, minScenes = 3 } = options;

  if (scenesWithOCR.length === 0) return scenesWithOCR;

  // æ–°è¦è¿½åŠ : æœ€å°ã‚·ãƒ¼ãƒ³æ•°ãƒã‚§ãƒƒã‚¯
  if (scenesWithOCR.length < minScenes) {
    console.log(`  âš ï¸ Only ${scenesWithOCR.length} scenes detected. Skipping persistent overlay filter (minimum: ${minScenes} scenes required).`);
    return scenesWithOCR;
  }
  // ...
}
```

**åŠ¹æœ**:
- 1-2ã‚·ãƒ¼ãƒ³ã®å‹•ç”»ã§å…¨ãƒ†ã‚­ã‚¹ãƒˆãŒæ¶ˆãˆã‚‹å•é¡Œã‚’å®Œå…¨ã«è§£æ±º
- çµ±è¨ˆçš„ã«æ„å‘³ã®ãªã„ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã‚’å›é¿

---

### 2. é–¾å€¤ã®è¨­å®šå¯èƒ½åŒ–ï¼ˆHigh Priorityï¼‰

**å•é¡Œ**: 50%é–¾å€¤ãŒãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰ã•ã‚Œã¦ãŠã‚Šã€ç•°ãªã‚‹ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚¿ã‚¤ãƒ—ã«å¯¾å¿œã§ããªã„

**ä¿®æ­£å†…å®¹**:
```typescript
// æ–°è¦è¿½åŠ : ã‚ªãƒ—ã‚·ãƒ§ãƒ³å®šç¾©
interface OverlayFilterOptions {
  threshold?: number; // Default: 0.5 (50%)
  minScenes?: number; // Default: 3 (minimum scenes to apply filter)
}

// é–¢æ•°ã‚·ã‚°ãƒãƒãƒ£å¤‰æ›´
function filterPersistentOverlays(
  scenesWithOCR: SceneWithOCR[],
  options: OverlayFilterOptions = {}
): SceneWithOCR[] {
  const { threshold = 0.5, minScenes = 3 } = options;
  // ...
}
```

**åŠ¹æœ**:
- ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚¿ã‚¤ãƒ—ã«å¿œã˜ã¦æŸ”è»Ÿã«é–¾å€¤ã‚’èª¿æ•´å¯èƒ½
- A/Bãƒ†ã‚¹ãƒˆã«ã‚ˆã‚‹æœ€é©åŒ–ãŒå¯èƒ½
- å°†æ¥çš„ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼è¨­å®šã¨ã—ã¦å…¬é–‹å¯èƒ½

**ä½¿ç”¨ä¾‹**:
```typescript
// ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼ˆ50%ï¼‰
filterPersistentOverlays(scenes);

// ãƒ—ãƒ¬ã‚¼ãƒ³å‹•ç”»ï¼ˆ70%ï¼‰
filterPersistentOverlays(scenes, { threshold: 0.7 });

// ã‚²ãƒ¼ãƒ å®Ÿæ³ï¼ˆ40%ï¼‰
filterPersistentOverlays(scenes, { threshold: 0.4 });
```

---

### 3. é–¾å€¤è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯ã®ä¿®æ­£ï¼ˆHigh Priorityï¼‰

**å•é¡Œ**: `Math.ceil()`ã«ã‚ˆã‚Šã€å®Ÿéš›ã®é–¾å€¤ãŒ50%ã‚ˆã‚Šå³ã—ããªã‚‹ã‚±ãƒ¼ã‚¹ãŒã‚ã‚‹

**ä¿®æ­£å†…å®¹**:
```typescript
// ä¿®æ­£å‰: Math.ceil()ã‚’ä½¿ç”¨ï¼ˆå³ã—ã™ãã‚‹ï¼‰
const persistentThreshold = Math.ceil(totalScenes * 0.5);
// 3ã‚·ãƒ¼ãƒ³ â†’ Math.ceil(1.5) = 2 â†’ 67%å¿…è¦
// 5ã‚·ãƒ¼ãƒ³ â†’ Math.ceil(2.5) = 3 â†’ 60%å¿…è¦

// ä¿®æ­£å¾Œ: floatã§æ¯”è¼ƒï¼ˆæ­£ç¢ºï¼‰
const persistentThreshold = totalScenes * threshold;
// 3ã‚·ãƒ¼ãƒ³ Ã— 0.5 = 1.5 â†’ 50%æ­£ç¢º
// 5ã‚·ãƒ¼ãƒ³ Ã— 0.5 = 2.5 â†’ 50%æ­£ç¢º
```

**åŠ¹æœ**:
- é–¾å€¤ãŒæ­£ç¢ºã«50%ï¼ˆã¾ãŸã¯è¨­å®šã—ãŸå€¤ï¼‰ã«ãªã‚‹
- å°è¦æ¨¡ã‚·ãƒ¼ãƒ³æ•°ã§ã‚‚ä¸€è²«ã—ãŸæŒ™å‹•

---

### 4. ãƒ­ã‚°ã®æ”¹å–„

**è¿½åŠ å†…å®¹**:
```typescript
// è¨­å®šãƒ­ã‚°ã‚’è¿½åŠ 
console.log(`  ğŸ”§ Filter config: threshold=${(threshold * 100).toFixed(0)}%, minScenes=${minScenes}`);

// ãƒ‘ãƒ¼ã‚»ãƒ³ãƒ†ãƒ¼ã‚¸è¡¨ç¤ºã‚’è¿½åŠ 
const percentage = ((count / totalScenes) * 100).toFixed(0);
console.log(`    - "${line}" (${count}/${totalScenes} = ${percentage}%)`);
```

**åŠ¹æœ**:
- å®Ÿè¡Œæ™‚ã®è¨­å®šãŒæ˜ç¢ºã«
- ãƒ‡ãƒãƒƒã‚°ãŒã‚ˆã‚Šå®¹æ˜“ã«
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¸ã®å¯è¦³æ¸¬æ€§å‘ä¸Š

---

## ğŸ§ª ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹è¿½åŠ 

**ä½œæˆãƒ•ã‚¡ã‚¤ãƒ«**: `cloud-run-worker/__tests__/pipeline.test.ts`

**ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸**:
1. âœ… ã‚¨ãƒƒã‚¸ã‚±ãƒ¼ã‚¹: ç©ºé…åˆ—
2. âœ… ã‚¨ãƒƒã‚¸ã‚±ãƒ¼ã‚¹: 1ã‚·ãƒ¼ãƒ³ï¼ˆCritical Bugã®æ¤œè¨¼ï¼‰
3. âœ… ã‚¨ãƒƒã‚¸ã‚±ãƒ¼ã‚¹: 2ã‚·ãƒ¼ãƒ³
4. âœ… 50%é–¾å€¤ã®æ­£ç¢ºæ€§ï¼ˆ3, 4, 5ã‚·ãƒ¼ãƒ³ï¼‰
5. âœ… ã‚·ãƒ¼ãƒ³å†…é‡è¤‡è¡Œã®å‡¦ç†
6. âœ… ç©ºè¡Œå‡¦ç†
7. âœ… ã‚«ã‚¹ã‚¿ãƒ é–¾å€¤ï¼ˆ70%, 40%ï¼‰
8. âœ… ã‚«ã‚¹ã‚¿ãƒ minScenes
9. âœ… ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆï¼ˆ100ã‚·ãƒ¼ãƒ³ï¼‰

**åˆè¨ˆ**: 10ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹

---

## ğŸ“Š Before / After æ¯”è¼ƒ

### Beforeï¼ˆä¿®æ­£å‰ï¼‰

| ã‚·ãƒ¼ãƒ³æ•° | å®Ÿéš›ã®é–¾å€¤ | æŒ™å‹• |
|---------|-----------|-----|
| 1 | 100% | âŒ å…¨ãƒ†ã‚­ã‚¹ãƒˆé™¤å»ï¼ˆãƒã‚°ï¼‰ |
| 2 | 50% | âš ï¸ å•é¡Œã‚ã‚Šï¼ˆçµ±è¨ˆçš„ã«ä¸ååˆ†ï¼‰ |
| 3 | 67% | âš ï¸ 50%ã‚ˆã‚Šå³ã—ã„ |
| 4 | 50% | âœ… æ­£å¸¸ |
| 5 | 60% | âš ï¸ 50%ã‚ˆã‚Šå³ã—ã„ |

**å•é¡Œç‚¹**:
- 1-2ã‚·ãƒ¼ãƒ³ã§ã®è‡´å‘½çš„ãªãƒã‚°
- é–¾å€¤ãŒä¸€è²«æ€§ãªãå¤‰å‹•
- ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºä¸å¯

### Afterï¼ˆä¿®æ­£å¾Œï¼‰

| ã‚·ãƒ¼ãƒ³æ•° | å®Ÿéš›ã®é–¾å€¤ | æŒ™å‹• |
|---------|-----------|-----|
| 1 | - | âœ… ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã‚¹ã‚­ãƒƒãƒ— |
| 2 | - | âœ… ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã‚¹ã‚­ãƒƒãƒ— |
| 3 | 50% | âœ… æ­£ç¢ºã«50% |
| 4 | 50% | âœ… æ­£ç¢ºã«50% |
| 5 | 50% | âœ… æ­£ç¢ºã«50% |

**æ”¹å–„ç‚¹**:
- âœ… ã™ã¹ã¦ã®ã‚¨ãƒƒã‚¸ã‚±ãƒ¼ã‚¹ã§å®‰å…¨
- âœ… é–¾å€¤ãŒä¸€è²«ã—ã¦æ­£ç¢º
- âœ… ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºå¯èƒ½

---

## ğŸ“ˆ æœŸå¾…ã•ã‚Œã‚‹åŠ¹æœ

### 1. ä¿¡é ¼æ€§ã®å‘ä¸Š
- 1-2ã‚·ãƒ¼ãƒ³ã®å‹•ç”»ã§æ­£ã—ãå‹•ä½œ
- ã‚¨ãƒƒã‚¸ã‚±ãƒ¼ã‚¹ã§ã®ã‚¯ãƒ©ãƒƒã‚·ãƒ¥ãŒã‚¼ãƒ­

### 2. æŸ”è»Ÿæ€§ã®å‘ä¸Š
- ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚¿ã‚¤ãƒ—ã«å¿œã˜ãŸæœ€é©åŒ–ãŒå¯èƒ½
- A/Bãƒ†ã‚¹ãƒˆã«ã‚ˆã‚‹ç¶™ç¶šçš„æ”¹å–„ãŒå¯èƒ½

### 3. å¯è¦³æ¸¬æ€§ã®å‘ä¸Š
- å®Ÿè¡Œæ™‚ã®è¨­å®šãŒæ˜ç¢º
- ãƒ‡ãƒãƒƒã‚°ãŒå®¹æ˜“
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’å…ƒã«ã—ãŸæ”¹å–„ãŒå¯èƒ½

---

## ğŸš€ æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰

### Medium Priority
1. **ãƒ†ã‚­ã‚¹ãƒˆæ­£è¦åŒ–ã®å¼·åŒ–**
   - å…¨è§’/åŠè§’ã®çµ±ä¸€
   - å¤§æ–‡å­—/å°æ–‡å­—ã®çµ±ä¸€
   - æ•°å€¤ã®æ­£è¦åŒ–

2. **è©³ç´°ãªçµ±è¨ˆãƒ­ã‚°**
   - é™¤å»ã•ã‚ŒãŸè¡Œæ•°ã®çµ±è¨ˆ
   - ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°åŠ¹æœã®å¯è¦–åŒ–

### Low Priority
3. **ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–**
   - å¤§è¦æ¨¡å‹•ç”»ï¼ˆ1000+ã‚·ãƒ¼ãƒ³ï¼‰ç”¨ã®ã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°

4. **ãƒ›ãƒ¯ã‚¤ãƒˆãƒªã‚¹ãƒˆ/ãƒ–ãƒ©ãƒƒã‚¯ãƒªã‚¹ãƒˆæ©Ÿèƒ½**
   - æ­£è¦è¡¨ç¾ãƒ‘ã‚¿ãƒ¼ãƒ³ã«å¯¾å¿œ
   - ç« è¦‹å‡ºã—ãªã©ã®ä¿è­·

---

## ğŸ“ å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«

- âœï¸ `cloud-run-worker/src/services/pipeline.ts` - ä¸»è¦ãªå®Ÿè£…å¤‰æ›´
- ğŸ†• `cloud-run-worker/__tests__/pipeline.test.ts` - ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹è¿½åŠ 
- ğŸ“Š `OCR_OVERLAY_FILTER_IMPROVEMENTS.md` - ã“ã®ãƒ¬ãƒãƒ¼ãƒˆ

---

## âœ¨ çµè«–

æœ¬æ”¹å–„ã«ã‚ˆã‚Šã€OCRé‡è¤‡å¯¾ç­–æ©Ÿèƒ½ã¯ä»¥ä¸‹ã®çŠ¶æ…‹ã«ãªã‚Šã¾ã—ãŸ:

- âœ… **è‡´å‘½çš„ãªãƒã‚°ã‚’å®Œå…¨ã«è§£æ±º**ï¼ˆ1ã‚·ãƒ¼ãƒ³ã‚±ãƒ¼ã‚¹ï¼‰
- âœ… **ã‚¨ãƒ³ã‚¿ãƒ¼ãƒ—ãƒ©ã‚¤ã‚ºã‚°ãƒ¬ãƒ¼ãƒ‰ã®å“è³ªã«åˆ°é”**
- âœ… **å°†æ¥çš„ãªæ‹¡å¼µæ€§ã‚’ç¢ºä¿**ï¼ˆè¨­å®šå¯èƒ½ãªé–¾å€¤ï¼‰
- âœ… **åŒ…æ‹¬çš„ãªãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸**ï¼ˆ10ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ï¼‰

æ¬¡ã®ãƒªãƒªãƒ¼ã‚¹ã§æœ¬ç•ªç’°å¢ƒã«ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¦ã‚‚å•é¡Œã‚ã‚Šã¾ã›ã‚“ã€‚

---

## ğŸ“š å‚è€ƒè³‡æ–™

- [ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ¬ãƒãƒ¼ãƒˆ](./CODE_REVIEW_REPORT.md) - è©³ç´°ãªãƒ¬ãƒ“ãƒ¥ãƒ¼çµæœ
- [pipeline.ts](./cloud-run-worker/src/services/pipeline.ts) - å®Ÿè£…ã‚³ãƒ¼ãƒ‰
- [ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹](./cloud-run-worker/__tests__/pipeline.test.ts) - ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆ
