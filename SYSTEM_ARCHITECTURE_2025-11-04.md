# Video Analyzer V2 ã‚·ã‚¹ãƒ†ãƒ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

**ä½œæˆæ—¥**: 2025å¹´11æœˆ4æ—¥
**æœ€çµ‚æ›´æ–°æ—¥**: 2025å¹´11æœˆ7æ—¥
**ãƒãƒ¼ã‚¸ãƒ§ãƒ³**: 2.1.1
**ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: æœ¬ç•ªé‹ç”¨ä¸­

---

## ç›®æ¬¡

1. [ã‚·ã‚¹ãƒ†ãƒ æ¦‚è¦](#1-ã‚·ã‚¹ãƒ†ãƒ æ¦‚è¦)
2. [ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£å›³](#2-ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£å›³)
3. [æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯](#3-æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯)
4. [ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼ï¼ˆå®Œå…¨ç‰ˆï¼‰](#4-ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼å®Œå…¨ç‰ˆ)
5. [ä¸»è¦ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ](#5-ä¸»è¦ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ)
6. [ç’°å¢ƒå¤‰æ•°](#6-ç’°å¢ƒå¤‰æ•°)
7. [API ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆä»•æ§˜](#7-api-ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆä»•æ§˜)
8. [ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¹ã‚­ãƒ¼ãƒ](#8-ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¹ã‚­ãƒ¼ãƒ)
9. [å‡¦ç†ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³è©³ç´°](#9-å‡¦ç†ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³è©³ç´°)
10. [ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°](#10-ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°)
11. [ãƒ‡ãƒ—ãƒ­ã‚¤æ‰‹é †](#11-ãƒ‡ãƒ—ãƒ­ã‚¤æ‰‹é †)
12. [æœ€è¿‘ã®ä¸»è¦ãªä¿®æ­£](#12-æœ€è¿‘ã®ä¸»è¦ãªä¿®æ­£2025å¹´11æœˆ3-4æ—¥)
13. [ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°ã¨ãƒ­ã‚°](#13-ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°ã¨ãƒ­ã‚°)
14. [ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°](#14-ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°)

---

## 1. ã‚·ã‚¹ãƒ†ãƒ æ¦‚è¦

### ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå
**Video Analyzer V2 Web** - AIé§†å‹•å‹å‹•ç”»åˆ†æãƒ»æ–‡å­—èµ·ã“ã—ã‚¦ã‚§ãƒ–ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³

### ç›®çš„
å‹•ç”»ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã€AIï¼ˆWhisper + Gemini Visionï¼‰ã‚’ä½¿ç”¨ã—ã¦éŸ³å£°æ–‡å­—èµ·ã“ã—ã¨OCRã‚’å®Ÿè¡Œã—ã€Excelãƒ¬ãƒãƒ¼ãƒˆã¨ã—ã¦å‡ºåŠ›ã™ã‚‹ã€‚

### ä¸»è¦æ©Ÿèƒ½
- ğŸ¤ **Whisper AIéŸ³å£°æ–‡å­—èµ·ã“ã—** - ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ä»˜ãé«˜ç²¾åº¦éŸ³å£°ãƒ†ã‚­ã‚¹ãƒˆåŒ–
- ğŸ‘ï¸ **Gemini Vision OCR** - å‹•ç”»ãƒ•ãƒ¬ãƒ¼ãƒ ã‹ã‚‰ãƒ†ã‚­ã‚¹ãƒˆæŠ½å‡º
- ğŸ¬ **ã‚·ãƒ¼ãƒ³æ¤œå‡º** - ãƒãƒ«ãƒãƒ‘ã‚¹FFmpegã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã«ã‚ˆã‚‹æ­£ç¢ºãªã‚·ãƒ¼ãƒ³å¤‰åŒ–æ¤œå‡º
- ğŸ“Š **Excelãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ** - ã‚·ãƒ¼ãƒ³å˜ä½ã§ã®ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆåŸ‹ã‚è¾¼ã¿ã€OCRã€ãƒŠãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³çµ±åˆ
- ğŸ” **Clerkèªè¨¼** - ã‚»ã‚­ãƒ¥ã‚¢ãªãƒ¦ãƒ¼ã‚¶ãƒ¼èªè¨¼
- â˜ï¸ **ã‚¯ãƒ©ã‚¦ãƒ‰å‡¦ç†** - Google Cloud Runã«ã‚ˆã‚‹ã‚¹ã‚±ãƒ¼ãƒ©ãƒ–ãƒ«å‡¦ç†
- ğŸ“± **ã‚¹ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ³å¯¾å¿œ** - ç¸¦å‹•ç”»ã€4Kã‚³ãƒ³ãƒ†ãƒ³ãƒ„å¯¾å¿œ

### å¯¾å¿œå‹•ç”»å½¢å¼
- MP4, MOV, AVI, MKV, WebM
- ç¸¦ãƒ»æ¨ªå‘ãå¯¾å¿œ
- æœ€å¤§4Kè§£åƒåº¦
- ã‚¹ãƒ†ãƒ¬ã‚ª/ãƒ¢ãƒãƒ©ãƒ«éŸ³å£°
- éŸ³å£°ãªã—å‹•ç”»ï¼ˆOCRã®ã¿ï¼‰

---

## 2. ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£å›³

```mermaid
graph TB
    User[ãƒ¦ãƒ¼ã‚¶ãƒ¼]

    subgraph Vercel["Vercel (Next.js Frontend)"]
        Frontend[React UI<br/>VideoUploader]
        APIRoutes[API Routes<br/>/api/*]
        Auth[Clerkèªè¨¼]
    end

    subgraph VercelBlob["Vercel Blob Storage"]
        VideoBlob[å‹•ç”»ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸]
        ExcelBlob[Excelã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸]
    end

    subgraph CloudRun["Google Cloud Run (Worker)"]
        Express[Express.js ã‚µãƒ¼ãƒãƒ¼]
        Pipeline[å‡¦ç†ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³]
        FFmpeg[FFmpeg<br/>ã‚·ãƒ¼ãƒ³æ¤œå‡º]
        Whisper[OpenAI Whisper<br/>éŸ³å£°èªè­˜]
        Gemini[Gemini Vision<br/>OCR]
        ExcelGen[ExcelJS<br/>ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ]
    end

    subgraph Supabase["Supabase"]
        StatusDB[(processing_status)]
    end

    User -->|1. å‹•ç”»ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰| Frontend
    Frontend -->|2. èªè¨¼ç¢ºèª| Auth
    Auth -->|3. ãƒˆãƒ¼ã‚¯ãƒ³ç”Ÿæˆ| APIRoutes
    APIRoutes -->|4. ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰| VideoBlob
    APIRoutes -->|5. å‡¦ç†é–‹å§‹| Express

    Express -->|6. ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¨˜éŒ²| StatusDB
    Express -->|7. å‹•ç”»ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰| VideoBlob
    Pipeline -->|8. ã‚·ãƒ¼ãƒ³æ¤œå‡º| FFmpeg
    Pipeline -->|9. OCRå®Ÿè¡Œ| Gemini
    Pipeline -->|10. æ–‡å­—èµ·ã“ã—| Whisper
    Pipeline -->|11. Excelç”Ÿæˆ| ExcelGen
    ExcelGen -->|12. çµæœã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰| ExcelBlob
    Express -->|13. ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°| StatusDB

    Frontend -->|14. ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒãƒ¼ãƒªãƒ³ã‚°| APIRoutes
    APIRoutes -->|15. ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å–å¾—| StatusDB
    Frontend -->|16. ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰| APIRoutes
    APIRoutes -->|17. Excelå–å¾—| ExcelBlob
    APIRoutes -->|18. è‡ªå‹•å‰Šé™¤| VideoBlob
    APIRoutes -->|19. è‡ªå‹•å‰Šé™¤| ExcelBlob
```

### ã‚·ã‚¹ãƒ†ãƒ é–“é€šä¿¡ãƒ•ãƒ­ãƒ¼

```
[ãƒ¦ãƒ¼ã‚¶ãƒ¼]
    â†“ HTTPS
[Next.js Frontend (Vercel)]
    â†“ HTTPS + Bearer Token
[API Routes]
    â†“ HTTPS + WORKER_SECRET
[Cloud Run Worker (GCP)]
    â†“ HTTPS + Service Role Key
[Supabase Database]
    â†“ HTTPS
[Vercel Blob Storage]
```

---

## 3. æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯

### ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ (Vercel)
| æŠ€è¡“ | ãƒãƒ¼ã‚¸ãƒ§ãƒ³ | ç”¨é€” |
|------|-----------|------|
| Next.js | 14.2.0 | Reactãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ï¼ˆApp Routerï¼‰ |
| React | 18.3.0 | UIãƒ©ã‚¤ãƒ–ãƒ©ãƒª |
| TypeScript | 5.5.0 | å‹å®‰å…¨æ€§ |
| Tailwind CSS | 3.4.0 | ã‚¹ã‚¿ã‚¤ãƒªãƒ³ã‚° |
| Clerk | 5.0.0 | èªè¨¼ |
| @vercel/blob | 0.23.0 | ãƒ•ã‚¡ã‚¤ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ |
| @tanstack/react-query | 5.0.0 | ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚§ãƒƒãƒãƒ³ã‚°ãƒ»ã‚­ãƒ£ãƒƒã‚·ãƒ³ã‚° |
| axios | 1.7.0 | HTTPã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ |
| lucide-react | 0.400.0 | ã‚¢ã‚¤ã‚³ãƒ³ |

### ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ (Google Cloud Run)
| æŠ€è¡“ | ãƒãƒ¼ã‚¸ãƒ§ãƒ³ | ç”¨é€” |
|------|-----------|------|
| Node.js | 24.10.0 | ãƒ©ãƒ³ã‚¿ã‚¤ãƒ  |
| Express.js | 4.x | APIã‚µãƒ¼ãƒãƒ¼ |
| TypeScript | 5.5.0 | å‹å®‰å…¨æ€§ |
| FFmpeg | 7.1 (Static) | å‹•ç”»ãƒ»éŸ³å£°å‡¦ç† |
| OpenAI Whisper API | whisper-1 | éŸ³å£°æ–‡å­—èµ·ã“ã— |
| Google Gemini Vision | gemini-2.5-flash | OCR |
| ExcelJS | 4.x | Excelãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ |
| @supabase/supabase-js | 2.77.0 | ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ |
| @vercel/blob | 0.23.0 | ãƒ•ã‚¡ã‚¤ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ |
| silero-vad-node | æœ€æ–° | éŸ³å£°æ´»å‹•æ¤œå‡ºï¼ˆVADï¼‰ |

### ã‚¤ãƒ³ãƒ•ãƒ©ã‚¹ãƒˆãƒ©ã‚¯ãƒãƒ£
| ã‚µãƒ¼ãƒ“ã‚¹ | ç”¨é€” |
|---------|------|
| Vercel | ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ãƒ›ã‚¹ãƒ†ã‚£ãƒ³ã‚°ãƒ»CDN |
| Google Cloud Run | ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚³ãƒ³ãƒ†ãƒŠå®Ÿè¡Œï¼ˆus-central1ï¼‰ |
| Vercel Blob | å‹•ç”»ãƒ»Excelãƒ•ã‚¡ã‚¤ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ |
| Supabase | PostgreSQLãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ï¼ˆã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç®¡ç†ï¼‰ |
| Clerk | ãƒ¦ãƒ¼ã‚¶ãƒ¼èªè¨¼ãƒ»ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç† |

---

## 4. ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼ï¼ˆå®Œå…¨ç‰ˆï¼‰

### ãƒ•ã‚§ãƒ¼ã‚º1: ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰

```
1. ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå‹•ç”»é¸æŠï¼ˆVideoUploader.tsxï¼‰
2. Clerkèªè¨¼ç¢ºèªï¼ˆauth()ï¼‰
3. ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ãŒ /api/blob-upload ã«ãƒˆãƒ¼ã‚¯ãƒ³ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
   â””â”€ handleUpload() â†’ onBeforeGenerateToken()
   â””â”€ Vercel Blobãƒˆãƒ¼ã‚¯ãƒ³ç”Ÿæˆï¼ˆ500MBåˆ¶é™ã€å‹•ç”»å½¢å¼æ¤œè¨¼ï¼‰
4. Vercel Blobã«å‹•ç”»ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ï¼ˆupload()é–¢æ•°ï¼‰
   â””â”€ blobUrlå–å¾—
```

**ä½¿ç”¨ãƒ•ã‚¡ã‚¤ãƒ«**:
- `app/components/VideoUploader.tsx` (handleUpload)
- `app/api/blob-upload/route.ts` (POST handler)
- `@vercel/blob/client` (upload)

### ãƒ•ã‚§ãƒ¼ã‚º2: å‡¦ç†é–‹å§‹

```
5. ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ãŒ /api/process ã«POSTãƒªã‚¯ã‚¨ã‚¹ãƒˆ
   â””â”€ uploadId, blobUrl, fileName, dataConsenté€ä¿¡
6. /api/process ãŒ Cloud Run Worker ã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆè»¢é€
   â””â”€ Authorization: Bearer ${WORKER_SECRET}
   â””â”€ ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ: 25ç§’
7. Cloud Run Worker ãŒå‡¦ç†ã‚’éåŒæœŸé–‹å§‹
   â””â”€ Express /process ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ
   â””â”€ processVideo()é–¢æ•°å‘¼ã³å‡ºã—
   â””â”€ å³åº§ã«202 Acceptedè¿”å´
```

**ä½¿ç”¨ãƒ•ã‚¡ã‚¤ãƒ«**:
- `app/api/process/route.ts` (POST handler)
- `cloud-run-worker/src/index.ts` (Express /process)
- `cloud-run-worker/src/services/videoProcessor.ts` (processVideo)

### ãƒ•ã‚§ãƒ¼ã‚º3: å‹•ç”»å‡¦ç†ï¼ˆCloud Run Workerï¼‰

```
8. initStatus() â†’ Supabaseã«ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¨˜éŒ²
   â””â”€ upload_id, status='pending', progress=0
9. Vercel Blobã‹ã‚‰å‹•ç”»ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
   â””â”€ axios.get(blobUrl, { responseType: 'stream' })
   â””â”€ /tmp/video-analyzer-{randomId}/video.mp4
10. ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å®Œäº†å¾Œã€ã‚½ãƒ¼ã‚¹å‹•ç”»Blobå‰Šé™¤ï¼ˆè‡ªå‹•ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ï¼‰
    â””â”€ deleteBlob(blobUrl)
11. å‹•ç”»ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿æŠ½å‡º
    â””â”€ getVideoMetadata() â†’ ffprobe
    â””â”€ duration, width, height, aspectRatio
```

**ä½¿ç”¨ãƒ•ã‚¡ã‚¤ãƒ«**:
- `cloud-run-worker/src/services/videoProcessor.ts`
- `cloud-run-worker/src/services/statusManager.ts` (initStatus)
- `cloud-run-worker/src/services/ffmpeg.ts` (getVideoMetadata)
- `cloud-run-worker/src/services/blobCleaner.ts` (deleteBlob)

### ãƒ•ã‚§ãƒ¼ã‚º4: éŸ³å£°å‡¦ç†ï¼ˆVAD + Whisperï¼‰

```
12. éŸ³å£°ã‚¹ãƒˆãƒªãƒ¼ãƒ æ¤œå‡º
    â””â”€ hasAudioStream() â†’ FFmpeg probe
13. éŸ³å£°ã‚¹ãƒˆãƒªãƒ¼ãƒ å­˜åœ¨ç¢ºèª
    â””â”€ éŸ³å£°ã‚ã‚Š: 16kHz mono MP3æŠ½å‡º
    â””â”€ éŸ³å£°ãªã—: ã‚¹ã‚­ãƒƒãƒ—
14. VADï¼ˆéŸ³å£°æ´»å‹•æ¤œå‡ºï¼‰å‡¦ç†
    â””â”€ processAudioWithVAD()
    â””â”€ Silero VADä½¿ç”¨
    â””â”€ éŸ³å£°éƒ¨åˆ†ã®ã¿10ç§’ãƒãƒ£ãƒ³ã‚¯ã«åˆ†å‰²
15. Whisper APIå‘¼ã³å‡ºã—ï¼ˆéŸ³å£°ãƒãƒ£ãƒ³ã‚¯ã”ã¨ï¼‰
    â””â”€ transcribeAudioChunk()
    â””â”€ ãƒ¢ãƒ‡ãƒ«: whisper-1
    â””â”€ è¨€èª: jaï¼ˆæ—¥æœ¬èªï¼‰
    â””â”€ response_format: verbose_json
    â””â”€ ãƒªãƒˆãƒ©ã‚¤æ©Ÿæ§‹: 3å›ï¼ˆæŒ‡æ•°ãƒãƒƒã‚¯ã‚ªãƒ•ï¼‰
16. ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—èª¿æ•´
    â””â”€ ãƒãƒ£ãƒ³ã‚¯ã‚ªãƒ•ã‚»ãƒƒãƒˆè¿½åŠ 
    â””â”€ çµ¶å¯¾æ™‚é–“ã«å¤‰æ›
```

**ä½¿ç”¨ãƒ•ã‚¡ã‚¤ãƒ«**:
- `cloud-run-worker/src/services/audioExtractor.ts` (hasAudioStream, extractAudioForWhisper)
- `cloud-run-worker/src/services/audioWhisperPipeline.ts` (processAudioWithVADAndWhisper)
- `cloud-run-worker/src/services/vadService.ts` (processAudioWithVAD)

**VADçµ±è¨ˆ**:
- éŸ³å£°æ¯”ç‡ï¼ˆvoiceRatioï¼‰: å®Ÿéš›ã«éŸ³å£°ãŒå«ã¾ã‚Œã‚‹å‰²åˆ
- ã‚³ã‚¹ãƒˆå‰Šæ¸›ç‡ï¼ˆestimatedSavingsï¼‰: VADä½¿ç”¨ã«ã‚ˆã‚‹Whisper APIå‰Šæ¸›ç‡ï¼ˆ40-60%ï¼‰

### ãƒ•ã‚§ãƒ¼ã‚º5: ã‚·ãƒ¼ãƒ³æ¤œå‡ºã¨OCR

```
17. ãƒãƒ«ãƒãƒ‘ã‚¹FFmpegã‚·ãƒ¼ãƒ³æ¤œå‡º
    â””â”€ detectSceneCuts() â†’ é–¾å€¤: [0.03, 0.05, 0.10]
    â””â”€ 3å›å®Ÿè¡Œã—ã¦æœ€å¤§ä¿¡é ¼åº¦ã§ãƒãƒ¼ã‚¸
18. ã‚·ãƒ¼ãƒ³ç¯„å›²ç”Ÿæˆ
    â””â”€ generateSceneRanges()
    â””â”€ æœ€å°ã‚·ãƒ¼ãƒ³é•·: 0.5ç§’ï¼ˆçŸ­ã„ã‚·ãƒ¼ãƒ³ã‚’ãƒ•ã‚£ãƒ«ã‚¿ï¼‰
19. å„ã‚·ãƒ¼ãƒ³ã®ä¸­é–“ç‚¹ã§ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆæŠ½å‡º
    â””â”€ extractFrameAtTime() â†’ midTime
    â””â”€ è§£åƒåº¦: 1280x720ï¼ˆOCRæœ€é©åŒ–ï¼‰
    â””â”€ ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ: PNG
20. Gemini Vision OCRå®Ÿè¡Œï¼ˆã‚·ãƒ¼ãƒ³ã”ã¨ï¼‰
    â””â”€ performSceneBasedOCR()
    â””â”€ ãƒ¢ãƒ‡ãƒ«: gemini-2.5-flash
    â””â”€ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ: æ—¥æœ¬èªãƒ»è‹±èªãƒ»æ•°å­—å¯¾å¿œ
    â””â”€ ãƒ¬ã‚¹ãƒãƒ³ã‚¹: JSONå½¢å¼ï¼ˆtext, confidenceï¼‰
21. æ°¸ç¶šã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
    â””â”€ filterPersistentOverlays()
    â””â”€ 50%ä»¥ä¸Šã®ã‚·ãƒ¼ãƒ³ã«å‡ºç¾ã™ã‚‹ãƒ†ã‚­ã‚¹ãƒˆã‚’é™¤å»
    â””â”€ ãƒ­ã‚´ã€ã‚¦ã‚©ãƒ¼ã‚¿ãƒ¼ãƒãƒ¼ã‚¯ã€UIè¦ç´ é™¤å»
22. ãƒŠãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒãƒƒãƒ”ãƒ³ã‚°
    â””â”€ mapTranscriptionToScenes()
    â””â”€ ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—é‡è¤‡ã§ã‚·ãƒ¼ãƒ³ã«å‰²ã‚Šå½“ã¦
```

**ä½¿ç”¨ãƒ•ã‚¡ã‚¤ãƒ«**:
- `cloud-run-worker/src/services/pipeline.ts` (executeIdealPipeline)
- `cloud-run-worker/src/services/ffmpeg.ts` (detectSceneCuts, extractFrameAtTime)
- Google Generative AI SDK (Gemini Vision)

**ã‚·ãƒ¼ãƒ³æ¤œå‡ºã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ **:
- **ãƒãƒ«ãƒãƒ‘ã‚¹æ–¹å¼**: 3ã¤ã®ç•°ãªã‚‹é–¾å€¤ã§æ¤œå‡ºã—ã€çµ±åˆ
- **ä¸­é–“ç‚¹æŠ½å‡º**: ã‚·ãƒ¼ãƒ³ã®50%åœ°ç‚¹ã§ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆå–å¾—
- **æœ€å°ã‚·ãƒ¼ãƒ³é•·**: 0.5ç§’æœªæº€ã®ã‚·ãƒ¼ãƒ³ã‚’ã‚¹ã‚­ãƒƒãƒ—

### ãƒ•ã‚§ãƒ¼ã‚º6: Excelç”Ÿæˆ

```
23. ExcelJSã§ãƒ¯ãƒ¼ã‚¯ãƒ–ãƒƒã‚¯ä½œæˆ
    â””â”€ generateExcel()
    â””â”€ ãƒ¯ãƒ¼ã‚¯ã‚·ãƒ¼ãƒˆ: "Video Analysis", "Statistics"
24. åˆ—æ§‹æˆï¼ˆ5åˆ—ï¼‰
    â””â”€ A: Scene # (ã‚·ãƒ¼ãƒ³ç•ªå·)
    â””â”€ B: Timecode (HH:MM:SS)
    â””â”€ C: Screenshot (åŸ‹ã‚è¾¼ã¿ç”»åƒ)
    â””â”€ D: OCR Text (Gemini Visionçµæœ)
    â””â”€ E: NA Text (Whisperæ–‡å­—èµ·ã“ã—)
25. ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆåŸ‹ã‚è¾¼ã¿
    â””â”€ ã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯”ä¿æŒï¼ˆå‹•ç”»ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰ï¼‰
    â””â”€ ã‚»ãƒ«ä¸­å¤®é…ç½®
    â””â”€ EMUå˜ä½ï¼ˆ9525 EMU/pixelï¼‰ã§æ­£ç¢ºé…ç½®
26. çµ±è¨ˆã‚·ãƒ¼ãƒˆè¿½åŠ 
    â””â”€ ç·ã‚·ãƒ¼ãƒ³æ•°ã€OCRæ¤œå‡ºç‡ã€ãƒŠãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚«ãƒãƒ¼ç‡
    â””â”€ å‹•ç”»è§£åƒåº¦ã€ã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯”ã€é•·ã•
27. Excelãƒãƒƒãƒ•ã‚¡ç”Ÿæˆ
    â””â”€ workbook.xlsx.writeBuffer()
```

**ä½¿ç”¨ãƒ•ã‚¡ã‚¤ãƒ«**:
- `cloud-run-worker/src/services/excel-generator.ts` (generateExcel)

**Excelå½¢å¼è©³ç´°**:
- **ç”»åƒå¹…**: 320pxï¼ˆå›ºå®šï¼‰
- **ç”»åƒé«˜ã•**: å‹•ç”»ã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯”ã‹ã‚‰è‡ªå‹•è¨ˆç®—
- **è¡Œé«˜ã•**: ç”»åƒé«˜ã•ã«åˆã‚ã›ã¦å‹•çš„èª¿æ•´
- **ãƒ•ã‚©ãƒ³ãƒˆ**: Calibri 11pt
- **ãƒ˜ãƒƒãƒ€ãƒ¼è‰²**: #4A90E2ï¼ˆé’ï¼‰
- **äº¤äº’è¡Œè‰²**: #F5F5F5ï¼ˆã‚°ãƒ¬ãƒ¼ï¼‰

### ãƒ•ã‚§ãƒ¼ã‚º7: çµæœã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã¨ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°

```
28. æœ¬ç•ªç’°å¢ƒ: Vercel Blobã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
    â””â”€ uploadResultFile()
    â””â”€ result_${uploadId}.xlsx
    â””â”€ resultBlobUrlå–å¾—
29. é–‹ç™ºç’°å¢ƒ: /tmpã«ä¿å­˜
    â””â”€ resultFileMap.set(uploadId, filePath)
30. Supabaseã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
    â””â”€ completeStatus(uploadId, resultUrl, metadata)
    â””â”€ status='completed', progress=100
    â””â”€ metadata.blobUrl = resultBlobUrlï¼ˆæœ¬ç•ªï¼‰
31. ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«å‰Šé™¤
    â””â”€ ãƒ•ãƒ¬ãƒ¼ãƒ ç”»åƒï¼ˆ/tmp/frames-*ï¼‰
    â””â”€ éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆ/tmp/audio.mp3ï¼‰
    â””â”€ VADãƒãƒ£ãƒ³ã‚¯ï¼ˆ/tmp/vad-chunks/*ï¼‰
    â””â”€ å‹•ç”»ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆ/tmp/video-analyzer-*/ï¼‰
```

**ä½¿ç”¨ãƒ•ã‚¡ã‚¤ãƒ«**:
- `cloud-run-worker/src/services/blobUploader.ts` (uploadResultFile)
- `cloud-run-worker/src/services/statusManager.ts` (completeStatus)

### ãƒ•ã‚§ãƒ¼ã‚º8: ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ãƒãƒ¼ãƒªãƒ³ã‚°ã¨ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰

```
32. ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ãŒ10ç§’ã”ã¨ã«ãƒãƒ¼ãƒªãƒ³ã‚°ï¼ˆSupabaseè² è·è»½æ¸›ã®ãŸã‚5ç§’ã‹ã‚‰å¤‰æ›´ï¼‰
    â””â”€ useProcessingStatus(uploadId)
    â””â”€ GET /api/status/${uploadId}
33. /api/status ãŒCloud Run Workerã«è»¢é€
    â””â”€ GET /status/${uploadId}
    â””â”€ Supabaseã‹ã‚‰ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å–å¾—
34. status='completed' ã‚’æ¤œå‡º
    â””â”€ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³è¡¨ç¤º
35. ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã‚¯ãƒªãƒƒã‚¯
    â””â”€ GET /api/download/${uploadId}
36. æœ¬ç•ªç’°å¢ƒ: Supabaseã‹ã‚‰metadata.blobUrlå–å¾—
    â””â”€ Vercel Blobã‹ã‚‰å–å¾—
    â””â”€ Excelå‰Šé™¤ï¼ˆè‡ªå‹•ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ï¼‰
37. é–‹ç™ºç’°å¢ƒ: Cloud Run Workerã‹ã‚‰å–å¾—
    â””â”€ GET /result/${uploadId}
    â””â”€ /tmpã‹ã‚‰ç›´æ¥é…ä¿¡
```

**ä½¿ç”¨ãƒ•ã‚¡ã‚¤ãƒ«**:
- `app/hooks/useVideoProcessing.ts` (useProcessingStatus)
- `app/api/status/[uploadId]/route.ts` (GET handler)
- `app/api/download/[uploadId]/route.ts` (GET handler)
- `cloud-run-worker/src/index.ts` (GET /result/:uploadId)

---

## 5. ä¸»è¦ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ

### 5.1 ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰

#### `app/components/VideoUploader.tsx`
**å½¹å‰²**: å‹•ç”»ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰UIã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ

**ä¸»è¦æ©Ÿèƒ½**:
- ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—å¯¾å¿œ
- ãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼æ¤œè¨¼ï¼ˆvideo/*ï¼‰
- ã‚µã‚¤ã‚ºåˆ¶é™ï¼ˆ500MBï¼‰
- ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰é€²æ—è¡¨ç¤º
- ã‚¨ãƒ©ãƒ¼åˆ†é¡ãƒ»ãƒªãƒˆãƒ©ã‚¤æ©Ÿèƒ½
- ãƒ‡ãƒ¼ã‚¿åŒæ„ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹

**ä¸»è¦é–¢æ•°**:
- `handleUpload()`: ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å‡¦ç†ã®çµ±æ‹¬
- `handleFileSelect()`: ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠãƒ»æ¤œè¨¼
- `getErrorMessage()`: ã‚¨ãƒ©ãƒ¼åˆ†é¡ã¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ•ãƒ¬ãƒ³ãƒ‰ãƒªãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ç”Ÿæˆ

#### `app/components/ProcessingStatus.tsx`
**å½¹å‰²**: å‡¦ç†çŠ¶æ…‹è¡¨ç¤ºã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ

**è¡¨ç¤ºå†…å®¹**:
- å‡¦ç†ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ï¼ˆpending, downloading, processing, completed, errorï¼‰
- é€²æ—ãƒãƒ¼ï¼ˆ0-100%ï¼‰
- å‡¦ç†ã‚¹ãƒ†ãƒ¼ã‚¸ï¼ˆdownloading, metadata, audio, vad_whisper, scene_ocr_excel, upload_resultï¼‰
- ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
- ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³

#### `app/hooks/useVideoProcessing.ts`
**å½¹å‰²**: å‹•ç”»å‡¦ç†é–¢é€£ã®React Hook

**ä¸»è¦Hook**:
- `useVideoProcess()`: å‡¦ç†é–‹å§‹ãƒªã‚¯ã‚¨ã‚¹ãƒˆï¼ˆReact Query mutationï¼‰
- `useProcessingStatus()`: ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒãƒ¼ãƒªãƒ³ã‚°ï¼ˆReact Query, 10ç§’é–“éš” - Supabaseè² è·è»½æ¸›ã®ãŸã‚ï¼‰

**ç‰¹å¾´**:
- è‡ªå‹•ãƒªãƒˆãƒ©ã‚¤ï¼ˆæœ€å¤§3å›ï¼‰
- æŒ‡æ•°ãƒãƒƒã‚¯ã‚ªãƒ•ï¼ˆ1ç§’ â†’ 2ç§’ â†’ 4ç§’ï¼‰
- ã‚­ãƒ£ãƒƒã‚·ãƒ¥ç®¡ç†

### 5.2 APIãƒ«ãƒ¼ãƒˆ

#### `app/api/blob-upload/route.ts`
**ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ**: `POST /api/blob-upload`

**å½¹å‰²**: Vercel Blobã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãƒˆãƒ¼ã‚¯ãƒ³ç”Ÿæˆ

**å‡¦ç†ãƒ•ãƒ­ãƒ¼**:
1. Clerkèªè¨¼ç¢ºèªï¼ˆauth()ï¼‰
2. ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒœãƒ‡ã‚£è§£æ
3. ãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼æ¤œè¨¼ï¼ˆå‹•ç”»æ‹¡å¼µå­ï¼‰
4. Vercel Blob handleUpload()å‘¼ã³å‡ºã—
5. ãƒˆãƒ¼ã‚¯ãƒ³ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ç”Ÿæˆï¼ˆuserId, uploadedAt, fileNameï¼‰
6. ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å®Œäº†ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯

**ç’°å¢ƒå¤‰æ•°**:
- `BLOB_READ_WRITE_TOKEN`
- `CLERK_SECRET_KEY`

#### `app/api/process/route.ts`
**ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ**: `POST /api/process`

**å½¹å‰²**: Cloud Run Workerã¸ã®å‡¦ç†é–‹å§‹ãƒªã‚¯ã‚¨ã‚¹ãƒˆ

**å‡¦ç†ãƒ•ãƒ­ãƒ¼**:
1. Clerkèªè¨¼ç¢ºèª
2. ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒœãƒ‡ã‚£æ¤œè¨¼ï¼ˆuploadId, blobUrlå¿…é ˆï¼‰
3. Blob URLæ¤œè¨¼ï¼ˆvercel-storageå«ã‚€ï¼‰
4. Cloud Run Workerã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆè»¢é€
5. ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆå‡¦ç†ï¼ˆ25ç§’ï¼‰
6. ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°

**ç’°å¢ƒå¤‰æ•°**:
- `CLOUD_RUN_URL`
- `WORKER_SECRET`
- `NODE_ENV`ï¼ˆé–‹ç™º/æœ¬ç•ªåˆ‡æ›¿ï¼‰

**é‡è¦ãªä¿®æ­£ï¼ˆ2025-11-03ï¼‰**:
- `await fetch()` ã®è¿½åŠ ï¼ˆéåŒæœŸå‡¦ç†ç¢ºå®Ÿæ€§ï¼‰
- ã‚¨ãƒ©ãƒ¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹è©³ç´°åŒ–

#### `app/api/status/[uploadId]/route.ts`
**ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ**: `GET /api/status/:uploadId`

**å½¹å‰²**: å‡¦ç†ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å–å¾—ï¼ˆCloud Run Workerã‹ã‚‰ï¼‰

**å‡¦ç†ãƒ•ãƒ­ãƒ¼**:
1. Clerkèªè¨¼ç¢ºèª
2. Cloud Run Worker `/status/${uploadId}` ã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
3. ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆå‡¦ç†ï¼ˆ10ç§’ï¼‰
4. ã‚¨ãƒ©ãƒ¼æ™‚ã¯ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼ˆstatus='processing'ï¼‰

#### `app/api/download/[uploadId]/route.ts`
**ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ**: `GET /api/download/:uploadId`

**å½¹å‰²**: Excelçµæœãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰

**é–‹ç™ºãƒ¢ãƒ¼ãƒ‰**:
- Cloud Run Worker `/result/${uploadId}` ã‹ã‚‰ç›´æ¥å–å¾—
- ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ãƒ¬ã‚¹ãƒãƒ³ã‚¹

**æœ¬ç•ªãƒ¢ãƒ¼ãƒ‰**:
1. Supabaseã‹ã‚‰metadata.blobUrlå–å¾—
2. Vercel Blobã‹ã‚‰å–å¾—
3. Excelã‚¹ãƒˆãƒªãƒ¼ãƒ ã‚’ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã«è¿”å´
4. Blobè‡ªå‹•å‰Šé™¤ï¼ˆdel(blobUrl)ï¼‰

**ç’°å¢ƒå¤‰æ•°**:
- `NEXT_PUBLIC_SUPABASE_URL`
- `SUPABASE_SERVICE_ROLE_KEY`
- `NODE_ENV`

### 5.3 Cloud Run Worker

#### `cloud-run-worker/src/index.ts`
**å½¹å‰²**: Express.jsã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆ

**ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ**:
- `GET /health` - ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯
- `POST /process` - å‡¦ç†é–‹å§‹ï¼ˆvalidateAuthèªè¨¼ï¼‰
- `GET /status/:uploadId` - ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å–å¾—
- `GET /result/:uploadId` - çµæœãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ï¼ˆé–‹ç™ºãƒ¢ãƒ¼ãƒ‰ï¼‰

**èªè¨¼ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢**:
```typescript
const validateAuth = (req, res, next) => {
  const token = req.headers.authorization?.replace('Bearer ', '');
  if (token !== workerSecret) {
    return res.status(401).json({ error: 'Unauthorized' });
  }
  next();
};
```

**ç’°å¢ƒå¤‰æ•°æ¤œè¨¼**:
- `WORKER_SECRET`ï¼ˆå¿…é ˆï¼‰
- `GEMINI_API_KEY`ï¼ˆå¿…é ˆï¼‰
- `OPENAI_API_KEY`ï¼ˆå¿…é ˆï¼‰

#### `cloud-run-worker/src/services/videoProcessor.ts`
**å½¹å‰²**: å‹•ç”»å‡¦ç†ã®çµ±æ‹¬ç®¡ç†

**ä¸»è¦é–¢æ•°**: `processVideo(uploadId, blobUrl, fileName, dataConsent)`

**å‡¦ç†ã‚¹ãƒ†ãƒƒãƒ—**:
1. Supabaseã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹åˆæœŸåŒ–
2. å‹•ç”»ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
3. ã‚½ãƒ¼ã‚¹å‹•ç”»å‰Šé™¤ï¼ˆè‡ªå‹•ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ï¼‰
4. ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿æŠ½å‡º
5. éŸ³å£°æ¤œå‡ºã¨å‡¦ç†ï¼ˆVAD + Whisperï¼‰
6. ã‚·ãƒ¼ãƒ³æ¤œå‡ºã¨OCRï¼ˆexecuteIdealPipelineï¼‰
7. Excelç”Ÿæˆ
8. çµæœã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ï¼ˆæœ¬ç•ªï¼‰ã¾ãŸã¯ãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜ï¼ˆé–‹ç™ºï¼‰
9. Supabaseã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
10. ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«å‰Šé™¤

**ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°**:
- `safeUpdateStatus()`: é–‹ç™ºãƒ¢ãƒ¼ãƒ‰ã§ã¯éè‡´å‘½çš„ã‚¨ãƒ©ãƒ¼
- `try-finally`: ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ç¢ºå®Ÿå‰Šé™¤
- `failStatus()`: ã‚¨ãƒ©ãƒ¼æ™‚ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°

#### `cloud-run-worker/src/services/pipeline.ts`
**å½¹å‰²**: ç†æƒ³çš„ãªå‡¦ç†ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³å®Ÿè£…

**ä¸»è¦é–¢æ•°**: `executeIdealPipeline(videoPath, projectTitle, transcription)`

**å‡¦ç†ãƒ•ãƒ­ãƒ¼**:
1. å‹•ç”»ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿æŠ½å‡º
2. ã‚·ãƒ¼ãƒ³æ¤œå‡ºã¨ãƒ•ãƒ¬ãƒ¼ãƒ æŠ½å‡º
3. OCRå®Ÿè¡Œï¼ˆperformSceneBasedOCRï¼‰
4. æ°¸ç¶šã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ï¼ˆfilterPersistentOverlaysï¼‰
5. ãƒŠãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒãƒƒãƒ”ãƒ³ã‚°ï¼ˆmapTranscriptionToScenesï¼‰
6. Excelãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆå¤‰æ›
7. Excelç”Ÿæˆ
8. çµ±è¨ˆè¨ˆç®—
9. ãƒ•ãƒ¬ãƒ¼ãƒ å‰Šé™¤

**æ°¸ç¶šã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°**:
- é–¾å€¤: 50%ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã€è¨­å®šå¯èƒ½ï¼‰
- æœ€å°ã‚·ãƒ¼ãƒ³æ•°: 3ï¼ˆçµ±è¨ˆçš„ã«æœ‰æ„ãªãƒ‡ãƒ¼ã‚¿ï¼‰
- é™¤å»å¯¾è±¡: ãƒ­ã‚´ã€ã‚¦ã‚©ãƒ¼ã‚¿ãƒ¼ãƒãƒ¼ã‚¯ã€å¸¸æ™‚è¡¨ç¤ºUI

#### `cloud-run-worker/src/services/excel-generator.ts`
**å½¹å‰²**: Excelãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ

**ä¸»è¦é–¢æ•°**: `generateExcel(options)`

**ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆå®šç¾©**:
- åˆ—A: Scene #ï¼ˆ10æ–‡å­—å¹…ï¼‰
- åˆ—B: Timecodeï¼ˆ12æ–‡å­—å¹…ï¼‰
- åˆ—C: Screenshotï¼ˆå‹•çš„å¹…ã€ç”»åƒ320pxåŸºæº–ï¼‰
- åˆ—D: OCR Textï¼ˆ40æ–‡å­—å¹…ã€ãƒ†ã‚­ã‚¹ãƒˆæŠ˜ã‚Šè¿”ã—ï¼‰
- åˆ—E: NA Textï¼ˆ40æ–‡å­—å¹…ã€ãƒ†ã‚­ã‚¹ãƒˆæŠ˜ã‚Šè¿”ã—ï¼‰

**ç”»åƒåŸ‹ã‚è¾¼ã¿ãƒ­ã‚¸ãƒƒã‚¯**:
```typescript
// ç”»åƒã‚µã‚¤ã‚ºè¨ˆç®—ï¼ˆã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯”ä¿æŒï¼‰
const imageWidth = 320; // å›ºå®š
const imageHeight = Math.round(imageWidth / aspectRatio);

// Excelå˜ä½å¤‰æ›
const columnWidth = Math.ceil(imageWidth / 7); // 1æ–‡å­— â‰ˆ 7px
const rowHeight = Math.round(imageHeight * 0.75); // 1pt = 0.75px

// ã‚»ãƒ«ä¸­å¤®é…ç½®ï¼ˆEMUå˜ä½ï¼‰
const offsetX = (cellWidth - imageWidth) / 2 * 9525; // 9525 EMU/px
const offsetY = (cellHeight - imageHeight) / 2 * 9525;
```

**çµ±è¨ˆã‚·ãƒ¼ãƒˆ**:
- ç·ã‚·ãƒ¼ãƒ³æ•°
- OCRæ¤œå‡ºã‚·ãƒ¼ãƒ³æ•°
- ãƒŠãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ä»˜ãã‚·ãƒ¼ãƒ³æ•°
- OCRæ¤œå‡ºç‡ï¼ˆ%ï¼‰
- ãƒŠãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚«ãƒãƒ¼ç‡ï¼ˆ%ï¼‰
- å‹•ç”»è§£åƒåº¦ã€ã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯”ã€é•·ã•

#### `cloud-run-worker/src/services/audioWhisperPipeline.ts`
**å½¹å‰²**: VAD + Whisperçµ±åˆãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³

**ä¸»è¦é–¢æ•°**: `processAudioWithVADAndWhisper(audioPath, uploadId)`

**å‡¦ç†ãƒ•ãƒ­ãƒ¼**:
1. VADå‡¦ç†ï¼ˆéŸ³å£°æ´»å‹•æ¤œå‡ºï¼‰
2. éŸ³å£°ãƒãƒ£ãƒ³ã‚¯æŠ½å‡ºï¼ˆ10ç§’å˜ä½ï¼‰
3. Whisper APIå‘¼ã³å‡ºã—ï¼ˆãƒãƒ£ãƒ³ã‚¯ã”ã¨ï¼‰
4. ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—èª¿æ•´ï¼ˆãƒãƒ£ãƒ³ã‚¯ã‚ªãƒ•ã‚»ãƒƒãƒˆè¿½åŠ ï¼‰
5. VADçµ±è¨ˆè¨ˆç®—

**VADã‚ªãƒ—ã‚·ãƒ§ãƒ³**:
- `maxChunkDuration`: 10ç§’ï¼ˆWhisperæœ€é©åŒ–ï¼‰
- `minSpeechDuration`: 0.25ç§’ï¼ˆçŸ­ã™ãã‚‹ã‚»ã‚°ãƒ¡ãƒ³ãƒˆé™¤å¤–ï¼‰
- `sensitivity`: 0.5ï¼ˆãƒãƒ©ãƒ³ã‚¹å‹ï¼‰

**Whisperè¨­å®š**:
- ãƒ¢ãƒ‡ãƒ«: `whisper-1`
- è¨€èª: `ja`ï¼ˆæ—¥æœ¬èªï¼‰
- ãƒ¬ã‚¹ãƒãƒ³ã‚¹å½¢å¼: `verbose_json`ï¼ˆã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ä»˜ãï¼‰
- æ¸©åº¦: 0ï¼ˆç¢ºå®šçš„å‡ºåŠ›ï¼‰

**ãƒªãƒˆãƒ©ã‚¤æ©Ÿæ§‹**:
- æœ€å¤§3å›
- æŒ‡æ•°ãƒãƒƒã‚¯ã‚ªãƒ•ï¼ˆ1ç§’ â†’ 2ç§’ â†’ 4ç§’ï¼‰
- è‡´å‘½çš„ã‚¨ãƒ©ãƒ¼ï¼ˆAPI keyç„¡åŠ¹ãªã©ï¼‰ã¯å³åº§ã«ä¸­æ–­

#### `cloud-run-worker/src/services/statusManager.ts`
**å½¹å‰²**: ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç®¡ç†ï¼ˆSupabase / in-memoryï¼‰

**ãƒ‡ãƒ¥ã‚¢ãƒ«ãƒ¢ãƒ¼ãƒ‰**:
- æœ¬ç•ª: `USE_SUPABASE=true` ã¾ãŸã¯ `NODE_ENV=production`
- é–‹ç™º: in-memory Map

**ä¸»è¦é–¢æ•°**:
- `initStatus(uploadId)`: åˆæœŸåŒ–
- `updateStatus(uploadId, updates)`: æ›´æ–°
- `getStatus(uploadId)`: å–å¾—
- `completeStatus(uploadId, resultUrl, metadata)`: å®Œäº†
- `failStatus(uploadId, error)`: å¤±æ•—

**ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°**:
- PGRST205: ã‚¹ã‚­ãƒ¼ãƒã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¨ãƒ©ãƒ¼ï¼ˆãƒªãƒ­ãƒ¼ãƒ‰æŒ‡ç¤ºï¼‰
- PGRST116: ãƒ¬ã‚³ãƒ¼ãƒ‰æœªç™ºè¦‹ï¼ˆæƒ³å®šå†…ï¼‰
- 42501: RLSæ¨©é™ã‚¨ãƒ©ãƒ¼ï¼ˆservice_roleå¿…è¦ï¼‰

#### `cloud-run-worker/src/services/ffmpeg.ts`
**å½¹å‰²**: FFmpegãƒ©ãƒƒãƒ‘ãƒ¼ï¼ˆã‚·ãƒ¼ãƒ³æ¤œå‡ºã€ãƒ•ãƒ¬ãƒ¼ãƒ æŠ½å‡ºï¼‰

**ä¸»è¦é–¢æ•°**:
- `detectSceneCuts(videoPath, config)`: ãƒãƒ«ãƒãƒ‘ã‚¹ã‚·ãƒ¼ãƒ³æ¤œå‡º
- `generateSceneRanges(cuts, duration, config)`: ã‚·ãƒ¼ãƒ³ç¯„å›²ç”Ÿæˆ
- `extractFrameAtTime(videoPath, timestamp, outputPath)`: ãƒ•ãƒ¬ãƒ¼ãƒ æŠ½å‡º
- `getVideoMetadata(videoPath)`: ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿å–å¾—
- `extractScenesWithFrames(videoPath, outputDir)`: çµ±åˆå‡¦ç†

**ãƒãƒ«ãƒãƒ‘ã‚¹ã‚·ãƒ¼ãƒ³æ¤œå‡º**:
```typescript
// 3ã¤ã®é–¾å€¤ã§æ¤œå‡º
const thresholds = [0.03, 0.05, 0.10];

for (const threshold of thresholds) {
  const cuts = await runSceneDetection(videoPath, threshold);
  // æœ€å¤§ä¿¡é ¼åº¦ã§ãƒãƒ¼ã‚¸
  allCuts.set(timestamp, Math.max(existingConfidence, confidence));
}
```

**ãƒ•ãƒ¬ãƒ¼ãƒ æŠ½å‡ºä»•æ§˜**:
- è§£åƒåº¦: 1280x720ï¼ˆOCRæœ€é©åŒ–ï¼‰
- å½¢å¼: PNGï¼ˆãƒ­ã‚¹ãƒ¬ã‚¹ï¼‰
- ã‚¿ã‚¤ãƒŸãƒ³ã‚°: ã‚·ãƒ¼ãƒ³ã®ä¸­é–“ç‚¹ï¼ˆ50%ï¼‰

---

## 6. ç’°å¢ƒå¤‰æ•°

### 6.1 ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ï¼ˆVercelï¼‰

| å¤‰æ•°å | å¿…é ˆ | ç”¨é€” | ä¾‹ |
|-------|------|------|---|
| `NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY` | âœ… | Clerkå…¬é–‹éµ | `pk_test_...` |
| `CLERK_SECRET_KEY` | âœ… | Clerkã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚­ãƒ¼ | `sk_test_...` |
| `BLOB_READ_WRITE_TOKEN` | âœ… | Vercel Blobãƒˆãƒ¼ã‚¯ãƒ³ | `vercel_blob_rw_...` |
| `CLOUD_RUN_URL` | âœ… | Cloud Run Worker URL | `https://video-analyzer-worker-...` |
| `WORKER_SECRET` | âœ… | Workerèªè¨¼ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆ | `4MeGFIt36xoh1G...` |
| `NEXT_PUBLIC_SUPABASE_URL` | âœ… | Supabase URL | `https://gcwdkjyyhmqtrxvmvnvn.supabase.co` |
| `SUPABASE_SERVICE_ROLE_KEY` | âœ… | Supabaseã‚µãƒ¼ãƒ“ã‚¹ãƒ­ãƒ¼ãƒ«ã‚­ãƒ¼ | `eyJhbGci...` |
| `NODE_ENV` | âœ… | ç’°å¢ƒãƒ¢ãƒ¼ãƒ‰ | `production` / `development` |

**è¨­å®šæ–¹æ³•**:
1. Vercel Dashboard â†’ Project â†’ Settings â†’ Environment Variables
2. å„å¤‰æ•°ã‚’è¿½åŠ ï¼ˆProductionç’°å¢ƒï¼‰
3. å†ãƒ‡ãƒ—ãƒ­ã‚¤

**é‡è¦ãªä¿®æ­£ï¼ˆ2025-11-03ï¼‰**:
- `CLOUD_RUN_URL`: æ”¹è¡Œæ–‡å­—é™¤å»ç¢ºèª
- `WORKER_SECRET`: æ­£ã—ã„å€¤è¨­å®šç¢ºèª

### 6.2 ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ï¼ˆCloud Runï¼‰

| å¤‰æ•°å | å¿…é ˆ | ç”¨é€” | ä¾‹ |
|-------|------|------|---|
| `BLOB_READ_WRITE_TOKEN` | âœ… | Vercel Blobãƒˆãƒ¼ã‚¯ãƒ³ | `vercel_blob_rw_...` |
| `SUPABASE_URL` | âœ… | Supabase URL | `https://gcwdkjyyhmqtrxvmvnvn.supabase.co` |
| `SUPABASE_SERVICE_ROLE_KEY` | âœ… | Supabaseã‚µãƒ¼ãƒ“ã‚¹ãƒ­ãƒ¼ãƒ«ã‚­ãƒ¼ | `eyJhbGci...` |
| `OPENAI_API_KEY` | âœ… | OpenAI APIã‚­ãƒ¼ | `sk-svcacct-...` |
| `GEMINI_API_KEY` | âœ… | Gemini APIã‚­ãƒ¼ | `AIza...` |
| `WORKER_SECRET` | âœ… | Workerèªè¨¼ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆ | `4MeGFIt36xoh1G...` |
| `NODE_ENV` | âœ… | ç’°å¢ƒãƒ¢ãƒ¼ãƒ‰ | `production` |
| `PORT` | âŒ | ãƒãƒ¼ãƒˆç•ªå·ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 8080ï¼‰ | `8080` |

**è¨­å®šæ–¹æ³•**:
```bash
gcloud run services update video-analyzer-worker \
  --region us-central1 \
  --update-env-vars \
"BLOB_READ_WRITE_TOKEN=${BLOB_READ_WRITE_TOKEN},\
SUPABASE_URL=${SUPABASE_URL},\
SUPABASE_SERVICE_ROLE_KEY=${SUPABASE_SERVICE_ROLE_KEY},\
OPENAI_API_KEY=${OPENAI_API_KEY},\
GEMINI_API_KEY=${GEMINI_API_KEY},\
WORKER_SECRET=${WORKER_SECRET},\
NODE_ENV=production"
```

**Secret Managerï¼ˆæ¨å¥¨ï¼‰**:
```bash
# ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆä½œæˆ
gcloud secrets create openai-api-key \
  --data-file=- <<< "${OPENAI_API_KEY}"

# Cloud Runã‹ã‚‰å‚ç…§
gcloud run services update video-analyzer-worker \
  --update-secrets OPENAI_API_KEY=openai-api-key:latest
```

**é‡è¦ãªä¿®æ­£ï¼ˆ2025-11-02ï¼‰**:
- `GEMINI_API_KEY`è¿½åŠ ï¼ˆä»¥å‰ã¯æœªè¨­å®šï¼‰

---

## 7. API ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆä»•æ§˜

### 7.1 ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ API Routes

#### `POST /api/blob-upload`
**èª¬æ˜**: Vercel Blobã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãƒˆãƒ¼ã‚¯ãƒ³ç”Ÿæˆ

**ãƒªã‚¯ã‚¨ã‚¹ãƒˆ**:
```json
{
  "type": "blob-upload",
  "filename": "video.mp4"
}
```

**ãƒ¬ã‚¹ãƒãƒ³ã‚¹ï¼ˆæˆåŠŸï¼‰**:
```json
{
  "url": "https://xxxx.public.blob.vercel-storage.com/video-xxx.mp4",
  "pathname": "video-xxx.mp4",
  "contentType": "video/mp4",
  "contentDisposition": "inline; filename=\"video.mp4\""
}
```

**ãƒ¬ã‚¹ãƒãƒ³ã‚¹ï¼ˆã‚¨ãƒ©ãƒ¼ï¼‰**:
```json
{
  "error": "Unauthorized",
  "message": "You must be logged in"
}
```

**ã‚¨ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰**:
- `401`: èªè¨¼å¤±æ•—
- `400`: ä¸æ­£ãªãƒªã‚¯ã‚¨ã‚¹ãƒˆï¼ˆãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼ä¸æ­£ãªã©ï¼‰
- `500`: ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼ï¼ˆãƒˆãƒ¼ã‚¯ãƒ³ç”Ÿæˆå¤±æ•—ãªã©ï¼‰

#### `POST /api/process`
**èª¬æ˜**: å‹•ç”»å‡¦ç†é–‹å§‹

**ãƒªã‚¯ã‚¨ã‚¹ãƒˆ**:
```json
{
  "uploadId": "upload_1730678901234_abc123xyz",
  "blobUrl": "https://xxxx.public.blob.vercel-storage.com/video-xxx.mp4",
  "fileName": "video.mp4",
  "dataConsent": true
}
```

**ãƒ¬ã‚¹ãƒãƒ³ã‚¹ï¼ˆæˆåŠŸï¼‰**:
```json
{
  "success": true,
  "uploadId": "upload_1730678901234_abc123xyz",
  "message": "Video processing started successfully",
  "status": "processing"
}
```

**ãƒ¬ã‚¹ãƒãƒ³ã‚¹ï¼ˆã‚¨ãƒ©ãƒ¼ï¼‰**:
```json
{
  "error": "Processing failed to start",
  "message": "Worker service returned error: 502",
  "details": "Connection timeout"
}
```

**ã‚¨ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰**:
- `401`: èªè¨¼å¤±æ•—
- `400`: ä¸æ­£ãªãƒªã‚¯ã‚¨ã‚¹ãƒˆï¼ˆå¿…é ˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰æ¬ è½ã€Blob URLä¸æ­£ãªã©ï¼‰
- `500`: ã‚µãƒ¼ãƒãƒ¼è¨­å®šã‚¨ãƒ©ãƒ¼
- `502`: Workeré€šä¿¡ã‚¨ãƒ©ãƒ¼

#### `GET /api/status/:uploadId`
**èª¬æ˜**: å‡¦ç†ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å–å¾—

**ãƒ¬ã‚¹ãƒãƒ³ã‚¹ï¼ˆå‡¦ç†ä¸­ï¼‰**:
```json
{
  "uploadId": "upload_1730678901234_abc123xyz",
  "status": "processing",
  "progress": 60,
  "stage": "scene_ocr_excel",
  "startedAt": "2025-11-04T10:30:00.000Z",
  "updatedAt": "2025-11-04T10:35:00.000Z"
}
```

**ãƒ¬ã‚¹ãƒãƒ³ã‚¹ï¼ˆå®Œäº†ï¼‰**:
```json
{
  "uploadId": "upload_1730678901234_abc123xyz",
  "status": "completed",
  "progress": 100,
  "stage": "completed",
  "resultUrl": "upload_1730678901234_abc123xyz",
  "metadata": {
    "duration": 120,
    "segmentCount": 15,
    "ocrResultCount": 8,
    "transcriptionLength": 1234,
    "totalScenes": 10,
    "scenesWithOCR": 8,
    "scenesWithNarration": 7,
    "blobUrl": "https://xxxx.public.blob.vercel-storage.com/result-xxx.xlsx"
  },
  "startedAt": "2025-11-04T10:30:00.000Z",
  "updatedAt": "2025-11-04T10:40:00.000Z"
}
```

**ãƒ¬ã‚¹ãƒãƒ³ã‚¹ï¼ˆã‚¨ãƒ©ãƒ¼ï¼‰**:
```json
{
  "uploadId": "upload_1730678901234_abc123xyz",
  "status": "error",
  "progress": 0,
  "error": "Whisper API failed: Rate limit exceeded",
  "startedAt": "2025-11-04T10:30:00.000Z",
  "updatedAt": "2025-11-04T10:32:00.000Z"
}
```

**ã‚¨ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰**:
- `401`: èªè¨¼å¤±æ•—
- `404`: Upload IDæœªç™ºè¦‹
- `500`: ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼

**ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç¨®åˆ¥**:
- `pending`: åˆæœŸåŒ–ä¸­
- `downloading`: å‹•ç”»ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ä¸­
- `processing`: å‡¦ç†å®Ÿè¡Œä¸­
- `completed`: å®Œäº†
- `error`: ã‚¨ãƒ©ãƒ¼

**ã‚¹ãƒ†ãƒ¼ã‚¸ç¨®åˆ¥**:
- `downloading`: å‹•ç”»ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
- `metadata`: ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿æŠ½å‡º
- `audio`: éŸ³å£°æ¤œå‡º
- `vad_whisper`: VAD + Whisperå‡¦ç†
- `scene_ocr_excel`: ã‚·ãƒ¼ãƒ³æ¤œå‡º + OCR + Excelç”Ÿæˆ
- `upload_result`: çµæœã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
- `completed`: å®Œäº†

#### `GET /api/download/:uploadId`
**èª¬æ˜**: Excelçµæœãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰

**ãƒ¬ã‚¹ãƒãƒ³ã‚¹**:
- Content-Type: `application/vnd.openxmlformats-officedocument.spreadsheetml.sheet`
- Content-Disposition: `attachment; filename="result_{uploadId}.xlsx"`
- ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ãƒ¬ã‚¹ãƒãƒ³ã‚¹ï¼ˆãƒã‚¤ãƒŠãƒªãƒ‡ãƒ¼ã‚¿ï¼‰

**ã‚¨ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰**:
- `401`: èªè¨¼å¤±æ•—
- `404`: çµæœãƒ•ã‚¡ã‚¤ãƒ«æœªç™ºè¦‹
- `500`: ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å¤±æ•—

**å‰¯ä½œç”¨**:
- æœ¬ç•ªç’°å¢ƒ: Excel Blobè‡ªå‹•å‰Šé™¤ï¼ˆãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å¾Œï¼‰

### 7.2 Cloud Run Worker Endpoints

#### `POST /process`
**èª¬æ˜**: å‡¦ç†é–‹å§‹ãƒªã‚¯ã‚¨ã‚¹ãƒˆï¼ˆå†…éƒ¨APIï¼‰

**èªè¨¼**: `Authorization: Bearer ${WORKER_SECRET}`

**ãƒªã‚¯ã‚¨ã‚¹ãƒˆ**:
```json
{
  "uploadId": "upload_1730678901234_abc123xyz",
  "blobUrl": "https://xxxx.public.blob.vercel-storage.com/video-xxx.mp4",
  "fileName": "video.mp4",
  "dataConsent": true
}
```

**ãƒ¬ã‚¹ãƒãƒ³ã‚¹**:
```json
{
  "success": true,
  "uploadId": "upload_1730678901234_abc123xyz",
  "message": "Video processing started",
  "status": "processing"
}
```

**ã‚¨ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰**:
- `401`: èªè¨¼å¤±æ•—
- `400`: ä¸æ­£ãªãƒªã‚¯ã‚¨ã‚¹ãƒˆ
- `500`: ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼

#### `GET /status/:uploadId`
**èª¬æ˜**: ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å–å¾—ï¼ˆå†…éƒ¨APIï¼‰

**èªè¨¼**: `Authorization: Bearer ${WORKER_SECRET}`

**ãƒ¬ã‚¹ãƒãƒ³ã‚¹**: ä¸Šè¨˜ `/api/status/:uploadId` ã¨åŒã˜

#### `GET /result/:uploadId`
**èª¬æ˜**: çµæœãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ï¼ˆé–‹ç™ºãƒ¢ãƒ¼ãƒ‰ï¼‰

**èªè¨¼**: `Authorization: Bearer ${WORKER_SECRET}`

**ãƒ¬ã‚¹ãƒãƒ³ã‚¹**: Excelãƒ•ã‚¡ã‚¤ãƒ«ã‚¹ãƒˆãƒªãƒ¼ãƒ 

#### `GET /health`
**èª¬æ˜**: ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯

**èªè¨¼**: ä¸è¦

**ãƒ¬ã‚¹ãƒãƒ³ã‚¹**:
```json
{
  "status": "ok",
  "timestamp": "2025-11-04T10:30:00.000Z"
}
```

---

## 8. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¹ã‚­ãƒ¼ãƒ

### Supabase: `processing_status` ãƒ†ãƒ¼ãƒ–ãƒ«

```sql
CREATE TABLE processing_status (
  upload_id TEXT PRIMARY KEY,
  status TEXT NOT NULL CHECK (status IN ('pending', 'downloading', 'processing', 'completed', 'error')),
  progress INTEGER NOT NULL DEFAULT 0 CHECK (progress >= 0 AND progress <= 100),
  stage TEXT,
  started_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  result_url TEXT,
  metadata JSONB,
  error TEXT
);

-- Indexes
CREATE INDEX idx_processing_status_status ON processing_status(status);
CREATE INDEX idx_processing_status_started_at ON processing_status(started_at DESC);
CREATE INDEX idx_processing_status_updated_at ON processing_status(updated_at DESC);

-- Comments
COMMENT ON TABLE processing_status IS 'å‹•ç”»å‡¦ç†ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç®¡ç†';
COMMENT ON COLUMN processing_status.upload_id IS 'ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰IDï¼ˆupload_{timestamp}_{random}ï¼‰';
COMMENT ON COLUMN processing_status.status IS 'å‡¦ç†ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ï¼ˆpending, downloading, processing, completed, errorï¼‰';
COMMENT ON COLUMN processing_status.progress IS 'é€²æ—ç‡ï¼ˆ0-100ï¼‰';
COMMENT ON COLUMN processing_status.stage IS 'å‡¦ç†ã‚¹ãƒ†ãƒ¼ã‚¸ï¼ˆdownloading, metadata, audio, vad_whisper, scene_ocr_excel, upload_result, completedï¼‰';
COMMENT ON COLUMN processing_status.result_url IS 'çµæœURLï¼ˆuploadId ã¾ãŸã¯ Blob URLï¼‰';
COMMENT ON COLUMN processing_status.metadata IS 'ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿JSONï¼ˆduration, segmentCount, ocrResultCount, blobUrlç­‰ï¼‰';
COMMENT ON COLUMN processing_status.error IS 'ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸';
```

### metadata JSONBæ§‹é€ 

```json
{
  "duration": 120,
  "segmentCount": 15,
  "ocrResultCount": 8,
  "transcriptionLength": 1234,
  "totalScenes": 10,
  "scenesWithOCR": 8,
  "scenesWithNarration": 7,
  "blobUrl": "https://xxxx.public.blob.vercel-storage.com/result-xxx.xlsx"
}
```

**ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰èª¬æ˜**:
- `duration`: å‹•ç”»é•·ï¼ˆç§’ï¼‰
- `segmentCount`: Whisperã‚»ã‚°ãƒ¡ãƒ³ãƒˆæ•°
- `ocrResultCount`: OCRæ¤œå‡ºã‚·ãƒ¼ãƒ³æ•°
- `transcriptionLength`: æ–‡å­—èµ·ã“ã—ç·æ–‡å­—æ•°
- `totalScenes`: ç·ã‚·ãƒ¼ãƒ³æ•°
- `scenesWithOCR`: OCRãƒ†ã‚­ã‚¹ãƒˆä»˜ãã‚·ãƒ¼ãƒ³æ•°
- `scenesWithNarration`: ãƒŠãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ä»˜ãã‚·ãƒ¼ãƒ³æ•°
- `blobUrl`: Vercel Blob URLï¼ˆæœ¬ç•ªç’°å¢ƒã®ã¿ã€ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ç”¨ï¼‰

---

## 9. å‡¦ç†ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³è©³ç´°

### 9.1 ã‚·ãƒ¼ãƒ³æ¤œå‡ºã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ 

**æ‰‹æ³•**: ãƒãƒ«ãƒãƒ‘ã‚¹FFmpegã‚·ãƒ¼ãƒ³æ¤œå‡º

**é–¾å€¤**: `[0.03, 0.05, 0.10]`

**ãƒ­ã‚¸ãƒƒã‚¯**:
1. ä½é–¾å€¤ï¼ˆ0.03ï¼‰: å¾®ç´°ãªå¤‰åŒ–ã‚‚æ¤œå‡º
2. ä¸­é–¾å€¤ï¼ˆ0.05ï¼‰: ãƒãƒ©ãƒ³ã‚¹å‹
3. é«˜é–¾å€¤ï¼ˆ0.10ï¼‰: æ˜ç¢ºãªå¤‰åŒ–ã®ã¿

**çµ±åˆæ–¹æ³•**:
```typescript
// 3å›ã®æ¤œå‡ºçµæœã‚’ãƒãƒ¼ã‚¸
allCuts.set(timestamp, Math.max(existingConfidence, cut.confidence));
```

**ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°**:
- æœ€å°ã‚·ãƒ¼ãƒ³é•·: 0.5ç§’
- çŸ­ã™ãã‚‹ã‚·ãƒ¼ãƒ³ã‚’ã‚¹ã‚­ãƒƒãƒ—

**ä¸­é–“ç‚¹æŠ½å‡º**:
```typescript
const midTime = (startTime + endTime) / 2;
```

### 9.2 OCRå‡¦ç†è©³ç´°

**ãƒ¢ãƒ‡ãƒ«**: Gemini 2.5 Flash

**ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ**:
```
Analyze this video frame and extract ALL visible text.

Please provide a JSON response with this structure:
{
  "text": "all extracted text concatenated",
  "confidence": 0.95
}

Focus on:
- Japanese text (kanji, hiragana, katakana)
- English text
- Numbers and symbols
- Screen overlays, titles, captions

Return empty string if no text detected.
```

**ãƒ¬ã‚¹ãƒãƒ³ã‚¹å‡¦ç†**:
```typescript
// Markdownã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯é™¤å»
const jsonText = responseText.replace(/```json\n?|\n?```/g, '').trim();
const ocrResult = JSON.parse(jsonText);
```

**ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°**:
- JSONãƒ‘ãƒ¼ã‚¹ã‚¨ãƒ©ãƒ¼: ç”Ÿãƒ†ã‚­ã‚¹ãƒˆã‚’ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
- API ã‚¨ãƒ©ãƒ¼: ç©ºæ–‡å­—åˆ—ã§ç¶™ç¶šï¼ˆä»–ã®ã‚·ãƒ¼ãƒ³ã«å½±éŸ¿ã•ã›ãªã„ï¼‰

### 9.3 æ°¸ç¶šã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°

**ç›®çš„**: ãƒ­ã‚´ã€ã‚¦ã‚©ãƒ¼ã‚¿ãƒ¼ãƒãƒ¼ã‚¯ã€å¸¸æ™‚è¡¨ç¤ºUIè¦ç´ ã®é™¤å»

**ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ **:
1. å…¨ã‚·ãƒ¼ãƒ³ã®OCRãƒ†ã‚­ã‚¹ãƒˆã‚’è¡Œå˜ä½ã§åˆ†å‰²
2. å„ãƒ¦ãƒ‹ãƒ¼ã‚¯ãªè¡ŒãŒå‡ºç¾ã™ã‚‹ã‚·ãƒ¼ãƒ³æ•°ã‚’ã‚«ã‚¦ãƒ³ãƒˆ
3. é–¾å€¤ï¼ˆ50%ï¼‰ä»¥ä¸Šã®ã‚·ãƒ¼ãƒ³ã«å‡ºç¾ã™ã‚‹è¡Œã‚’ã€Œæ°¸ç¶šã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã€ã¨åˆ¤å®š
4. å…¨ã‚·ãƒ¼ãƒ³ã‹ã‚‰æ°¸ç¶šã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤è¡Œã‚’é™¤å»

**è¨­å®šå¯èƒ½ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿**:
- `threshold`: 0.5ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã€50%ä»¥ä¸Šã§æ°¸ç¶šã¨åˆ¤å®šï¼‰
- `minScenes`: 3ï¼ˆæœ€å°ã‚·ãƒ¼ãƒ³æ•°ã€çµ±è¨ˆçš„æœ‰æ„æ€§ç¢ºä¿ï¼‰

**ã‚³ãƒ¼ãƒ‰ä¾‹**:
```typescript
// ã‚·ãƒ¼ãƒ³æ•°ãŒå°‘ãªã„å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—
if (scenesWithOCR.length < minScenes) {
  console.log(`Only ${scenesWithOCR.length} scenes. Skipping filter.`);
  return scenesWithOCR;
}

// æ°¸ç¶šè¡Œæ¤œå‡º
const persistentThreshold = totalScenes * threshold;
for (const [line, count] of lineFrequency.entries()) {
  if (count >= persistentThreshold) {
    persistentLines.add(line);
  }
}
```

**ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°**:
- å…¨ãƒ¦ãƒ‹ãƒ¼ã‚¯è¡Œæ•°
- ä¸Šä½10ä»¶ã®é »å‡ºè¡Œ
- æ°¸ç¶šã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã¨ã—ã¦é™¤å»ã•ã‚ŒãŸè¡Œ

### 9.4 VADï¼ˆéŸ³å£°æ´»å‹•æ¤œå‡ºï¼‰

**ãƒ©ã‚¤ãƒ–ãƒ©ãƒª**: silero-vad-nodeï¼ˆSilero VADï¼‰

**ç›®çš„**: Whisper API ã‚³ã‚¹ãƒˆå‰Šæ¸›ï¼ˆ40-60%ï¼‰

**ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿**:
- `maxChunkDuration`: 10ç§’ï¼ˆWhisperæœ€é©ãƒãƒ£ãƒ³ã‚¯é•·ï¼‰
- `minSpeechDuration`: 0.25ç§’ï¼ˆçŸ­ã™ãã‚‹ã‚»ã‚°ãƒ¡ãƒ³ãƒˆé™¤å¤–ï¼‰
- `sensitivity`: 0.5ï¼ˆãƒãƒ©ãƒ³ã‚¹å‹ï¼‰

**å‡¦ç†ãƒ•ãƒ­ãƒ¼**:
1. éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«å…¨ä½“ã‚’VADåˆ†æ
2. éŸ³å£°ã‚»ã‚°ãƒ¡ãƒ³ãƒˆæ¤œå‡ºï¼ˆé–‹å§‹ãƒ»çµ‚äº†ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ï¼‰
3. 10ç§’ãƒãƒ£ãƒ³ã‚¯ã«åˆ†å‰²
4. å„ãƒãƒ£ãƒ³ã‚¯ã‚’å€‹åˆ¥ãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦æŠ½å‡º

**çµ±è¨ˆå‡ºåŠ›**:
```typescript
{
  totalDuration: 120.5,       // ç·éŸ³å£°é•·
  voiceDuration: 68.3,        // éŸ³å£°éƒ¨åˆ†ã®ã¿
  voiceRatio: 0.567,          // éŸ³å£°æ¯”ç‡ï¼ˆ56.7%ï¼‰
  estimatedSavings: 43.3,     // ã‚³ã‚¹ãƒˆå‰Šæ¸›ç‡ï¼ˆ43.3%ï¼‰
  chunksProcessed: 7          // å‡¦ç†ãƒãƒ£ãƒ³ã‚¯æ•°
}
```

### 9.5 Whisper APIæœ€é©åŒ–

**ãƒãƒ£ãƒ³ã‚¯å‡¦ç†**:
- 10ç§’å˜ä½ã®ãƒãƒ£ãƒ³ã‚¯ã§å‡¦ç†
- å„ãƒãƒ£ãƒ³ã‚¯ç‹¬ç«‹ã—ã¦ä¸¦åˆ—åŒ–å¯èƒ½ï¼ˆå°†æ¥ã®æ‹¡å¼µï¼‰

**ãƒªãƒˆãƒ©ã‚¤ãƒ­ã‚¸ãƒƒã‚¯**:
```typescript
for (let attempt = 1; attempt <= maxRetries; attempt++) {
  try {
    // APIå‘¼ã³å‡ºã—
    return segments;
  } catch (error) {
    // è‡´å‘½çš„ã‚¨ãƒ©ãƒ¼ï¼ˆAPI keyç„¡åŠ¹ãªã©ï¼‰ã¯å³åº§ã«ä¸­æ–­
    if (errorMessage.includes('API key') || errorMessage.includes('Invalid')) {
      return [];
    }

    // ä¸€æ™‚çš„ã‚¨ãƒ©ãƒ¼ã¯æŒ‡æ•°ãƒãƒƒã‚¯ã‚ªãƒ•ã§ãƒªãƒˆãƒ©ã‚¤
    const delay = baseDelay * Math.pow(2, attempt - 1); // 1s, 2s, 4s
    await new Promise(resolve => setTimeout(resolve, delay));
  }
}
```

**ã‚³ã‚¹ãƒˆè¨ˆç®—**:
```typescript
const estimatedCost = (totalAudioProcessed / 60) * 0.006; // $0.006/åˆ†
```

---

## 10. ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°

### 10.1 ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã‚¨ãƒ©ãƒ¼åˆ†é¡

**`VideoUploader.tsx`ã®ã‚¨ãƒ©ãƒ¼åˆ†é¡é–¢æ•°**:

| ã‚¨ãƒ©ãƒ¼ç¨®åˆ¥ | æ¤œå‡ºã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ | ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ | ãƒªãƒˆãƒ©ã‚¤å¯ |
|-----------|--------------|-----------|-----------|
| ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ | network, fetch, connection | Network connection lost. Please check your internet and try again. | âœ… |
| ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ | timeout, timed out | Upload took too long. Your internet may be slow. Try again with a smaller file. | âœ… |
| èªè¨¼ | unauthorized, 401 | Authentication failed. Please sign in again. | âŒ |
| ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚º | size, too large, 413 | File is too large. Maximum: 500MB. Your file: XXmb | âŒ |
| å‡¦ç†é–‹å§‹å¤±æ•— | processing, process | Failed to start video processing. The server may be busy. Try again in a moment. | âœ… |
| Blob | blob, upload | Failed to upload video to storage. Please check your connection and try again. | âœ… |

### 10.2 ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°

#### ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆå‡¦ç†

**ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ â†’ API Routes**:
```typescript
// /api/process
signal: AbortSignal.timeout(25000) // 25ç§’
```

**API Routes â†’ Cloud Run Worker**:
```typescript
// /api/process
signal: AbortSignal.timeout(25000) // 25ç§’

// /api/status/:uploadId
signal: AbortSignal.timeout(10000) // 10ç§’

// /api/download/:uploadId
signal: AbortSignal.timeout(30000) // 30ç§’
```

#### Whisper APIãƒªãƒˆãƒ©ã‚¤

**å®Ÿè£…**: `cloud-run-worker/src/services/audioWhisperPipeline.ts`

```typescript
const maxRetries = 3;
const baseDelay = 1000; // 1ç§’

// æŒ‡æ•°ãƒãƒƒã‚¯ã‚ªãƒ•
const delay = baseDelay * Math.pow(2, attempt - 1);
// attempt 1: 1ç§’
// attempt 2: 2ç§’
// attempt 3: 4ç§’
```

**ä¸­æ–­æ¡ä»¶**:
- API keyç„¡åŠ¹
- ãƒ•ã‚¡ã‚¤ãƒ«æœªç™ºè¦‹
- Invalid request

#### ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°ã‚¨ãƒ©ãƒ¼

**é–‹ç™ºãƒ¢ãƒ¼ãƒ‰**: éè‡´å‘½çš„ã‚¨ãƒ©ãƒ¼ï¼ˆãƒ­ã‚°å‡ºåŠ›ã®ã¿ï¼‰

```typescript
async function safeUpdateStatus(uploadId: string, updates: any): Promise<void> {
  try {
    await updateStatus(uploadId, updates);
  } catch (error) {
    console.warn(`[${uploadId}] Failed to update status (non-fatal in dev):`, error);
    if (process.env.NODE_ENV === 'production') {
      throw error; // æœ¬ç•ªç’°å¢ƒã§ã¯å†ã‚¹ãƒ­ãƒ¼
    }
  }
}
```

**æœ¬ç•ªãƒ¢ãƒ¼ãƒ‰**: è‡´å‘½çš„ã‚¨ãƒ©ãƒ¼ï¼ˆå‡¦ç†ä¸­æ–­ï¼‰

#### Supabaseã‚¨ãƒ©ãƒ¼è¨ºæ–­

**`statusManager.ts`ã®ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒ©**:

| ã‚¨ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰ | æ„å‘³ | å¯¾å‡¦æ–¹æ³• |
|------------|------|---------|
| PGRST205 | ã‚¹ã‚­ãƒ¼ãƒã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¨ãƒ©ãƒ¼ | Supabase Dashboard â†’ Settings â†’ API â†’ Reload Schema |
| PGRST116 | ãƒ¬ã‚³ãƒ¼ãƒ‰æœªç™ºè¦‹ | æƒ³å®šå†…ã‚¨ãƒ©ãƒ¼ï¼ˆnullã‚’è¿”ã™ï¼‰ |
| 42501 | RLSæ¨©é™ã‚¨ãƒ©ãƒ¼ | service_role keyç¢ºèªã€RLSãƒãƒªã‚·ãƒ¼è¨­å®š |

### 10.3 ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°

**ãƒ­ã‚°ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ**:
```
[uploadId] [ã‚¹ãƒ†ãƒ¼ã‚¸] ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸: è©³ç´°
```

**ä¾‹**:
```
[upload_1730678901234_abc123xyz] [VAD] Whisper API attempt 2/3 failed for chunk 5: Rate limit exceeded
[upload_1730678901234_abc123xyz] [Processing] Processing failed: Whisper API failed: Rate limit exceeded
```

**ãƒ­ã‚°ç¢ºèªã‚³ãƒãƒ³ãƒ‰**:
```bash
# Cloud Runãƒ­ã‚°ï¼ˆãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ï¼‰
gcloud run services logs tail video-analyzer-worker --region us-central1

# ã‚¨ãƒ©ãƒ¼ã®ã¿
gcloud run services logs read video-analyzer-worker \
  --region us-central1 \
  --filter "severity>=ERROR" \
  --limit 50

# ç‰¹å®šUpload IDã®ãƒ­ã‚°
gcloud run services logs read video-analyzer-worker \
  --region us-central1 \
  --filter "textPayload:upload_1730678901234_abc123xyz" \
  --limit 100
```

---

## 11. ãƒ‡ãƒ—ãƒ­ã‚¤æ‰‹é †

### 11.1 ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ï¼ˆVercelï¼‰

#### è‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤ï¼ˆæ¨å¥¨ï¼‰

```bash
# mainãƒ–ãƒ©ãƒ³ãƒã«ãƒ—ãƒƒã‚·ãƒ¥
git add .
git commit -m "feat: Add new feature"
git push origin main

# VercelãŒè‡ªå‹•æ¤œçŸ¥ã—ã¦ãƒ‡ãƒ—ãƒ­ã‚¤
```

#### æ‰‹å‹•ãƒ‡ãƒ—ãƒ­ã‚¤

```bash
# ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
vercel

# æœ¬ç•ªç’°å¢ƒ
vercel --prod
```

#### ç’°å¢ƒå¤‰æ•°è¨­å®š

1. Vercel Dashboard â†’ Project â†’ Settings â†’ Environment Variables
2. å¿…é ˆå¤‰æ•°ã‚’è¿½åŠ :
   - `NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY`
   - `CLERK_SECRET_KEY`
   - `BLOB_READ_WRITE_TOKEN`
   - `CLOUD_RUN_URL`ï¼ˆæ”¹è¡Œãªã—ç¢ºèªï¼‰
   - `WORKER_SECRET`
   - `NEXT_PUBLIC_SUPABASE_URL`
   - `SUPABASE_SERVICE_ROLE_KEY`
3. Redeploy

### 11.2 ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ï¼ˆCloud Runï¼‰

#### ãƒ­ãƒ¼ã‚«ãƒ«ãƒ“ãƒ«ãƒ‰ç¢ºèª

```bash
cd cloud-run-worker
npm install
npm run build

# TypeScriptã‚¨ãƒ©ãƒ¼ç¢ºèª
# dist/ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªç”Ÿæˆç¢ºèª
```

#### Dockerãƒ“ãƒ«ãƒ‰ãƒ†ã‚¹ãƒˆï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰

```bash
cd cloud-run-worker
docker build -t video-analyzer-worker:test .
docker run -p 8080:8080 \
  -e NODE_ENV=production \
  -e OPENAI_API_KEY=${OPENAI_API_KEY} \
  -e GEMINI_API_KEY=${GEMINI_API_KEY} \
  -e WORKER_SECRET=${WORKER_SECRET} \
  video-analyzer-worker:test

# åˆ¥ã‚¿ãƒ¼ãƒŸãƒŠãƒ«
curl http://localhost:8080/health
```

#### Cloud Runãƒ‡ãƒ—ãƒ­ã‚¤

```bash
cd cloud-run-worker

gcloud run deploy video-analyzer-worker \
  --source . \
  --region us-central1 \
  --platform managed \
  --allow-unauthenticated \
  --memory 2Gi \
  --cpu 1 \
  --timeout 600 \
  --max-instances 10 \
  --set-env-vars \
"BLOB_READ_WRITE_TOKEN=${BLOB_READ_WRITE_TOKEN},\
SUPABASE_URL=${SUPABASE_URL},\
SUPABASE_SERVICE_ROLE_KEY=${SUPABASE_SERVICE_ROLE_KEY},\
OPENAI_API_KEY=${OPENAI_API_KEY},\
GEMINI_API_KEY=${GEMINI_API_KEY},\
WORKER_SECRET=${WORKER_SECRET},\
NODE_ENV=production"
```

**ãƒ‡ãƒ—ãƒ­ã‚¤æ™‚é–“**: ç´„5-8åˆ†

**ç¢ºèª**:
```bash
# ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯
curl https://video-analyzer-worker-820467345033.us-central1.run.app/health

# ãƒ­ã‚°ç¢ºèª
gcloud run services logs tail video-analyzer-worker --region us-central1
```

### 11.3 ãƒ‡ãƒ—ãƒ­ã‚¤ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

**ãƒ‡ãƒ—ãƒ­ã‚¤å‰**:
- [ ] ãƒ­ãƒ¼ã‚«ãƒ«ãƒ†ã‚¹ãƒˆæˆåŠŸ
- [ ] TypeScriptãƒ“ãƒ«ãƒ‰æˆåŠŸï¼ˆ`npm run build`ï¼‰
- [ ] ç’°å¢ƒå¤‰æ•°æœ€æ–°ç¢ºèª
- [ ] `.env.local`ã¨æœ¬ç•ªç’°å¢ƒã®å·®ç•°ç¢ºèª
- [ ] GEMINI_API_KEYè¨­å®šç¢ºèª
- [ ] Blobè‡ªå‹•å‰Šé™¤æ©Ÿèƒ½ç¢ºèª

**ãƒ‡ãƒ—ãƒ­ã‚¤å¾Œ**:
- [ ] ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯æˆåŠŸï¼ˆ`/health`ï¼‰
- [ ] ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã‚¢ã‚¯ã‚»ã‚¹ç¢ºèª
- [ ] ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚¢ã‚¯ã‚»ã‚¹ç¢ºèª
- [ ] ãƒ­ã‚°ã«ã‚¨ãƒ©ãƒ¼ãªã—
- [ ] E2Eãƒ†ã‚¹ãƒˆï¼ˆå‹•ç”»ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ â†’ å‡¦ç† â†’ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ï¼‰
- [ ] Blobè‡ªå‹•å‰Šé™¤å‹•ä½œç¢ºèª

### 11.4 ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯æ‰‹é †

#### Vercel

```bash
# ãƒ‡ãƒ—ãƒ­ã‚¤å±¥æ­´ç¢ºèª
vercel ls

# ç‰¹å®šãƒ‡ãƒ—ãƒ­ã‚¤ã«ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯
vercel rollback <deployment-url>
```

**ã¾ãŸã¯Dashboard**:
1. Vercel Dashboard â†’ Deployments
2. å®‰å®šãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’é¸æŠ
3. "Promote to Production"ã‚’ã‚¯ãƒªãƒƒã‚¯

#### Cloud Run

```bash
# ãƒªãƒ“ã‚¸ãƒ§ãƒ³ä¸€è¦§
gcloud run revisions list \
  --service video-analyzer-worker \
  --region us-central1

# ãƒˆãƒ©ãƒ•ã‚£ãƒƒã‚¯ã‚’å‰ã®ãƒªãƒ“ã‚¸ãƒ§ãƒ³ã«æˆ»ã™
gcloud run services update-traffic video-analyzer-worker \
  --region us-central1 \
  --to-revisions video-analyzer-worker-00001=100
```

---

## 12. æœ€è¿‘ã®ä¸»è¦ãªä¿®æ­£ï¼ˆ2025å¹´10æœˆã€œ11æœˆï¼‰

### 12.-1 å‹•ç”»åœ§ç¸®æ©Ÿèƒ½ã®å®Ÿè£…ï¼ˆ2025-11-07ï¼‰

**ç›®çš„**: å¤§å®¹é‡å‹•ç”»ã®å‡¦ç†æ™‚é–“çŸ­ç¸®ã¨ã€Cloud Runã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆï¼ˆ600ç§’ï¼‰è¶…éã®é˜²æ­¢

**å®Ÿè£…å†…å®¹**:
- 200MBè¶…ã®å‹•ç”»ã‚’è‡ªå‹•åœ§ç¸®
- FFmpeg H.264ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ï¼ˆCRF 28, fast presetï¼‰
- AACéŸ³å£°ï¼ˆ96kbpsï¼‰ã§ã‚µã‚¤ã‚ºæœ€é©åŒ–
- å‡¦ç†å‰ã®è‡ªå‹•ãƒã‚§ãƒƒã‚¯ã¨åœ§ç¸®å®Ÿè¡Œ

**æŠ€è¡“è©³ç´°**:
```typescript
// cloud-run-worker/src/services/videoProcessor.ts
if (videoSize > 200 * 1024 * 1024) { // 200MBè¶…
  console.log(`[${uploadId}] Video size: ${(videoSize / (1024 * 1024)).toFixed(1)}MB. Compressing...`);

  // H.264ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ï¼ˆCRF 28ï¼‰
  await ffmpeg([
    '-i', videoPath,
    '-c:v', 'libx264',
    '-crf', '28',
    '-preset', 'fast',
    '-c:a', 'aac',
    '-b:a', '96k',
    '-movflags', '+faststart',
    compressedPath
  ]);

  // å…ƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’åœ§ç¸®ç‰ˆã§ç½®ãæ›ãˆ
  fs.renameSync(compressedPath, videoPath);
}
```

**ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿**:
- **é–¾å€¤**: 200MB
- **ã‚³ãƒ¼ãƒ‡ãƒƒã‚¯**: H.264 (libx264)
- **å“è³ª**: CRF 28ï¼ˆå“è³ªã¨ã‚µã‚¤ã‚ºã®ãƒãƒ©ãƒ³ã‚¹ï¼‰
- **ãƒ—ãƒªã‚»ãƒƒãƒˆ**: fastï¼ˆCloud Runæœ€é©åŒ–ï¼‰
- **éŸ³å£°**: AAC 96kbpsï¼ˆéŸ³å£°èªè­˜æœ€é©åŒ–ï¼‰
- **æœ€é©åŒ–**: Web streaming (faststart)
- **å‰Šæ¸›ç‡**: 40-60%

**å½±éŸ¿ãƒ•ã‚¡ã‚¤ãƒ«**:
- `cloud-run-worker/src/services/videoProcessor.ts:252-332`

**å½±éŸ¿**:
- å¤§å®¹é‡å‹•ç”»ã®å‡¦ç†æ™‚é–“çŸ­ç¸®
- Cloud Runã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆãƒªã‚¹ã‚¯è»½æ¸›
- Whisper API/Gemini APIã®å‡¦ç†é€Ÿåº¦å‘ä¸Š

---

### 12.0 ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã¨é€²æ—ãƒ­ã‚°ä¿®æ­£ï¼ˆ2025-11-06ï¼‰

#### å•é¡Œ1: 60ç§’ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ
**ç—‡çŠ¶**: å¤§å®¹é‡å‹•ç”»ï¼ˆ445MBï¼‰ã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãŒ60ç§’ã§ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ

**ä¿®æ­£å†…å®¹**:
```typescript
// cloud-run-worker/src/services/videoProcessor.ts
// ä»¥å‰
timeout: 60000  // 60ç§’

// ç¾åœ¨
timeout: 300000,  // 5åˆ†ï¼ˆ300ç§’ï¼‰
maxContentLength: 500 * 1024 * 1024,  // 500MBåˆ¶é™
maxBodyLength: 500 * 1024 * 1024
```

**å½±éŸ¿**: å¤§å®¹é‡å‹•ç”»ï¼ˆ400MBè¶…ï¼‰ã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰æˆåŠŸç‡å‘ä¸Š

#### å•é¡Œ2: é€²æ—ãƒ­ã‚°ãŒå‡ºåŠ›ã•ã‚Œãªã„
**ç—‡çŠ¶**: ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰é€²æ—ãƒ­ã‚°ãŒã»ã¼å‡ºåŠ›ã•ã‚Œãªã„ï¼ˆ10MBã®å€æ•°ãƒã‚§ãƒƒã‚¯ãŒã»ã¼ç™ºç«ã—ãªã„ï¼‰

**ä¿®æ­£å†…å®¹**:
```typescript
// ä»¥å‰: 10MBã®å€æ•°ã¡ã‚‡ã†ã©ã®æ™‚ã ã‘ãƒ­ã‚°ï¼ˆã»ã¼ç™ºç«ã—ãªã„ï¼‰
if (totalBytes > 0 && downloadedBytes % (10 * 1024 * 1024) === 0) {
  console.log(`Progress: ...`);
}

// ç¾åœ¨: æœ€å¾Œã®ãƒ­ã‚°ã‹ã‚‰10MBä»¥ä¸Šãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã•ã‚ŒãŸã‚‰ãƒ­ã‚°å‡ºåŠ›
let lastLoggedBytes = 0;
const LOG_INTERVAL = 10 * 1024 * 1024; // 10MB

response.data.on('data', (chunk: Buffer) => {
  downloadedBytes += chunk.length;

  if (totalBytes > 0 && downloadedBytes - lastLoggedBytes >= LOG_INTERVAL) {
    const percent = ((downloadedBytes / totalBytes) * 100).toFixed(1);
    const downloadedMB = (downloadedBytes / (1024 * 1024)).toFixed(1);
    const totalMB = (totalBytes / (1024 * 1024)).toFixed(1);
    console.log(`[downloadFile] Progress: ${percent}% (${downloadedMB}MB / ${totalMB}MB)`);
    lastLoggedBytes = downloadedBytes;
  }
});
```

**å½±éŸ¿**:
- ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰é€²æ—ã®å¯è¦–åŒ–
- ãƒ‡ãƒãƒƒã‚°å®¹æ˜“æ€§å‘ä¸Š
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¸ã®å‡¦ç†çŠ¶æ³ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯æ”¹å–„

**å½±éŸ¿ãƒ•ã‚¡ã‚¤ãƒ«**:
- `cloud-run-worker/src/services/videoProcessor.ts:videoProcessor.ts:167-169` (ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ)
- `cloud-run-worker/src/services/videoProcessor.ts:videoProcessor.ts:187-199` (é€²æ—ãƒ­ã‚°)

### 12.1 Excelå½¢å¼ã®æ›´æ–°ï¼ˆ2025-10-30ï¼‰

**ä»¥å‰**:
- 4ã‚·ãƒ¼ãƒˆ: "Summary", "Transcription", "OCR Results", "Full Analysis"
- å›ºå®šé–“éš”ãƒ•ãƒ¬ãƒ¼ãƒ æŠ½å‡º

**ç¾åœ¨**:
- 2ã‚·ãƒ¼ãƒˆ: "Video Analysis"ï¼ˆ5åˆ—ï¼‰, "Statistics"
- ã‚·ãƒ¼ãƒ³ãƒ™ãƒ¼ã‚¹ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ

**å½±éŸ¿ãƒ•ã‚¡ã‚¤ãƒ«**:
- `cloud-run-worker/src/services/excel-generator.ts`

### 12.2 ç’°å¢ƒå¤‰æ•°ã®ä¿®æ­£ï¼ˆ2025-11-02, 11-03ï¼‰

**Vercel**:
- `CLOUD_RUN_URL`: æ”¹è¡Œæ–‡å­—é™¤å»ç¢ºèª
- `WORKER_SECRET`: æ­£ã—ã„å€¤è¨­å®šç¢ºèª

**Cloud Run**:
- `GEMINI_API_KEY`è¿½åŠ ï¼ˆä»¥å‰ã¯æœªè¨­å®šï¼‰

**å½±éŸ¿ãƒ•ã‚¡ã‚¤ãƒ«**:
- Vercelç’°å¢ƒå¤‰æ•°è¨­å®š
- Cloud Runç’°å¢ƒå¤‰æ•°è¨­å®š

### 12.3 Supabaseã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã®ä¿®æ­£ï¼ˆ2025-11-01ï¼‰

**ä»¥å‰**:
- `USE_SUPABASE`ç’°å¢ƒå¤‰æ•°ã§åˆ‡ã‚Šæ›¿ãˆ
- é–‹ç™ºãƒ¢ãƒ¼ãƒ‰ã§ã¯in-memory

**ç¾åœ¨**:
- `NODE_ENV=production`ã§è‡ªå‹•çš„ã«Supabaseä½¿ç”¨
- in-memoryãƒ¢ãƒ¼ãƒ‰å»ƒæ­¢ï¼ˆæœ¬ç•ªç’°å¢ƒï¼‰

**å½±éŸ¿ãƒ•ã‚¡ã‚¤ãƒ«**:
- `cloud-run-worker/src/services/statusManager.ts`

**ã‚³ãƒ¼ãƒ‰å¤‰æ›´**:
```typescript
// ä»¥å‰
const USE_SUPABASE = process.env.USE_SUPABASE === 'true';

// ç¾åœ¨
const USE_SUPABASE = process.env.NODE_ENV === 'production' || process.env.USE_SUPABASE === 'true';
```

### 12.4 `/api/process`ã®ä¿®æ­£ï¼ˆ2025-11-03ï¼‰

**å•é¡Œ**: å‡¦ç†é–‹å§‹ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒé€ä¿¡ã•ã‚Œãªã„

**ä¿®æ­£**:
- `fetch()`ã«`await`è¿½åŠ 
- ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°å¼·åŒ–
- Cloud Run Workerã¸ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆç¢ºå®Ÿæ€§å‘ä¸Š

**å½±éŸ¿ãƒ•ã‚¡ã‚¤ãƒ«**:
- `app/api/process/route.ts`

**ã‚³ãƒ¼ãƒ‰å¤‰æ›´**:
```typescript
// ä»¥å‰
const workerResponse = fetch(`${cloudRunUrl}/process`, { ... });

// ç¾åœ¨
const workerResponse = await fetch(`${cloudRunUrl}/process`, { ... });
```

### 12.5 Blobè‡ªå‹•ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å®Ÿè£…ï¼ˆ2025-11-01ï¼‰

**ç›®çš„**: Vercel Blobå®¹é‡åˆ¶é™ï¼ˆHobby: 1GBï¼‰å¯¾ç­–

**å®Ÿè£…ç®‡æ‰€**:
1. ã‚½ãƒ¼ã‚¹å‹•ç”»å‰Šé™¤ï¼ˆ`videoProcessor.ts`ï¼‰
   - ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å®Œäº†å¾Œå³åº§ã«å‰Šé™¤
   - `deleteBlob(blobUrl)`
2. Excelçµæœå‰Šé™¤ï¼ˆ`download/[uploadId]/route.ts`ï¼‰
   - ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å¾Œå³åº§ã«å‰Šé™¤
   - `del(blobUrl)`

**å½±éŸ¿ãƒ•ã‚¡ã‚¤ãƒ«**:
- `cloud-run-worker/src/services/videoProcessor.ts`
- `cloud-run-worker/src/services/blobCleaner.ts`
- `app/api/download/[uploadId]/route.ts`

### 12.6 æ°¸ç¶šã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ãƒ•ã‚£ãƒ«ã‚¿ã®æ”¹å–„ï¼ˆ2025-11-03ï¼‰

**å•é¡Œ**: å°‘æ•°ã‚·ãƒ¼ãƒ³ã§ã®çµ±è¨ˆçš„ä¸å®‰å®šæ€§

**ä¿®æ­£**:
- æœ€å°ã‚·ãƒ¼ãƒ³æ•°ãƒã‚§ãƒƒã‚¯ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 3ï¼‰
- å®‰å…¨ã‚¬ãƒ¼ãƒ‰è¿½åŠ 
- è¨­å®šå¯èƒ½ãªé–¾å€¤

**å½±éŸ¿ãƒ•ã‚¡ã‚¤ãƒ«**:
- `cloud-run-worker/src/services/pipeline.ts`

**ã‚³ãƒ¼ãƒ‰å¤‰æ›´**:
```typescript
interface OverlayFilterOptions {
  threshold?: number; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 0.5ï¼ˆ50%ï¼‰
  minScenes?: number; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 3
}

// æœ€å°ã‚·ãƒ¼ãƒ³æ•°ãƒã‚§ãƒƒã‚¯
if (scenesWithOCR.length < minScenes) {
  console.log(`Only ${scenesWithOCR.length} scenes. Skipping filter.`);
  return scenesWithOCR;
}
```

---

## 13. ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°ã¨ãƒ­ã‚°

### 13.1 ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°å®Ÿè£…ï¼ˆ2025-11-02ï¼‰

**ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª**: `monitoring/`

**å®Ÿè£…å†…å®¹**:
- 6ã¤ã®ã‚¢ãƒ©ãƒ¼ãƒˆãƒãƒªã‚·ãƒ¼
- 3ã¤ã®ãƒ­ã‚°ãƒ™ãƒ¼ã‚¹ãƒ¡ãƒˆãƒªã‚¯ã‚¹
- Cloud Monitoringãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰
- è‡ªå‹•ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ã‚¹ã‚¯ãƒªãƒ—ãƒˆ
- è‡ªå‹•ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚¹ã‚¯ãƒªãƒ—ãƒˆ

**è©³ç´°**: [monitoring/README.md](./monitoring/README.md)

### 13.2 ã‚¢ãƒ©ãƒ¼ãƒˆãƒãƒªã‚·ãƒ¼

| ã‚¢ãƒ©ãƒ¼ãƒˆå | é–¾å€¤ | å¯¾å¿œ |
|-----------|------|------|
| ã‚¨ãƒ©ãƒ¼ãƒ¬ãƒ¼ãƒˆ | > 5% | ãƒ­ã‚°ç¢ºèªã€ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯æ¤œè¨ |
| ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚¿ã‚¤ãƒ ï¼ˆp95ï¼‰ | > 60ç§’ | ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹æ•°å¢—åŠ ã€å‡¦ç†æœ€é©åŒ– |
| ãƒ¡ãƒ¢ãƒªä½¿ç”¨ç‡ | > 85% | ãƒ¡ãƒ¢ãƒªå‰²ã‚Šå½“ã¦å¢—åŠ ï¼ˆ2Gi â†’ 4Giï¼‰ |
| CPUä½¿ç”¨ç‡ | > 90% | CPUå‰²ã‚Šå½“ã¦å¢—åŠ ï¼ˆ1 vCPU â†’ 2 vCPUï¼‰ |
| ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹æ•° | >= 9/10 | æœ€å¤§ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹æ•°å¢—åŠ ï¼ˆ10 â†’ 20ï¼‰ |
| Vercel Blobå®¹é‡ | > 800MB | è‡ªå‹•å‰Šé™¤æ©Ÿèƒ½ç¢ºèªã€æ‰‹å‹•å‰Šé™¤ |

### 13.3 ãƒ­ã‚°ãƒ™ãƒ¼ã‚¹ãƒ¡ãƒˆãƒªã‚¯ã‚¹

| ãƒ¡ãƒˆãƒªã‚¯ã‚¹å | èª¬æ˜ | ã‚¯ã‚¨ãƒª |
|------------|------|-------|
| `error_log_counter` | ERRORä»¥ä¸Šã®ãƒ­ã‚°ã‚«ã‚¦ãƒ³ãƒˆ | `severity>=ERROR` |
| `video_processing_completed` | å‡¦ç†å®Œäº†ã‚¸ãƒ§ãƒ–æ•° | `textPayload:"Processing completed"` |
| `video_processing_failed` | å‡¦ç†å¤±æ•—ã‚¸ãƒ§ãƒ–æ•° | `textPayload:"Processing failed"` |

### 13.4 ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ã‚¹ã‚¯ãƒªãƒ—ãƒˆ

**å®Ÿè¡Œæ–¹æ³•**:
```bash
npx tsx monitoring/health-check.ts
```

**ç¢ºèªé …ç›®**:
- ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ï¼ˆVercelï¼‰ã‚¢ã‚¯ã‚»ã‚¹
- ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ï¼ˆCloud Runï¼‰ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯
- APIèªè¨¼ãƒ†ã‚¹ãƒˆ
- ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚¿ã‚¤ãƒ æ¸¬å®š

### 13.5 ãƒ­ã‚°ç¢ºèªæ–¹æ³•

**Cloud Runï¼ˆãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ï¼‰**:
```bash
gcloud run services logs tail video-analyzer-worker --region us-central1
```

**ã‚¨ãƒ©ãƒ¼ã®ã¿**:
```bash
gcloud run services logs read video-analyzer-worker \
  --region us-central1 \
  --filter "severity>=ERROR" \
  --limit 50
```

**ç‰¹å®šUpload IDã®ãƒ­ã‚°**:
```bash
gcloud run services logs read video-analyzer-worker \
  --region us-central1 \
  --filter "textPayload:upload_1730678901234_abc123xyz" \
  --limit 100
```

**Vercelï¼ˆDashboardï¼‰**:
1. Vercel Dashboard â†’ Project â†’ Logs
2. ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ï¼ˆFunction, Edge, Buildï¼‰

---

## 14. ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### 14.1 ã‚ˆãã‚ã‚‹å•é¡Œ

#### Cloud Run ãƒ‡ãƒ—ãƒ­ã‚¤å¤±æ•—

**ç—‡çŠ¶**:
```
ERROR: Revision 'video-analyzer-worker-00003-vzh' is not ready
```

**åŸå› **:
- ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯å¤±æ•—
- ãƒãƒ¼ãƒˆ8080ã§ãƒªãƒƒã‚¹ãƒ³ã—ã¦ã„ãªã„
- ç’°å¢ƒå¤‰æ•°ä¸è¶³
- Dockerãƒ“ãƒ«ãƒ‰ã‚¨ãƒ©ãƒ¼

**å¯¾å‡¦**:
```bash
# ãƒ­ã‚°ç¢ºèª
gcloud run services logs tail video-analyzer-worker --region us-central1

# ãƒ­ãƒ¼ã‚«ãƒ«ã§Dockerãƒ“ãƒ«ãƒ‰ç¢ºèª
cd cloud-run-worker
docker build -t test-worker .
docker run -p 8080:8080 \
  -e NODE_ENV=production \
  -e OPENAI_API_KEY=${OPENAI_API_KEY} \
  -e GEMINI_API_KEY=${GEMINI_API_KEY} \
  -e WORKER_SECRET=${WORKER_SECRET} \
  test-worker

# åˆ¥ã‚¿ãƒ¼ãƒŸãƒŠãƒ«
curl http://localhost:8080/health
```

#### Vercel Blobå®¹é‡ã‚ªãƒ¼ãƒãƒ¼

**ç—‡çŠ¶**:
```
Vercel Blob: Storage quota exceeded for Hobby plan (1GB maximum)
```

**å¯¾å‡¦**:
```bash
# æ‰‹å‹•ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
npx dotenv -e .env.local tsx scripts/cleanup-blob-storage.ts delete-all

# è‡ªå‹•ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ç¢ºèª
# â†’ videoProcessor.ts ã¨ download API ã§è‡ªå‹•å‰Šé™¤ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
```

#### ç’°å¢ƒå¤‰æ•°ãŒåæ˜ ã•ã‚Œãªã„

**Vercel**:
```bash
# ç’°å¢ƒå¤‰æ•°ç¢ºèª
vercel env ls

# ç’°å¢ƒå¤‰æ•°è¿½åŠ 
vercel env add VARIABLE_NAME

# å†ãƒ‡ãƒ—ãƒ­ã‚¤
vercel --prod
```

**Cloud Run**:
```bash
# ç’°å¢ƒå¤‰æ•°ç¢ºèª
gcloud run services describe video-analyzer-worker \
  --region us-central1 \
  --format="value(spec.template.spec.containers[0].env)"

# ç’°å¢ƒå¤‰æ•°æ›´æ–°
gcloud run services update video-analyzer-worker \
  --region us-central1 \
  --update-env-vars "VARIABLE=value"
```

#### å‡¦ç†ãŒå®Œäº†ã—ãªã„

**ç—‡çŠ¶**:
- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãŒ`processing`ã®ã¾ã¾
- é€²æ—ãŒç‰¹å®šå€¤ã§åœæ­¢

**åŸå› **:
- Whisper APIã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ
- Gemini APIãƒ¬ãƒ¼ãƒˆåˆ¶é™
- Cloud Runã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆï¼ˆ600ç§’è¶…éï¼‰

**å¯¾å‡¦**:
```bash
# ãƒ­ã‚°ç¢ºèªï¼ˆã‚¨ãƒ©ãƒ¼ç®‡æ‰€ç‰¹å®šï¼‰
gcloud run services logs read video-analyzer-worker \
  --region us-central1 \
  --filter "textPayload:upload_1730678901234_abc123xyz" \
  --limit 200

# Supabaseã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç¢ºèª
# â†’ Supabase Dashboard â†’ Table Editor â†’ processing_status
```

#### OCRãƒ†ã‚­ã‚¹ãƒˆãŒæ¤œå‡ºã•ã‚Œãªã„

**åŸå› **:
- å‹•ç”»ã«ãƒ†ã‚­ã‚¹ãƒˆãŒå®Ÿéš›ã«å­˜åœ¨ã—ãªã„
- Gemini APIãƒ¬ãƒ¼ãƒˆåˆ¶é™
- GEMINI_API_KEYæœªè¨­å®š

**å¯¾å‡¦**:
```bash
# ç’°å¢ƒå¤‰æ•°ç¢ºèª
gcloud run services describe video-analyzer-worker \
  --region us-central1 \
  --format="value(spec.template.spec.containers[0].env)" | grep GEMINI

# ãƒ­ã‚°ç¢ºèªï¼ˆOCRã‚¨ãƒ©ãƒ¼ï¼‰
gcloud run services logs read video-analyzer-worker \
  --region us-central1 \
  --filter 'textPayload:"OCR failed"' \
  --limit 50
```

#### Whisper APIã‚¨ãƒ©ãƒ¼

**ç—‡çŠ¶**:
```
Whisper API attempt 3/3 failed: Rate limit exceeded
```

**åŸå› **:
- OpenAI APIãƒ¬ãƒ¼ãƒˆåˆ¶é™
- OPENAI_API_KEYæ®‹é«˜ä¸è¶³
- APIã‚­ãƒ¼ç„¡åŠ¹

**å¯¾å‡¦**:
```bash
# APIã‚­ãƒ¼ç¢ºèª
echo $OPENAI_API_KEY

# OpenAIãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ç¢ºèª
# â†’ https://platform.openai.com/usage
# â†’ æ®‹é«˜ã€ãƒ¬ãƒ¼ãƒˆåˆ¶é™ã€APIã‚­ãƒ¼æœ‰åŠ¹æ€§ç¢ºèª
```

---

## ã¾ã¨ã‚

ã“ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¯ã€Video Analyzer V2ã‚·ã‚¹ãƒ†ãƒ ã®åŒ…æ‹¬çš„ãªæŠ€è¡“ä»•æ§˜ã‚’æä¾›ã—ã¾ã™ã€‚

### ä¸»è¦ãƒªã‚½ãƒ¼ã‚¹

- **ãƒªãƒã‚¸ãƒˆãƒª**: [GitHub](https://github.com/your-username/video-analyzer-V2-web)
- **æœ¬ç•ªURLï¼ˆæ¨å®šï¼‰**: https://video-analyzer-v2.vercel.app
- **Cloud Run URL**: https://video-analyzer-worker-820467345033.us-central1.run.app
- **Supabase URL**: https://gcwdkjyyhmqtrxvmvnvn.supabase.co

### æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—

1. **CI/CDãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³æ§‹ç¯‰** - GitHub Actionsè¿½åŠ 
2. **ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°å¼·åŒ–** - é€šçŸ¥ãƒãƒ£ãƒãƒ«è¿½åŠ ï¼ˆSlack/Emailï¼‰
3. **Secret Managerç§»è¡Œ** - APIã‚­ãƒ¼ã‚’Secret Managerã«ç§»è¡Œ
4. **ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–** - Cloud CDNã€ã‚­ãƒ£ãƒƒã‚·ãƒ¥æˆ¦ç•¥

### ã‚µãƒãƒ¼ãƒˆ

å•é¡ŒãŒç™ºç”Ÿã—ãŸå ´åˆ:
1. [ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°](#14-ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°)ã‚»ã‚¯ã‚·ãƒ§ãƒ³å‚ç…§
2. Cloud Runãƒ­ã‚°ç¢ºèª
3. Supabaseã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç¢ºèª
4. [monitoring/README.md](./monitoring/README.md)å‚ç…§

---

**ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãƒãƒ¼ã‚¸ãƒ§ãƒ³**: 2.1.1
**æœ€çµ‚æ›´æ–°**: 2025å¹´11æœˆ7æ—¥
**ä½œæˆè€…**: Claude Code (Anthropic)
