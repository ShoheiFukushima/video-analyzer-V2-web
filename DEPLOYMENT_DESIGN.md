# Video Analyzer V2 - ãƒ‡ãƒ—ãƒ­ã‚¤è¨­è¨ˆæ›¸

## ğŸ“‹ ç›®æ¬¡
1. [ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£æ¦‚è¦](#ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£æ¦‚è¦)
2. [ç’°å¢ƒæ§‹æˆ](#ç’°å¢ƒæ§‹æˆ)
3. [ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ•ãƒ­ãƒ¼](#ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ•ãƒ­ãƒ¼)
4. [ç’°å¢ƒå¤‰æ•°ç®¡ç†](#ç’°å¢ƒå¤‰æ•°ç®¡ç†)
5. [ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°æˆ¦ç•¥](#ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°æˆ¦ç•¥)
6. [ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°æˆ¦ç•¥](#ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°æˆ¦ç•¥)
7. [ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£](#ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£)
8. [ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯æ‰‹é †](#ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯æ‰‹é †)
9. [ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°](#ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°)

---

## ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£æ¦‚è¦

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         ãƒ¦ãƒ¼ã‚¶ãƒ¼                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Vercel (Next.js 14)                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  - ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ (React)                            â”‚    â”‚
â”‚  â”‚  - API Routes (/api/*)                              â”‚    â”‚
â”‚  â”‚  - èªè¨¼ (Clerk)                                      â”‚    â”‚
â”‚  â”‚  - Blob Storageç®¡ç†                                  â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  Vercel Blob     â”‚
                    â”‚  (å‹•ç”»ãƒ»Excel)    â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Google Cloud Run (Worker)                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  - Express.js ã‚µãƒ¼ãƒãƒ¼                               â”‚    â”‚
â”‚  â”‚  - FFmpeg (ã‚·ãƒ¼ãƒ³æ¤œå‡º)                               â”‚    â”‚
â”‚  â”‚  - Gemini API (OCR)                                  â”‚    â”‚
â”‚  â”‚  - OpenAI Whisper (éŸ³å£°èªè­˜)                         â”‚    â”‚
â”‚  â”‚  - Excelç”Ÿæˆ                                          â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  Supabase        â”‚
                    â”‚  (ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç®¡ç†)  â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ç’°å¢ƒæ§‹æˆ

### 1. é–‹ç™ºç’°å¢ƒ (Development)

**ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰:**
- URL: http://localhost:3001
- ç’°å¢ƒ: Node.js 24.10.0
- ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹: ãªã— (in-memory)
- ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸: `/tmp` (ãƒ­ãƒ¼ã‚«ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«)

**ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰:**
- URL: http://localhost:8080
- ç’°å¢ƒ: Node.js 24.10.0
- ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹: ãªã— (in-memory)

**ç’°å¢ƒå¤‰æ•°:**
```bash
NODE_ENV=development
USE_SUPABASE=false
CLOUD_RUN_URL=http://localhost:8080
```

### 2. æœ¬ç•ªç’°å¢ƒ (Production)

**ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰:**
- ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ : Vercel
- URL: https://video-analyzer-v2.vercel.app (æ¨å®š)
- ãƒªãƒ¼ã‚¸ãƒ§ãƒ³: Auto (CDN)
- Node.js: 20.x (Vercelæ¨å¥¨)

**ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰:**
- ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ : Google Cloud Run
- URL: https://video-analyzer-worker-820467345033.us-central1.run.app
- ãƒªãƒ¼ã‚¸ãƒ§ãƒ³: us-central1
- ã‚¹ãƒšãƒƒã‚¯:
  - CPU: 1 vCPU
  - ãƒ¡ãƒ¢ãƒª: 2 GiB
  - ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ: 600ç§’
  - æœ€å¤§ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹: 10

**ç’°å¢ƒå¤‰æ•°:**
```bash
NODE_ENV=production
USE_SUPABASE=true
```

---

## ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ•ãƒ­ãƒ¼

### ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ (Vercel)

```mermaid
graph LR
    A[git push main] --> B[Vercelæ¤œçŸ¥]
    B --> C[ãƒ“ãƒ«ãƒ‰é–‹å§‹]
    C --> D[next build]
    D --> E{æˆåŠŸ?}
    E -->|Yes| F[ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç’°å¢ƒ]
    E -->|No| G[é€šçŸ¥ & åœæ­¢]
    F --> H[è‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤]
    H --> I[æœ¬ç•ªç’°å¢ƒ]
```

**æ‰‹é †:**
1. `git push origin main`
2. VercelãŒè‡ªå‹•æ¤œçŸ¥ã—ã¦ãƒ“ãƒ«ãƒ‰é–‹å§‹
3. ãƒ“ãƒ«ãƒ‰æˆåŠŸå¾Œã€æœ¬ç•ªç’°å¢ƒã«è‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤
4. ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†é€šçŸ¥ (GitHub / Slack)

**ãƒ‡ãƒ—ãƒ­ã‚¤ã‚³ãƒãƒ³ãƒ‰ (æ‰‹å‹•):**
```bash
# Vercel CLIã§ãƒ‡ãƒ—ãƒ­ã‚¤
vercel --prod
```

### ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ (Cloud Run)

```mermaid
graph LR
    A[git push main] --> B[ãƒ­ãƒ¼ã‚«ãƒ«ã§ãƒ“ãƒ«ãƒ‰ç¢ºèª]
    B --> C[gcloud run deploy]
    C --> D[Dockerãƒ“ãƒ«ãƒ‰]
    D --> E[Container Registry]
    E --> F{ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯}
    F -->|OK| G[ãƒˆãƒ©ãƒ•ã‚£ãƒƒã‚¯åˆ‡æ›¿]
    F -->|NG| H[ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯]
```

**æ‰‹é †:**
1. ãƒ­ãƒ¼ã‚«ãƒ«ã§ãƒ“ãƒ«ãƒ‰ç¢ºèª: `npm run build`
2. Cloud Runã«ãƒ‡ãƒ—ãƒ­ã‚¤:

```bash
cd cloud-run-worker

gcloud run deploy video-analyzer-worker \
  --source . \
  --region us-central1 \
  --platform managed \
  --allow-unauthenticated \
  --memory 2Gi \
  --cpu 1 \
  --timeout 600 \
  --max-instances 10 \
  --set-env-vars \
"BLOB_READ_WRITE_TOKEN=${BLOB_READ_WRITE_TOKEN},\
SUPABASE_URL=${SUPABASE_URL},\
SUPABASE_SERVICE_ROLE_KEY=${SUPABASE_SERVICE_ROLE_KEY},\
OPENAI_API_KEY=${OPENAI_API_KEY},\
GEMINI_API_KEY=${GEMINI_API_KEY},\
WORKER_SECRET=${WORKER_SECRET},\
NODE_ENV=production"
```

**ãƒ‡ãƒ—ãƒ­ã‚¤å‰ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ:**
- [ ] ãƒ­ãƒ¼ã‚«ãƒ«ãƒ†ã‚¹ãƒˆæˆåŠŸ
- [ ] `npm run build` æˆåŠŸ
- [ ] ç’°å¢ƒå¤‰æ•°ãŒæœ€æ–°
- [ ] DockerfileãŒæ­£ã—ã„
- [ ] `.dockerignore` ãŒè¨­å®šæ¸ˆã¿

---

## ç’°å¢ƒå¤‰æ•°ç®¡ç†

### ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ (Vercel)

**å¿…é ˆå¤‰æ•°:**
```bash
# Clerkèªè¨¼
NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY=pk_test_...
CLERK_SECRET_KEY=sk_test_...

# Vercel Blob
BLOB_READ_WRITE_TOKEN=vercel_blob_rw_...

# Cloud Run Worker
CLOUD_RUN_URL=https://video-analyzer-worker-820467345033.us-central1.run.app
WORKER_SECRET=4MeGFIt36xoh1GdGLu9jnYLVX90BuzJqGrytHGjeNMw=

# Supabase
NEXT_PUBLIC_SUPABASE_URL=https://gcwdkjyyhmqtrxvmvnvn.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=eyJhbGci...
SUPABASE_SERVICE_ROLE_KEY=eyJhbGci...

# ãƒ¢ãƒ¼ãƒ‰
NODE_ENV=production
```

**è¨­å®šæ–¹æ³•:**
1. Vercel Dashboard â†’ Project â†’ Settings â†’ Environment Variables
2. æœ¬ç•ªç’°å¢ƒã«å„å¤‰æ•°ã‚’è¨­å®š
3. Redeploy

### ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ (Cloud Run)

**å¿…é ˆå¤‰æ•°:**
```bash
# Vercel Blob
BLOB_READ_WRITE_TOKEN=vercel_blob_rw_...

# Supabase
SUPABASE_URL=https://gcwdkjyyhmqtrxvmvnvn.supabase.co
SUPABASE_SERVICE_ROLE_KEY=eyJhbGci...

# AI API
OPENAI_API_KEY=sk-svcacct-...
GEMINI_API_KEY=<GEMINI_API_KEY>

# èªè¨¼
WORKER_SECRET=4MeGFIt36xoh1GdGLu9jnYLVX90BuzJqGrytHGjeNMw=

# ãƒ¢ãƒ¼ãƒ‰
NODE_ENV=production
```

**è¨­å®šæ–¹æ³•:**
```bash
gcloud run services update video-analyzer-worker \
  --region us-central1 \
  --update-env-vars "VARIABLE=value"
```

**ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£:**
- Secret Managerã®ä½¿ç”¨ã‚’æ¨å¥¨:
```bash
# Secret Managerã«ä¿å­˜
gcloud secrets create openai-api-key \
  --data-file=- <<< "${OPENAI_API_KEY}"

# Cloud Runã‹ã‚‰å‚ç…§
gcloud run services update video-analyzer-worker \
  --update-secrets OPENAI_API_KEY=openai-api-key:latest
```

---

## ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°æˆ¦ç•¥

### ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ (Vercel)

**ãƒ¡ãƒˆãƒªã‚¯ã‚¹:**
- ãƒ‡ãƒ—ãƒ­ã‚¤æˆåŠŸç‡
- ãƒ“ãƒ«ãƒ‰æ™‚é–“
- ã‚¨ãƒƒã‚¸é–¢æ•°ã‚¨ãƒ©ãƒ¼ç‡
- ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚¿ã‚¤ãƒ 

**ãƒ„ãƒ¼ãƒ«:**
- Vercel Analytics (æ¨™æº–)
- Vercel Logs
- Sentry (ã‚¨ãƒ©ãƒ¼ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚° - ã‚ªãƒ—ã‚·ãƒ§ãƒ³)

**ã‚¢ãƒ©ãƒ¼ãƒˆè¨­å®š:**
```javascript
// vercel.json
{
  "functions": {
    "api/**/*.ts": {
      "maxDuration": 60
    }
  }
}
```

### ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ (Cloud Run)

**ãƒ¡ãƒˆãƒªã‚¯ã‚¹:**
- ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ•°
- ã‚¨ãƒ©ãƒ¼ç‡
- ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·ãƒ¼ (p50, p95, p99)
- CPU/ãƒ¡ãƒ¢ãƒªä½¿ç”¨ç‡
- ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹æ•°

**ãƒ„ãƒ¼ãƒ«:**
- Cloud Monitoring (æ¨™æº–)
- Cloud Logging
- Cloud Trace (ã‚ªãƒ—ã‚·ãƒ§ãƒ³)

**ãƒ­ã‚°ç¢ºèª:**
```bash
# ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ­ã‚°
gcloud run services logs tail video-analyzer-worker \
  --region us-central1

# ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã®ã¿
gcloud run services logs read video-analyzer-worker \
  --region us-central1 \
  --filter "severity>=ERROR" \
  --limit 50
```

**ã‚¢ãƒ©ãƒ¼ãƒˆè¨­å®š:**
```yaml
# Cloud Monitoring ã‚¢ãƒ©ãƒ¼ãƒˆãƒãƒªã‚·ãƒ¼
displayName: "Cloud Run Error Rate High"
conditions:
  - displayName: "Error rate > 5%"
    conditionThreshold:
      filter: 'resource.type="cloud_run_revision" AND metric.type="run.googleapis.com/request_count"'
      comparison: COMPARISON_GT
      thresholdValue: 0.05
      duration: 300s
```

---

## ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°æˆ¦ç•¥

### ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ (Vercel)

**è‡ªå‹•ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°:**
- VercelãŒè‡ªå‹•ã§ã‚¹ã‚±ãƒ¼ãƒ«
- CDNã‚­ãƒ£ãƒƒã‚·ãƒ¥æ´»ç”¨
- ã‚¨ãƒƒã‚¸é–¢æ•°ã®åœ°ç†çš„åˆ†æ•£

**æœ€é©åŒ–:**
- Next.js Imageæœ€é©åŒ–
- é™çš„ã‚µã‚¤ãƒˆç”Ÿæˆ (SSG)
- ISR (Incremental Static Regeneration)

### ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ (Cloud Run)

**ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°è¨­å®š:**
```bash
gcloud run services update video-analyzer-worker \
  --region us-central1 \
  --min-instances 0 \      # ã‚³ãƒ¼ãƒ«ãƒ‰ã‚¹ã‚¿ãƒ¼ãƒˆè¨±å®¹
  --max-instances 10 \     # æœ€å¤§10ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹
  --concurrency 80         # 1ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚ãŸã‚Š80ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
```

**ã‚³ã‚¹ãƒˆæœ€é©åŒ–:**
- `min-instances=0`: ã‚¢ã‚¤ãƒ‰ãƒ«æ™‚ã¯èª²é‡‘ãªã—
- `max-instances=10`: éå‰°ãªã‚¹ã‚±ãƒ¼ãƒ«ã‚’é˜²æ­¢
- ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ600ç§’: é•·æ™‚é–“å‡¦ç†ã«å¯¾å¿œ

**ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–:**
- CPU: 1 vCPU (å‹•ç”»å‡¦ç†ã«å¿…è¦)
- ãƒ¡ãƒ¢ãƒª: 2 GiB (FFmpeg + AIå‡¦ç†)
- åŒæ™‚å®Ÿè¡Œ: 80 (I/Oãƒã‚¦ãƒ³ãƒ‰å‡¦ç†)

---

## ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£

### èªè¨¼ãƒ»èªå¯

**ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰:**
- Clerkèªè¨¼ (ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†)
- ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ™ãƒ¼ã‚¹èªè¨¼
- CSRFä¿è­·

**ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰:**
- WORKER_SECRETèªè¨¼ (APIé–“é€šä¿¡)
- Bearer tokenæ¤œè¨¼
- ãƒªã‚¯ã‚¨ã‚¹ãƒˆç™ºä¿¡å…ƒæ¤œè¨¼

**å®Ÿè£…:**
```typescript
// cloud-run-worker/src/index.ts
const validateAuth = (req: Request, res: Response, next: Function): void => {
  const authHeader = req.headers.authorization;
  const token = authHeader?.replace('Bearer ', '');

  if (!token || token !== workerSecret) {
    res.status(401).json({ error: 'Unauthorized' });
    return;
  }

  next();
};
```

### ãƒ‡ãƒ¼ã‚¿ä¿è­·

**Blob Storage:**
- è‡ªå‹•ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ— (å‡¦ç†å®Œäº†å¾Œå³å‰Šé™¤)
- ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ç®¡ç†
- æœ‰åŠ¹æœŸé™ä»˜ãURL

**ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹:**
- Supabase RLS (Row Level Security)
- ã‚µãƒ¼ãƒ“ã‚¹ãƒ­ãƒ¼ãƒ«ã‚­ãƒ¼ã®åˆ¶é™
- æœ€å°æ¨©é™åŸå‰‡

### ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯

**Cloud Run:**
- HTTPSå¼·åˆ¶
- `--allow-unauthenticated` (å†…éƒ¨èªè¨¼ã§ä¿è­·)
- VPC Connector (ã‚ªãƒ—ã‚·ãƒ§ãƒ³)

**Vercel:**
- è‡ªå‹•HTTPS
- DDoSä¿è­·
- ãƒ•ã‚¡ã‚¤ã‚¢ã‚¦ã‚©ãƒ¼ãƒ« (Enterprise)

---

## ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯æ‰‹é †

### ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ (Vercel)

**æ‰‹é †:**
1. Vercel Dashboard â†’ Deployments
2. å®‰å®šãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’é¸æŠ
3. "Promote to Production" ã‚’ã‚¯ãƒªãƒƒã‚¯

**CLI:**
```bash
# ãƒ‡ãƒ—ãƒ­ã‚¤å±¥æ­´ç¢ºèª
vercel ls

# ç‰¹å®šãƒ‡ãƒ—ãƒ­ã‚¤ã«ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯
vercel rollback <deployment-url>
```

### ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ (Cloud Run)

**æ‰‹é †:**
```bash
# ãƒªãƒ“ã‚¸ãƒ§ãƒ³ä¸€è¦§
gcloud run revisions list \
  --service video-analyzer-worker \
  --region us-central1

# ãƒˆãƒ©ãƒ•ã‚£ãƒƒã‚¯ã‚’å‰ã®ãƒªãƒ“ã‚¸ãƒ§ãƒ³ã«æˆ»ã™
gcloud run services update-traffic video-analyzer-worker \
  --region us-central1 \
  --to-revisions video-analyzer-worker-00001=100
```

**ç·Šæ€¥ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯:**
```bash
# å‰ã®ãƒªãƒ“ã‚¸ãƒ§ãƒ³ã«å³åº§ã«åˆ‡ã‚Šæ›¿ãˆ
gcloud run services update-traffic video-analyzer-worker \
  --region us-central1 \
  --to-revisions LATEST=0,video-analyzer-worker-00001=100
```

---

## ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### ã‚ˆãã‚ã‚‹å•é¡Œ

#### 1. Cloud Run ãƒ‡ãƒ—ãƒ­ã‚¤å¤±æ•—

**ç—‡çŠ¶:**
```
ERROR: Revision 'video-analyzer-worker-00003-vzh' is not ready
```

**åŸå› :**
- ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯å¤±æ•—
- ãƒãƒ¼ãƒˆ8080ã§ãƒªãƒƒã‚¹ãƒ³ã—ã¦ã„ãªã„
- ç’°å¢ƒå¤‰æ•°ä¸è¶³

**è§£æ±ºç­–:**
```bash
# ãƒ­ã‚°ç¢ºèª
gcloud run services logs tail video-analyzer-worker --region us-central1

# ãƒ­ãƒ¼ã‚«ãƒ«ã§Dockerãƒ“ãƒ«ãƒ‰ç¢ºèª
docker build -t test-worker -f cloud-run-worker/Dockerfile cloud-run-worker
docker run -p 8080:8080 -e NODE_ENV=production test-worker

# ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ç¢ºèª
curl http://localhost:8080/health
```

#### 2. Vercel Blobå®¹é‡ã‚ªãƒ¼ãƒãƒ¼

**ç—‡çŠ¶:**
```
Vercel Blob: Storage quota exceeded for Hobby plan (1GB maximum)
```

**è§£æ±ºç­–:**
```bash
# æ‰‹å‹•ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
npx dotenv -e .env.local tsx scripts/cleanup-blob-storage.ts delete-all

# è‡ªå‹•ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ç¢ºèª
# â†’ videoProcessor.ts ã¨ download API ã§è‡ªå‹•å‰Šé™¤ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
```

#### 3. ç’°å¢ƒå¤‰æ•°ãŒåæ˜ ã•ã‚Œãªã„

**Vercel:**
```bash
# ç’°å¢ƒå¤‰æ•°ç¢ºèª
vercel env ls

# ç’°å¢ƒå¤‰æ•°è¿½åŠ 
vercel env add VARIABLE_NAME

# å†ãƒ‡ãƒ—ãƒ­ã‚¤
vercel --prod
```

**Cloud Run:**
```bash
# ç’°å¢ƒå¤‰æ•°ç¢ºèª
gcloud run services describe video-analyzer-worker \
  --region us-central1 \
  --format="value(spec.template.spec.containers[0].env)"

# ç’°å¢ƒå¤‰æ•°æ›´æ–°
gcloud run services update video-analyzer-worker \
  --region us-central1 \
  --update-env-vars "VARIABLE=value"
```

#### 4. ã‚³ãƒ¼ãƒ«ãƒ‰ã‚¹ã‚¿ãƒ¼ãƒˆé…å»¶

**ç—‡çŠ¶:**
åˆå›ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒ30ç§’ä»¥ä¸Šã‹ã‹ã‚‹

**è§£æ±ºç­–:**
```bash
# æœ€å°ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹æ•°ã‚’1ã«è¨­å®š (æœ‰æ–™)
gcloud run services update video-analyzer-worker \
  --region us-central1 \
  --min-instances 1

# ã¾ãŸã¯ã€Cloud Schedulerã§å®šæœŸçš„ã«ã‚¦ã‚©ãƒ¼ãƒ ã‚¢ãƒƒãƒ—
gcloud scheduler jobs create http warm-up-worker \
  --schedule "*/5 * * * *" \
  --uri "https://video-analyzer-worker-820467345033.us-central1.run.app/health"
```

---

## ãƒ‡ãƒ—ãƒ­ã‚¤ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

### ãƒ‡ãƒ—ãƒ­ã‚¤å‰

- [ ] ãƒ­ãƒ¼ã‚«ãƒ«ãƒ†ã‚¹ãƒˆæˆåŠŸ
- [ ] TypeScriptãƒ“ãƒ«ãƒ‰æˆåŠŸ
- [ ] ç’°å¢ƒå¤‰æ•°ç¢ºèª
- [ ] `.env.local` ã¨æœ¬ç•ªç’°å¢ƒã®å·®ç•°ç¢ºèª
- [ ] GEMINI_API_KEYãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
- [ ] Blobè‡ªå‹•å‰Šé™¤æ©Ÿèƒ½ãŒå‹•ä½œã—ã¦ã„ã‚‹ã‹ç¢ºèª

### ãƒ‡ãƒ—ãƒ­ã‚¤å¾Œ

- [ ] ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯æˆåŠŸ
- [ ] ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã‚¢ã‚¯ã‚»ã‚¹ç¢ºèª
- [ ] ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚¢ã‚¯ã‚»ã‚¹ç¢ºèª
- [ ] ãƒ­ã‚°ã«ã‚¨ãƒ©ãƒ¼ãŒãªã„ã‹ç¢ºèª
- [ ] å‹•ç”»ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ â†’ å‡¦ç† â†’ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ ã®E2Eãƒ†ã‚¹ãƒˆ
- [ ] BlobãŒè‡ªå‹•å‰Šé™¤ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª

### ç·Šæ€¥æ™‚

- [ ] ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯æ‰‹é †ã‚’æŠŠæ¡
- [ ] ãƒ­ã‚°ç¢ºèªæ–¹æ³•ã‚’æŠŠæ¡
- [ ] é€£çµ¡å…ˆã‚’ç¢ºèª

---

## ä»Šå¾Œã®æ”¹å–„æ¡ˆ

### çŸ­æœŸ (1-2é€±é–“)

1. **GEMINI_API_KEYã®è¿½åŠ **
   - Cloud Runã«ç’°å¢ƒå¤‰æ•°è¿½åŠ 
   - Secret Managerã¸ã®ç§»è¡Œ

2. **CI/CDãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³æ§‹ç¯‰**
   - GitHub Actionsè¿½åŠ 
   - è‡ªå‹•ãƒ†ã‚¹ãƒˆ
   - è‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤

3. **ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°å¼·åŒ–**
   - Sentryå°å…¥
   - ã‚¢ãƒ©ãƒ¼ãƒˆè¨­å®š

### ä¸­æœŸ (1-2ãƒ¶æœˆ)

1. **ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–**
   - Cloud CDNè¿½åŠ 
   - ç”»åƒæœ€é©åŒ–
   - ã‚­ãƒ£ãƒƒã‚·ãƒ¥æˆ¦ç•¥

2. **ã‚³ã‚¹ãƒˆæœ€é©åŒ–**
   - Blobä¿æŒæœŸé–“æœ€é©åŒ–
   - Cloud Runæœ€å°ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹èª¿æ•´
   - ä¸è¦ãªãƒ­ã‚°å‰Šæ¸›

3. **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¼·åŒ–**
   - Secret Managerç§»è¡Œ
   - VPC Connectorè¿½åŠ 
   - ãƒ•ã‚¡ã‚¤ã‚¢ã‚¦ã‚©ãƒ¼ãƒ«ãƒ«ãƒ¼ãƒ«

### é•·æœŸ (3-6ãƒ¶æœˆ)

1. **ãƒãƒ«ãƒãƒªãƒ¼ã‚¸ãƒ§ãƒ³å¯¾å¿œ**
   - ã‚¢ã‚¸ã‚¢åœ°åŸŸã¸ã®å±•é–‹
   - ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·ãƒ¼æ”¹å–„

2. **ã‚¹ã‚±ãƒ¼ãƒ©ãƒ“ãƒªãƒ†ã‚£å‘ä¸Š**
   - ã‚­ãƒ¥ãƒ¼å°å…¥ (Pub/Sub)
   - ãƒ¯ãƒ¼ã‚«ãƒ¼ãƒ—ãƒ¼ãƒ«

3. **é«˜å¯ç”¨æ€§**
   - ãƒãƒ«ãƒãƒªãƒ¼ã‚¸ãƒ§ãƒ³ãƒ‡ãƒ—ãƒ­ã‚¤
   - ãƒ•ã‚§ã‚¤ãƒ«ã‚ªãƒ¼ãƒãƒ¼è¨­å®š

---

## å‚è€ƒãƒªãƒ³ã‚¯

- [Vercel Documentation](https://vercel.com/docs)
- [Cloud Run Documentation](https://cloud.google.com/run/docs)
- [Next.js Deployment](https://nextjs.org/docs/deployment)
- [Supabase Documentation](https://supabase.com/docs)

---

**æœ€çµ‚æ›´æ–°:** 2025-11-01
**ãƒãƒ¼ã‚¸ãƒ§ãƒ³:** 2.0.0
