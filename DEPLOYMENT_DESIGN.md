# Video Analyzer V2 - ãƒ‡ãƒ—ãƒ­ã‚¤è¨­è¨ˆæ›¸

## ğŸ“‹ ç›®æ¬¡
1. [ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£æ¦‚è¦](#ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£æ¦‚è¦)
2. [ç’°å¢ƒæ§‹æˆ](#ç’°å¢ƒæ§‹æˆ)
3. [ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ•ãƒ­ãƒ¼](#ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ•ãƒ­ãƒ¼)
4. [ç’°å¢ƒå¤‰æ•°ç®¡ç†](#ç’°å¢ƒå¤‰æ•°ç®¡ç†)
5. [ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°æˆ¦ç•¥](#ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°æˆ¦ç•¥)
6. [ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°æˆ¦ç•¥](#ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°æˆ¦ç•¥)
7. [ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£](#ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£)
8. [ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯æ‰‹é †](#ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯æ‰‹é †)
9. [ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°](#ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°)

---

## ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£æ¦‚è¦

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         ãƒ¦ãƒ¼ã‚¶ãƒ¼                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Vercel (Next.js 14)                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  - ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ (React)                            â”‚    â”‚
â”‚  â”‚  - API Routes (/api/*)                              â”‚    â”‚
â”‚  â”‚  - èªè¨¼ (Clerk)                                      â”‚    â”‚
â”‚  â”‚  - Blob Storageç®¡ç†                                  â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  Vercel Blob     â”‚
                    â”‚  (å‹•ç”»ãƒ»Excel)    â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Google Cloud Run (Worker)                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  - Express.js ã‚µãƒ¼ãƒãƒ¼                               â”‚    â”‚
â”‚  â”‚  - FFmpeg (ã‚·ãƒ¼ãƒ³æ¤œå‡º)                               â”‚    â”‚
â”‚  â”‚  - Gemini API (OCR)                                  â”‚    â”‚
â”‚  â”‚  - OpenAI Whisper (éŸ³å£°èªè­˜)                         â”‚    â”‚
â”‚  â”‚  - Excelç”Ÿæˆ                                          â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  Supabase        â”‚
                    â”‚  (ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç®¡ç†)  â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ç’°å¢ƒæ§‹æˆ

### 1. é–‹ç™ºç’°å¢ƒ (Development)

**ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰:**
- URL: http://localhost:3001
- ç’°å¢ƒ: Node.js 24.10.0
- ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹: ãªã— (in-memory)
- ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸: `/tmp` (ãƒ­ãƒ¼ã‚«ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«)

**ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰:**
- URL: http://localhost:8080
- ç’°å¢ƒ: Node.js 24.10.0
- ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹: ãªã— (in-memory)

**ç’°å¢ƒå¤‰æ•°:**
```bash
NODE_ENV=development
USE_SUPABASE=false
CLOUD_RUN_URL=http://localhost:8080
```

### 2. æœ¬ç•ªç’°å¢ƒ (Production)

**ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰:**
- ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ : Vercel
- URL: https://video-analyzer-v2.vercel.app (æ¨å®š)
- ãƒªãƒ¼ã‚¸ãƒ§ãƒ³: Auto (CDN)
- Node.js: 20.x (Vercelæ¨å¥¨)

**ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰:**
- ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ : Google Cloud Run
- URL: https://video-analyzer-worker-820467345033.us-central1.run.app
- ãƒªãƒ¼ã‚¸ãƒ§ãƒ³: us-central1
- ã‚¹ãƒšãƒƒã‚¯:
  - CPU: 1 vCPU
  - ãƒ¡ãƒ¢ãƒª: 2 GiB
  - ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ: 600ç§’
  - æœ€å¤§ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹: 10

**ç’°å¢ƒå¤‰æ•°:**
```bash
NODE_ENV=production
USE_SUPABASE=true
```

---

## ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ•ãƒ­ãƒ¼

### ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ (Vercel)

```mermaid
graph LR
    A[git push main] --> B[Vercelæ¤œçŸ¥]
    B --> C[ãƒ“ãƒ«ãƒ‰é–‹å§‹]
    C --> D[next build]
    D --> E{æˆåŠŸ?}
    E -->|Yes| F[ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç’°å¢ƒ]
    E -->|No| G[é€šçŸ¥ & åœæ­¢]
    F --> H[è‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤]
    H --> I[æœ¬ç•ªç’°å¢ƒ]
```

**æ‰‹é †:**
1. `git push origin main`
2. VercelãŒè‡ªå‹•æ¤œçŸ¥ã—ã¦ãƒ“ãƒ«ãƒ‰é–‹å§‹
3. ãƒ“ãƒ«ãƒ‰æˆåŠŸå¾Œã€æœ¬ç•ªç’°å¢ƒã«è‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤
4. ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†é€šçŸ¥ (GitHub / Slack)

**ãƒ‡ãƒ—ãƒ­ã‚¤ã‚³ãƒãƒ³ãƒ‰ (æ‰‹å‹•):**
```bash
# Vercel CLIã§ãƒ‡ãƒ—ãƒ­ã‚¤
vercel --prod
```

### ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ (Cloud Run)

```mermaid
graph LR
    A[git push main] --> B[ãƒ­ãƒ¼ã‚«ãƒ«ã§ãƒ“ãƒ«ãƒ‰ç¢ºèª]
    B --> C[gcloud run deploy]
    C --> D[Dockerãƒ“ãƒ«ãƒ‰]
    D --> E[Container Registry]
    E --> F{ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯}
    F -->|OK| G[ãƒˆãƒ©ãƒ•ã‚£ãƒƒã‚¯åˆ‡æ›¿]
    F -->|NG| H[ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯]
```

**æ‰‹é †:**
1. ãƒ­ãƒ¼ã‚«ãƒ«ã§ãƒ“ãƒ«ãƒ‰ç¢ºèª: `npm run build`
2. Cloud Runã«ãƒ‡ãƒ—ãƒ­ã‚¤:

```bash
cd cloud-run-worker

gcloud run deploy video-analyzer-worker \
  --source . \
  --region us-central1 \
  --platform managed \
  --allow-unauthenticated \
  --memory 2Gi \
  --cpu 1 \
  --timeout 600 \
  --max-instances 10 \
  --set-env-vars \
"BLOB_READ_WRITE_TOKEN=${BLOB_READ_WRITE_TOKEN},\
SUPABASE_URL=${SUPABASE_URL},\
SUPABASE_SERVICE_ROLE_KEY=${SUPABASE_SERVICE_ROLE_KEY},\
OPENAI_API_KEY=${OPENAI_API_KEY},\
GEMINI_API_KEY=${GEMINI_API_KEY},\
WORKER_SECRET=${WORKER_SECRET},\
NODE_ENV=production"
```

**ãƒ‡ãƒ—ãƒ­ã‚¤å‰ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ:**
- [ ] ãƒ­ãƒ¼ã‚«ãƒ«ãƒ†ã‚¹ãƒˆæˆåŠŸ
- [ ] `npm run build` æˆåŠŸ
- [ ] ç’°å¢ƒå¤‰æ•°ãŒæœ€æ–°
- [ ] DockerfileãŒæ­£ã—ã„
- [ ] `.dockerignore` ãŒè¨­å®šæ¸ˆã¿

---

## ç’°å¢ƒå¤‰æ•°ç®¡ç†

### ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ (Vercel)

**å¿…é ˆå¤‰æ•°:**
```bash
# Clerkèªè¨¼
NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY=pk_test_...
CLERK_SECRET_KEY=sk_test_...

# Vercel Blob
BLOB_READ_WRITE_TOKEN=vercel_blob_rw_...

# Cloud Run Worker
CLOUD_RUN_URL=https://video-analyzer-worker-820467345033.us-central1.run.app
WORKER_SECRET=4MeGFIt36xoh1GdGLu9jnYLVX90BuzJqGrytHGjeNMw=

# Supabase
NEXT_PUBLIC_SUPABASE_URL=https://gcwdkjyyhmqtrxvmvnvn.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=eyJhbGci...
SUPABASE_SERVICE_ROLE_KEY=eyJhbGci...

# ãƒ¢ãƒ¼ãƒ‰
NODE_ENV=production
```

**è¨­å®šæ–¹æ³•:**
1. Vercel Dashboard â†’ Project â†’ Settings â†’ Environment Variables
2. æœ¬ç•ªç’°å¢ƒã«å„å¤‰æ•°ã‚’è¨­å®š
3. Redeploy

### ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ (Cloud Run)

**å¿…é ˆå¤‰æ•°:**
```bash
# Vercel Blob
BLOB_READ_WRITE_TOKEN=vercel_blob_rw_...

# Supabase
SUPABASE_URL=https://gcwdkjyyhmqtrxvmvnvn.supabase.co
SUPABASE_SERVICE_ROLE_KEY=eyJhbGci...

# AI API
OPENAI_API_KEY=sk-svcacct-...
GEMINI_API_KEY=<GEMINI_API_KEY>

# èªè¨¼
WORKER_SECRET=4MeGFIt36xoh1GdGLu9jnYLVX90BuzJqGrytHGjeNMw=

# ãƒ¢ãƒ¼ãƒ‰
NODE_ENV=production
```

**è¨­å®šæ–¹æ³•:**
```bash
gcloud run services update video-analyzer-worker \
  --region us-central1 \
  --update-env-vars "VARIABLE=value"
```

**ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£:**
- Secret Managerã®ä½¿ç”¨ã‚’æ¨å¥¨ï¼ˆè©³ç´°ã¯[Secret Managerç§»è¡Œã‚¬ã‚¤ãƒ‰](#secret-managerç§»è¡Œã‚¬ã‚¤ãƒ‰)å‚ç…§ï¼‰

---

## ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°æˆ¦ç•¥

### å®Ÿè£…æ¸ˆã¿ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°ï¼ˆ2025-11-02ï¼‰

**ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª:** `monitoring/`

åŒ…æ‹¬çš„ãªãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°ã‚½ãƒªãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å®Ÿè£…ã—ã¾ã—ãŸ:
- 6ã¤ã®ã‚¢ãƒ©ãƒ¼ãƒˆãƒãƒªã‚·ãƒ¼ï¼ˆã‚¨ãƒ©ãƒ¼ãƒ¬ãƒ¼ãƒˆã€ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·ãƒ¼ã€ãƒªã‚½ãƒ¼ã‚¹ä½¿ç”¨ç‡ãªã©ï¼‰
- 3ã¤ã®ãƒ­ã‚°ãƒ™ãƒ¼ã‚¹ãƒ¡ãƒˆãƒªã‚¯ã‚¹
- Cloud Monitoringãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ï¼ˆ8ãƒ‘ãƒãƒ«ï¼‰
- è‡ªå‹•ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ã‚¹ã‚¯ãƒªãƒ—ãƒˆ
- è‡ªå‹•ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚¹ã‚¯ãƒªãƒ—ãƒˆ

è©³ç´°: [monitoring/README.md](./monitoring/README.md)

### ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ (Vercel)

**ãƒ¡ãƒˆãƒªã‚¯ã‚¹:**
- ãƒ‡ãƒ—ãƒ­ã‚¤æˆåŠŸç‡
- ãƒ“ãƒ«ãƒ‰æ™‚é–“
- ã‚¨ãƒƒã‚¸é–¢æ•°ã‚¨ãƒ©ãƒ¼ç‡
- ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚¿ã‚¤ãƒ 

**ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°æ–¹æ³•:**
- Vercel Analytics (æ¨™æº–)
- Vercel Logs
- `/api/health` ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆç›£è¦–
- Uptime Checkï¼ˆ5åˆ†é–“éš”ï¼‰
- ã‚«ã‚¹ã‚¿ãƒ ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ã‚¹ã‚¯ãƒªãƒ—ãƒˆ

**ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ:**
```
GET https://video-analyzer-v2-web.vercel.app/api/health
```

### ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ (Cloud Run)

**ãƒ¡ãƒˆãƒªã‚¯ã‚¹:**
- ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ•°
- ã‚¨ãƒ©ãƒ¼ç‡ï¼ˆé–¾å€¤: 5%ï¼‰
- ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·ãƒ¼ (p50, p95, p99) - é–¾å€¤: p95 > 60ç§’
- CPUä½¿ç”¨ç‡ï¼ˆé–¾å€¤: 90%ï¼‰
- ãƒ¡ãƒ¢ãƒªä½¿ç”¨ç‡ï¼ˆé–¾å€¤: 85%ï¼‰
- ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹æ•°ï¼ˆé–¾å€¤: 9/10ï¼‰

**ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°æ–¹æ³•:**
- Cloud Monitoringï¼ˆæ¨™æº–ï¼‰
- Cloud Logging
- ã‚¢ãƒ©ãƒ¼ãƒˆãƒãƒªã‚·ãƒ¼ï¼ˆè‡ªå‹•é€šçŸ¥ï¼‰
- ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ï¼ˆãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ å¯è¦–åŒ–ï¼‰
- Uptime Checkï¼ˆ5åˆ†é–“éš”ï¼‰

**ãƒ­ã‚°ç¢ºèª:**
```bash
# ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ­ã‚°
gcloud run services logs tail video-analyzer-worker \
  --region us-central1

# ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã®ã¿
gcloud run services logs read video-analyzer-worker \
  --region us-central1 \
  --filter "severity>=ERROR" \
  --limit 50

# ã¾ãŸã¯ monitoring ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ä½¿ç”¨
npx tsx monitoring/health-check.ts
```

**ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—:**
```bash
# è‡ªå‹•ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å®Ÿè¡Œ
./monitoring/setup-monitoring.sh

# ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ç¢ºèª
open "https://console.cloud.google.com/monitoring/dashboards?project=video-analyzer-worker"
```

**ã‚¢ãƒ©ãƒ¼ãƒˆãƒãƒªã‚·ãƒ¼ï¼ˆ6ç¨®é¡ï¼‰:**
1. ã‚¨ãƒ©ãƒ¼ãƒ¬ãƒ¼ãƒˆ > 5%
2. ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚¿ã‚¤ãƒ  (p95) > 60ç§’
3. ãƒ¡ãƒ¢ãƒªä½¿ç”¨ç‡ > 85%
4. CPUä½¿ç”¨ç‡ > 90%
5. ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹æ•° >= 9
6. Vercel Blobå®¹é‡ > 800MB

å„ã‚¢ãƒ©ãƒ¼ãƒˆã«ã¯å¯¾å¿œæ‰‹é †ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãŒå«ã¾ã‚Œã¦ã„ã¾ã™ã€‚

**ãƒ­ã‚°ãƒ™ãƒ¼ã‚¹ãƒ¡ãƒˆãƒªã‚¯ã‚¹ï¼ˆ3ç¨®é¡ï¼‰:**
- `error_log_counter` - ERRORä»¥ä¸Šã®ãƒ­ã‚°ã‚«ã‚¦ãƒ³ãƒˆ
- `video_processing_completed` - å‡¦ç†å®Œäº†ã‚¸ãƒ§ãƒ–æ•°
- `video_processing_failed` - å‡¦ç†å¤±æ•—ã‚¸ãƒ§ãƒ–æ•°

---

## ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°æˆ¦ç•¥

### ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ (Vercel)

**è‡ªå‹•ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°:**
- VercelãŒè‡ªå‹•ã§ã‚¹ã‚±ãƒ¼ãƒ«
- CDNã‚­ãƒ£ãƒƒã‚·ãƒ¥æ´»ç”¨
- ã‚¨ãƒƒã‚¸é–¢æ•°ã®åœ°ç†çš„åˆ†æ•£

**æœ€é©åŒ–:**
- Next.js Imageæœ€é©åŒ–
- é™çš„ã‚µã‚¤ãƒˆç”Ÿæˆ (SSG)
- ISR (Incremental Static Regeneration)

### ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ (Cloud Run)

**ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°è¨­å®š:**
```bash
gcloud run services update video-analyzer-worker \
  --region us-central1 \
  --min-instances 0 \      # ã‚³ãƒ¼ãƒ«ãƒ‰ã‚¹ã‚¿ãƒ¼ãƒˆè¨±å®¹
  --max-instances 10 \     # æœ€å¤§10ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹
  --concurrency 80         # 1ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚ãŸã‚Š80ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
```

**ã‚³ã‚¹ãƒˆæœ€é©åŒ–:**
- `min-instances=0`: ã‚¢ã‚¤ãƒ‰ãƒ«æ™‚ã¯èª²é‡‘ãªã—
- `max-instances=10`: éå‰°ãªã‚¹ã‚±ãƒ¼ãƒ«ã‚’é˜²æ­¢
- ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ600ç§’: é•·æ™‚é–“å‡¦ç†ã«å¯¾å¿œ

**ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–:**
- CPU: 1 vCPU (å‹•ç”»å‡¦ç†ã«å¿…è¦)
- ãƒ¡ãƒ¢ãƒª: 2 GiB (FFmpeg + AIå‡¦ç†)
- åŒæ™‚å®Ÿè¡Œ: 80 (I/Oãƒã‚¦ãƒ³ãƒ‰å‡¦ç†)

---

## ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£

### èªè¨¼ãƒ»èªå¯

**ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰:**
- Clerkèªè¨¼ (ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†)
- ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ™ãƒ¼ã‚¹èªè¨¼
- CSRFä¿è­·

**ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰:**
- WORKER_SECRETèªè¨¼ (APIé–“é€šä¿¡)
- Bearer tokenæ¤œè¨¼
- ãƒªã‚¯ã‚¨ã‚¹ãƒˆç™ºä¿¡å…ƒæ¤œè¨¼

**å®Ÿè£…:**
```typescript
// cloud-run-worker/src/index.ts
const validateAuth = (req: Request, res: Response, next: Function): void => {
  const authHeader = req.headers.authorization;
  const token = authHeader?.replace('Bearer ', '');

  if (!token || token !== workerSecret) {
    res.status(401).json({ error: 'Unauthorized' });
    return;
  }

  next();
};
```

### ãƒ‡ãƒ¼ã‚¿ä¿è­·

**Blob Storage:**
- è‡ªå‹•ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ— (å‡¦ç†å®Œäº†å¾Œå³å‰Šé™¤)
- ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ç®¡ç†
- æœ‰åŠ¹æœŸé™ä»˜ãURL

**ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹:**
- Supabase RLS (Row Level Security)
- ã‚µãƒ¼ãƒ“ã‚¹ãƒ­ãƒ¼ãƒ«ã‚­ãƒ¼ã®åˆ¶é™
- æœ€å°æ¨©é™åŸå‰‡

### ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯

**Cloud Run:**
- HTTPSå¼·åˆ¶
- `--allow-unauthenticated` (å†…éƒ¨èªè¨¼ã§ä¿è­·)
- VPC Connector (ã‚ªãƒ—ã‚·ãƒ§ãƒ³)

**Vercel:**
- è‡ªå‹•HTTPS
- DDoSä¿è­·
- ãƒ•ã‚¡ã‚¤ã‚¢ã‚¦ã‚©ãƒ¼ãƒ« (Enterprise)

---

## ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯æ‰‹é †

### ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ (Vercel)

**æ‰‹é †:**
1. Vercel Dashboard â†’ Deployments
2. å®‰å®šãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’é¸æŠ
3. "Promote to Production" ã‚’ã‚¯ãƒªãƒƒã‚¯

**CLI:**
```bash
# ãƒ‡ãƒ—ãƒ­ã‚¤å±¥æ­´ç¢ºèª
vercel ls

# ç‰¹å®šãƒ‡ãƒ—ãƒ­ã‚¤ã«ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯
vercel rollback <deployment-url>
```

### ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ (Cloud Run)

**æ‰‹é †:**
```bash
# ãƒªãƒ“ã‚¸ãƒ§ãƒ³ä¸€è¦§
gcloud run revisions list \
  --service video-analyzer-worker \
  --region us-central1

# ãƒˆãƒ©ãƒ•ã‚£ãƒƒã‚¯ã‚’å‰ã®ãƒªãƒ“ã‚¸ãƒ§ãƒ³ã«æˆ»ã™
gcloud run services update-traffic video-analyzer-worker \
  --region us-central1 \
  --to-revisions video-analyzer-worker-00001=100
```

**ç·Šæ€¥ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯:**
```bash
# å‰ã®ãƒªãƒ“ã‚¸ãƒ§ãƒ³ã«å³åº§ã«åˆ‡ã‚Šæ›¿ãˆ
gcloud run services update-traffic video-analyzer-worker \
  --region us-central1 \
  --to-revisions LATEST=0,video-analyzer-worker-00001=100
```

---

## ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### ã‚ˆãã‚ã‚‹å•é¡Œ

#### 1. Cloud Run ãƒ‡ãƒ—ãƒ­ã‚¤å¤±æ•—

**ç—‡çŠ¶:**
```
ERROR: Revision 'video-analyzer-worker-00003-vzh' is not ready
```

**åŸå› :**
- ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯å¤±æ•—
- ãƒãƒ¼ãƒˆ8080ã§ãƒªãƒƒã‚¹ãƒ³ã—ã¦ã„ãªã„
- ç’°å¢ƒå¤‰æ•°ä¸è¶³

**è§£æ±ºç­–:**
```bash
# ãƒ­ã‚°ç¢ºèª
gcloud run services logs tail video-analyzer-worker --region us-central1

# ãƒ­ãƒ¼ã‚«ãƒ«ã§Dockerãƒ“ãƒ«ãƒ‰ç¢ºèª
docker build -t test-worker -f cloud-run-worker/Dockerfile cloud-run-worker
docker run -p 8080:8080 -e NODE_ENV=production test-worker

# ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ç¢ºèª
curl http://localhost:8080/health
```

#### 2. Vercel Blobå®¹é‡ã‚ªãƒ¼ãƒãƒ¼

**ç—‡çŠ¶:**
```
Vercel Blob: Storage quota exceeded for Hobby plan (1GB maximum)
```

**è§£æ±ºç­–:**
```bash
# æ‰‹å‹•ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
npx dotenv -e .env.local tsx scripts/cleanup-blob-storage.ts delete-all

# è‡ªå‹•ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ç¢ºèª
# â†’ videoProcessor.ts ã¨ download API ã§è‡ªå‹•å‰Šé™¤ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
```

#### 3. ç’°å¢ƒå¤‰æ•°ãŒåæ˜ ã•ã‚Œãªã„

**Vercel:**
```bash
# ç’°å¢ƒå¤‰æ•°ç¢ºèª
vercel env ls

# ç’°å¢ƒå¤‰æ•°è¿½åŠ 
vercel env add VARIABLE_NAME

# å†ãƒ‡ãƒ—ãƒ­ã‚¤
vercel --prod
```

**Cloud Run:**
```bash
# ç’°å¢ƒå¤‰æ•°ç¢ºèª
gcloud run services describe video-analyzer-worker \
  --region us-central1 \
  --format="value(spec.template.spec.containers[0].env)"

# ç’°å¢ƒå¤‰æ•°æ›´æ–°
gcloud run services update video-analyzer-worker \
  --region us-central1 \
  --update-env-vars "VARIABLE=value"
```

#### 4. ã‚³ãƒ¼ãƒ«ãƒ‰ã‚¹ã‚¿ãƒ¼ãƒˆé…å»¶

**ç—‡çŠ¶:**
åˆå›ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒ30ç§’ä»¥ä¸Šã‹ã‹ã‚‹

**è§£æ±ºç­–:**
```bash
# æœ€å°ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹æ•°ã‚’1ã«è¨­å®š (æœ‰æ–™)
gcloud run services update video-analyzer-worker \
  --region us-central1 \
  --min-instances 1

# ã¾ãŸã¯ã€Cloud Schedulerã§å®šæœŸçš„ã«ã‚¦ã‚©ãƒ¼ãƒ ã‚¢ãƒƒãƒ—
gcloud scheduler jobs create http warm-up-worker \
  --schedule "*/5 * * * *" \
  --uri "https://video-analyzer-worker-820467345033.us-central1.run.app/health"
```

---

## ãƒ‡ãƒ—ãƒ­ã‚¤ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

### ãƒ‡ãƒ—ãƒ­ã‚¤å‰

- [ ] ãƒ­ãƒ¼ã‚«ãƒ«ãƒ†ã‚¹ãƒˆæˆåŠŸ
- [ ] TypeScriptãƒ“ãƒ«ãƒ‰æˆåŠŸ
- [ ] ç’°å¢ƒå¤‰æ•°ç¢ºèª
- [ ] `.env.local` ã¨æœ¬ç•ªç’°å¢ƒã®å·®ç•°ç¢ºèª
- [ ] GEMINI_API_KEYãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
- [ ] Blobè‡ªå‹•å‰Šé™¤æ©Ÿèƒ½ãŒå‹•ä½œã—ã¦ã„ã‚‹ã‹ç¢ºèª

### ãƒ‡ãƒ—ãƒ­ã‚¤å¾Œ

- [ ] ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯æˆåŠŸ
- [ ] ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã‚¢ã‚¯ã‚»ã‚¹ç¢ºèª
- [ ] ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚¢ã‚¯ã‚»ã‚¹ç¢ºèª
- [ ] ãƒ­ã‚°ã«ã‚¨ãƒ©ãƒ¼ãŒãªã„ã‹ç¢ºèª
- [ ] å‹•ç”»ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ â†’ å‡¦ç† â†’ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ ã®E2Eãƒ†ã‚¹ãƒˆ
- [ ] BlobãŒè‡ªå‹•å‰Šé™¤ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª

### ç·Šæ€¥æ™‚

- [ ] ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯æ‰‹é †ã‚’æŠŠæ¡
- [ ] ãƒ­ã‚°ç¢ºèªæ–¹æ³•ã‚’æŠŠæ¡
- [ ] é€£çµ¡å…ˆã‚’ç¢ºèª

---

## ä»Šå¾Œã®æ”¹å–„æ¡ˆ

### çŸ­æœŸ (1-2é€±é–“)

1. ~~**GEMINI_API_KEYã®è¿½åŠ **~~ âœ… å®Œäº†
   - Cloud Runã«ç’°å¢ƒå¤‰æ•°è¿½åŠ æ¸ˆã¿
   - Secret Managerã¸ã®ç§»è¡Œï¼ˆæ¨å¥¨ï¼‰

2. **CI/CDãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³æ§‹ç¯‰**
   - GitHub Actionsè¿½åŠ 
   - è‡ªå‹•ãƒ†ã‚¹ãƒˆ
   - è‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤

3. ~~**ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°å¼·åŒ–**~~ âœ… å®Œäº†ï¼ˆ2025-11-02ï¼‰
   - Cloud Monitoringã‚¢ãƒ©ãƒ¼ãƒˆè¨­å®šæ¸ˆã¿
   - ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ä½œæˆæ¸ˆã¿
   - ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ã‚¹ã‚¯ãƒªãƒ—ãƒˆå®Ÿè£…æ¸ˆã¿
   - æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—: é€šçŸ¥ãƒãƒ£ãƒãƒ«è¿½åŠ ã€Sentryå°å…¥ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰

### ä¸­æœŸ (1-2ãƒ¶æœˆ)

1. **ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–**
   - Cloud CDNè¿½åŠ 
   - ç”»åƒæœ€é©åŒ–
   - ã‚­ãƒ£ãƒƒã‚·ãƒ¥æˆ¦ç•¥

2. **ã‚³ã‚¹ãƒˆæœ€é©åŒ–**
   - Blobä¿æŒæœŸé–“æœ€é©åŒ–
   - Cloud Runæœ€å°ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹èª¿æ•´
   - ä¸è¦ãªãƒ­ã‚°å‰Šæ¸›

3. **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¼·åŒ–**
   - ~~Secret Managerç§»è¡Œ~~ âœ… ã‚¹ã‚¯ãƒªãƒ—ãƒˆå®Ÿè£…å®Œäº†ï¼ˆ2025-11-07ï¼‰
   - VPC Connectorè¿½åŠ 
   - ãƒ•ã‚¡ã‚¤ã‚¢ã‚¦ã‚©ãƒ¼ãƒ«ãƒ«ãƒ¼ãƒ«

### é•·æœŸ (3-6ãƒ¶æœˆ)

1. **ãƒãƒ«ãƒãƒªãƒ¼ã‚¸ãƒ§ãƒ³å¯¾å¿œ**
   - ã‚¢ã‚¸ã‚¢åœ°åŸŸã¸ã®å±•é–‹
   - ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·ãƒ¼æ”¹å–„

2. **ã‚¹ã‚±ãƒ¼ãƒ©ãƒ“ãƒªãƒ†ã‚£å‘ä¸Š**
   - ã‚­ãƒ¥ãƒ¼å°å…¥ (Pub/Sub)
   - ãƒ¯ãƒ¼ã‚«ãƒ¼ãƒ—ãƒ¼ãƒ«

3. **é«˜å¯ç”¨æ€§**
   - ãƒãƒ«ãƒãƒªãƒ¼ã‚¸ãƒ§ãƒ³ãƒ‡ãƒ—ãƒ­ã‚¤
   - ãƒ•ã‚§ã‚¤ãƒ«ã‚ªãƒ¼ãƒãƒ¼è¨­å®š

---

## Secret Managerç§»è¡Œã‚¬ã‚¤ãƒ‰

### æ¦‚è¦

GCP Secret Managerã‚’ä½¿ç”¨ã—ã¦ã€å¹³æ–‡ã§ä¿å­˜ã•ã‚Œã¦ã„ã‚‹APIã‚­ãƒ¼ã¨ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚’å®‰å…¨ã«ç®¡ç†ã—ã¾ã™ã€‚

**ç§»è¡Œå¯¾è±¡:**
- `OPENAI_API_KEY` (Whisper API)
- `GEMINI_API_KEY` (Gemini Vision API)
- `WORKER_SECRET` (Workerèªè¨¼)
- `SUPABASE_SERVICE_ROLE_KEY` (Supabaseç®¡ç†)
- `BLOB_READ_WRITE_TOKEN` (Vercel Blob)
- `CLERK_SECRET_KEY` (Clerkèªè¨¼)

**ç§»è¡Œã—ãªã„ã‚‚ã®:**
- `NEXT_PUBLIC_*` å¤‰æ•°ï¼ˆå…¬é–‹éµãªã®ã§å•é¡Œãªã—ï¼‰
- `NODE_ENV`ï¼ˆæ©Ÿå¯†æƒ…å ±ã§ã¯ãªã„ï¼‰
- `CLOUD_RUN_URL`ï¼ˆæ©Ÿå¯†æƒ…å ±ã§ã¯ãªã„ï¼‰

### äº‹å‰æº–å‚™

1. **Secret Manager APIæœ‰åŠ¹åŒ–:**
```bash
gcloud services enable secretmanager.googleapis.com --project=video-analyzer-worker
```

2. **ç’°å¢ƒå¤‰æ•°ã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ï¼ˆé‡è¦ï¼‰:**
```bash
# Cloud Runç’°å¢ƒå¤‰æ•°ã‚’ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
gcloud run services describe video-analyzer-worker \
  --region us-central1 \
  --format="value(spec.template.spec.containers[0].env)" > backup-env-vars.txt

# Vercelç’°å¢ƒå¤‰æ•°ã‚’ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ï¼ˆæ‰‹å‹•ï¼‰
# Vercel Dashboard â†’ Project â†’ Settings â†’ Environment Variables â†’ Export
```

3. **å¿…è¦ãªç’°å¢ƒå¤‰æ•°ã‚’ã‚·ã‚§ãƒ«ã‚»ãƒƒã‚·ãƒ§ãƒ³ã«è¨­å®š:**
```bash
# ç¾åœ¨ã®Cloud Runç’°å¢ƒå¤‰æ•°ã‚’å–å¾—ã—ã¦export
export OPENAI_API_KEY="sk-svcacct-..."
export GEMINI_API_KEY="<your-key>"
export WORKER_SECRET="4MeGFIt36xoh1GdGLu9jnYLVX90BuzJqGrytHGjeNMw="
export SUPABASE_SERVICE_ROLE_KEY="eyJhbGci..."
export BLOB_READ_WRITE_TOKEN="vercel_blob_rw_..."
export CLERK_SECRET_KEY="sk_test_..."
```

### ç§»è¡Œæ‰‹é †ï¼ˆæœ¬ç•ªç’°å¢ƒï¼‰

#### ã‚¹ãƒ†ãƒƒãƒ—1: ç§»è¡Œã‚¹ã‚¯ãƒªãƒ—ãƒˆå®Ÿè¡Œ

```bash
cd /path/to/video-analyzer-V2-web

# ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å®Ÿè¡Œï¼ˆSecret Manager ã«ä½œæˆã®ã¿ã€Cloud Run ã¯æ›´æ–°ã—ãªã„ï¼‰
./scripts/migrate-to-secret-manager.sh
```

**ã“ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒå®Ÿè¡Œã™ã‚‹ã“ã¨:**
- Secret Managerã«å…¨ã¦ã®ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚’ä½œæˆ
- Cloud Runã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã«`secretAccessor`æ¨©é™ã‚’ä»˜ä¸
- ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ç”¨ã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ•ã‚¡ã‚¤ãƒ«ç”Ÿæˆï¼ˆ`scripts/rollback-env-vars-YYYYMMDD-HHMMSS.txt`ï¼‰

**ã“ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒå®Ÿè¡Œã—ãªã„ã“ã¨:**
- Cloud Runã‚µãƒ¼ãƒ“ã‚¹ã®æ›´æ–°ï¼ˆæ„å›³çš„ã«åˆ†é›¢ï¼‰

#### ã‚¹ãƒ†ãƒƒãƒ—2: æ¤œè¨¼ã‚¹ã‚¯ãƒªãƒ—ãƒˆå®Ÿè¡Œ

```bash
# Secret Managerã®çŠ¶æ…‹ã‚’ç¢ºèª
./scripts/verify-secrets.sh
```

**ç¢ºèªé …ç›®:**
- å…¨ã¦ã®ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆãŒSecret Managerã«å­˜åœ¨ã™ã‚‹ã‹
- æœ€æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãŒå­˜åœ¨ã™ã‚‹ã‹
- IAMæ¨©é™ãŒæ­£ã—ãè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹
- Cloud Runã‚µãƒ¼ãƒ“ã‚¹ãŒç¨¼åƒã—ã¦ã„ã‚‹ã‹

#### ã‚¹ãƒ†ãƒƒãƒ—3: Cloud Run ã‚µãƒ¼ãƒ“ã‚¹æ›´æ–°ï¼ˆæœ¬ç•ªé©ç”¨ï¼‰

**âš ï¸ é‡è¦: ã“ã®æ“ä½œã§Cloud Runã‚µãƒ¼ãƒ“ã‚¹ãŒå†èµ·å‹•ã—ã¾ã™**

```bash
# ç§»è¡Œã‚¹ã‚¯ãƒªãƒ—ãƒˆã®å‡ºåŠ›ã«è¡¨ç¤ºã•ã‚ŒãŸã‚³ãƒãƒ³ãƒ‰ã‚’ã‚³ãƒ”ãƒ¼ã—ã¦å®Ÿè¡Œ:
gcloud run services update video-analyzer-worker \
  --region us-central1 \
  --update-secrets \
"OPENAI_API_KEY=OPENAI_API_KEY:latest,\
GEMINI_API_KEY=GEMINI_API_KEY:latest,\
WORKER_SECRET=WORKER_SECRET:latest,\
SUPABASE_SERVICE_ROLE_KEY=SUPABASE_SERVICE_ROLE_KEY:latest,\
BLOB_READ_WRITE_TOKEN=BLOB_READ_WRITE_TOKEN:latest,\
CLERK_SECRET_KEY=CLERK_SECRET_KEY:latest" \
  --clear-env-vars \
  --set-env-vars "NODE_ENV=production"
```

#### ã‚¹ãƒ†ãƒƒãƒ—4: å‹•ä½œç¢ºèª

```bash
# 1. ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯
curl https://video-analyzer-worker-820467345033.us-central1.run.app/health

# 2. ãƒ­ã‚°ç¢ºèªï¼ˆã‚¨ãƒ©ãƒ¼ãŒãªã„ã‹ï¼‰
gcloud run services logs tail video-analyzer-worker --region us-central1

# 3. E2Eãƒ†ã‚¹ãƒˆï¼ˆå®Ÿéš›ã®å‹•ç”»å‡¦ç†ï¼‰
# â†’ ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã‹ã‚‰å‹•ç”»ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ â†’ å‡¦ç† â†’ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
```

#### ã‚¹ãƒ†ãƒƒãƒ—5: Vercelç’°å¢ƒå¤‰æ•°æ›´æ–°ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰

Vercelå´ã‚‚Secret Managerç§»è¡Œã‚’å¸Œæœ›ã™ã‚‹å ´åˆã¯ã€ä»¥ä¸‹ã®ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚’å‰Šé™¤:
- `SUPABASE_SERVICE_ROLE_KEY`ï¼ˆãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã§ã¯ä¸è¦ï¼‰
- `BLOB_READ_WRITE_TOKEN`ï¼ˆãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã§ã¯å¿…è¦ã€ãŸã ã—Secret Manageræ¨å¥¨ï¼‰
- `CLERK_SECRET_KEY`ï¼ˆãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã§ä½¿ç”¨ã€Secret Manageræ¨å¥¨ï¼‰

**æ³¨æ„**: Vercelã¯GCP Secret Managerã«ç›´æ¥ã‚¢ã‚¯ã‚»ã‚¹ã§ããªã„ãŸã‚ã€ä»¥ä¸‹ã®é¸æŠè‚¢ãŒã‚ã‚Šã¾ã™:
1. **Vercelç’°å¢ƒå¤‰æ•°ã®ã¾ã¾ç¶­æŒ**ï¼ˆç¾çŠ¶ç¶­æŒã€æ¨å¥¨ï¼‰
2. **Vercelã‚¨ãƒƒã‚¸æ©Ÿèƒ½ã‚’ä½¿ç”¨**ã—ã¦Secret Managerã‹ã‚‰å–å¾—ï¼ˆè¤‡é›‘ï¼‰

### ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯æ‰‹é †

ä¸‡ãŒä¸€å•é¡ŒãŒç™ºç”Ÿã—ãŸå ´åˆã®ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯æ‰‹é †:

#### å³åº§ã®ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼ˆãƒªãƒ“ã‚¸ãƒ§ãƒ³æˆ»ã—ï¼‰

```bash
# å‰ã®ãƒªãƒ“ã‚¸ãƒ§ãƒ³ã«ãƒˆãƒ©ãƒ•ã‚£ãƒƒã‚¯ã‚’æˆ»ã™
gcloud run revisions list --service video-analyzer-worker --region us-central1

# å‰ã®ãƒªãƒ“ã‚¸ãƒ§ãƒ³ï¼ˆSecret Managerç§»è¡Œå‰ï¼‰ã«ãƒˆãƒ©ãƒ•ã‚£ãƒƒã‚¯ã‚’åˆ‡ã‚Šæ›¿ãˆ
gcloud run services update-traffic video-analyzer-worker \
  --region us-central1 \
  --to-revisions video-analyzer-worker-00001=100
```

#### å®Œå…¨ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼ˆç’°å¢ƒå¤‰æ•°ã‚’å¹³æ–‡ã«æˆ»ã™ï¼‰

```bash
# ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ç’°å¢ƒå¤‰æ•°ã‚’èª­ã¿è¾¼ã¿
source scripts/rollback-env-vars-YYYYMMDD-HHMMSS.txt

# Cloud Runã‚µãƒ¼ãƒ“ã‚¹ã‚’å…ƒã®è¨­å®šã«æˆ»ã™
gcloud run services update video-analyzer-worker \
  --region us-central1 \
  --clear-secrets \
  --set-env-vars \
"BLOB_READ_WRITE_TOKEN=${BLOB_READ_WRITE_TOKEN},\
SUPABASE_URL=${SUPABASE_URL},\
SUPABASE_SERVICE_ROLE_KEY=${SUPABASE_SERVICE_ROLE_KEY},\
OPENAI_API_KEY=${OPENAI_API_KEY},\
GEMINI_API_KEY=${GEMINI_API_KEY},\
WORKER_SECRET=${WORKER_SECRET},\
NODE_ENV=production"
```

### Secret Manageré‹ç”¨ã‚¬ã‚¤ãƒ‰

#### ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã®ãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³

å®šæœŸçš„ã«ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚’ãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã™ã‚‹ã“ã¨ã‚’æ¨å¥¨ï¼ˆ3-6ãƒ¶æœˆã”ã¨ï¼‰:

```bash
# 1. æ–°ã—ã„APIã‚­ãƒ¼ã‚’ç”Ÿæˆï¼ˆå„ã‚µãƒ¼ãƒ“ã‚¹ã®ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã§ï¼‰

# 2. Secret Managerã«æ–°ã—ã„ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’è¿½åŠ 
echo -n "new-secret-value" | gcloud secrets versions add OPENAI_API_KEY \
  --project=video-analyzer-worker \
  --data-file=-

# 3. Cloud Runã¯è‡ªå‹•çš„ã«æœ€æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ä½¿ç”¨ï¼ˆ`latest`å‚ç…§ï¼‰

# 4. å¤ã„APIã‚­ãƒ¼ã‚’ç„¡åŠ¹åŒ–ï¼ˆå„ã‚µãƒ¼ãƒ“ã‚¹ã®ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã§ï¼‰
```

#### ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã®ç¢ºèª

```bash
# Secretä¸€è¦§
gcloud secrets list --project=video-analyzer-worker

# ç‰¹å®šã®Secretã®è©³ç´°
gcloud secrets describe OPENAI_API_KEY --project=video-analyzer-worker

# æœ€æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®å€¤ã‚’å–å¾—ï¼ˆæ³¨æ„: å‡ºåŠ›ã•ã‚Œã‚‹ã®ã§æ…é‡ã«ï¼‰
gcloud secrets versions access latest --secret=OPENAI_API_KEY --project=video-analyzer-worker
```

#### IAMæ¨©é™ã®ç¢ºèªãƒ»è¿½åŠ 

```bash
# ç‰¹å®šã®Secretã®IAMãƒãƒªã‚·ãƒ¼ç¢ºèª
gcloud secrets get-iam-policy OPENAI_API_KEY --project=video-analyzer-worker

# è¿½åŠ ã®ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã«æ¨©é™ä»˜ä¸
gcloud secrets add-iam-policy-binding OPENAI_API_KEY \
  --project=video-analyzer-worker \
  --member="serviceAccount:new-service-account@project.iam.gserviceaccount.com" \
  --role="roles/secretmanager.secretAccessor"
```

### ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

#### å•é¡Œ1: Cloud RunãŒã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã«ã‚¢ã‚¯ã‚»ã‚¹ã§ããªã„

**ç—‡çŠ¶:**
```
Error: Secret "OPENAI_API_KEY" not accessible
```

**åŸå› :**
- IAMæ¨©é™ãŒä¸è¶³ã—ã¦ã„ã‚‹
- Secret ManagerãŒæœ‰åŠ¹åŒ–ã•ã‚Œã¦ã„ãªã„

**è§£æ±ºç­–:**
```bash
# IAMæ¨©é™ã‚’å†ä»˜ä¸
gcloud secrets add-iam-policy-binding OPENAI_API_KEY \
  --project=video-analyzer-worker \
  --member="serviceAccount:820467345033-compute@developer.gserviceaccount.com" \
  --role="roles/secretmanager.secretAccessor"

# Secret Manager APIç¢ºèª
gcloud services list --enabled --filter="name:secretmanager.googleapis.com"
```

#### å•é¡Œ2: ç§»è¡Œå¾Œã«Cloud RunãŒèµ·å‹•ã—ãªã„

**ç—‡çŠ¶:**
```
Revision 'video-analyzer-worker-00002' is not ready
```

**åŸå› :**
- ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆå‚ç…§ãŒé–“é•ã£ã¦ã„ã‚‹
- ç’°å¢ƒå¤‰æ•°åã®ã‚¿ã‚¤ãƒ—ãƒŸã‚¹

**è§£æ±ºç­–:**
```bash
# Cloud Runãƒ­ã‚°ç¢ºèª
gcloud run services logs tail video-analyzer-worker --region us-central1

# ç’°å¢ƒå¤‰æ•°ã¨ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆå‚ç…§ç¢ºèª
gcloud run services describe video-analyzer-worker \
  --region us-central1 \
  --format="value(spec.template.spec.containers[0].env)"
```

#### å•é¡Œ3: Vercelã‹ã‚‰å‡¦ç†ãŒé–‹å§‹ã•ã‚Œãªã„

**ç—‡çŠ¶:**
- ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã‹ã‚‰å‹•ç”»ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å¾Œã€å‡¦ç†ãŒé–‹å§‹ã•ã‚Œãªã„

**åŸå› :**
- `WORKER_SECRET`ãŒæ­£ã—ãè¨­å®šã•ã‚Œã¦ã„ãªã„

**è§£æ±ºç­–:**
```bash
# Vercelç’°å¢ƒå¤‰æ•°ã¨Secret Managerã®å€¤ãŒä¸€è‡´ã—ã¦ã„ã‚‹ã‹ç¢ºèª
vercel env pull .env.vercel
cat .env.vercel | grep WORKER_SECRET

# Secret Manager ã®å€¤ã‚’ç¢ºèª
gcloud secrets versions access latest --secret=WORKER_SECRET --project=video-analyzer-worker

# å€¤ãŒç•°ãªã‚‹å ´åˆã€Vercelç’°å¢ƒå¤‰æ•°ã‚’æ›´æ–°
vercel env rm WORKER_SECRET production
vercel env add WORKER_SECRET production
```

### ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹

1. **æœ€å°æ¨©é™ã®åŸå‰‡:**
   - Cloud Runã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã«ã¯`secretAccessor`ã®ã¿ä»˜ä¸
   - ä¸è¦ãªã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã«ã¯æ¨©é™ã‚’ä»˜ä¸ã—ãªã„

2. **å®šæœŸçš„ãªãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³:**
   - APIã‚­ãƒ¼ã¯3-6ãƒ¶æœˆã”ã¨ã«ãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³
   - `WORKER_SECRET`ã¯6ãƒ¶æœˆã”ã¨ã«ãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³

3. **ç›£æŸ»ãƒ­ã‚°:**
   - Secret Managerã®ã‚¢ã‚¯ã‚»ã‚¹ãƒ­ã‚°ã‚’å®šæœŸçš„ã«ç¢ºèª
   - ä¸å¯©ãªã‚¢ã‚¯ã‚»ã‚¹ãŒãªã„ã‹ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°

4. **ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—:**
   - ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ç”¨ã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å®‰å…¨ã«ä¿ç®¡
   - `.gitignore`ã«è¿½åŠ ã—ã¦èª¤ã‚³ãƒŸãƒƒãƒˆã‚’é˜²æ­¢

5. **ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡:**
   - Secret Managerã¸ã®ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ã¯æœ€å°é™ã®ãƒ¡ãƒ³ãƒãƒ¼ã«é™å®š
   - GCPãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®IAMãƒãƒªã‚·ãƒ¼ã‚’å®šæœŸçš„ã«è¦‹ç›´ã—

---

## å‚è€ƒãƒªãƒ³ã‚¯

- [Vercel Documentation](https://vercel.com/docs)
- [Cloud Run Documentation](https://cloud.google.com/run/docs)
- [Next.js Deployment](https://nextjs.org/docs/deployment)
- [Supabase Documentation](https://supabase.com/docs)

---

**æœ€çµ‚æ›´æ–°:** 2025-11-01
**ãƒãƒ¼ã‚¸ãƒ§ãƒ³:** 2.0.0
