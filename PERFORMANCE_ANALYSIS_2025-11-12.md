# 処理時間とパフォーマンス分析レポート

## 分析対象セッション

**Upload ID**: `upload_1762879287046_ox9xe8ywr`  
**動画ファイル**: `mirai_0814.mp4`  
**動画サイズ**: 20.0 MB  
**動画長**: 15秒  
**解像度**: 1920x1080 (16:9)  
**音声**: なし（VAD検出0セグメント）  
**処理日時**: 2025年11月11日 16:41:48 - 16:42:39 (UTC)  

---

## 全体処理時間サマリー

| 指標 | 値 |
|------|-----|
| **総処理時間** | **50.41秒** |
| **開始時刻** | 2025-11-11 16:41:48.993614 UTC |
| **完了時刻** | 2025-11-11 16:42:39.409113 UTC |
| **処理ステータス** | 成功 |
| **検出シーン数** | 6シーン |
| **OCR処理フレーム数** | 6フレーム |
| **Whisperセグメント数** | 0（音声なし） |

---

## ステージ別処理時間詳細

### 1. 動画ダウンロード＆準備フェーズ (0-10%)
| ステージ | 開始時刻 | 完了時刻 | 所要時間 | 備考 |
|---------|---------|---------|---------|------|
| **Download Video** | 16:41:50.124 | 16:41:52.521 | **2.40秒** | Vercel Blobからダウンロード |
| **Delete Source Blob** | 16:41:52.521 | 16:41:53.614 | **1.09秒** | 自動クリーンアップ（容量対策） |
| **Compress Video** | 16:41:53.829 | 16:41:53.830 | **0.00秒** | スキップ（20MB < 200MB閾値） |

**小計**: **3.49秒** (全体の 6.9%)

### 2. メタデータ抽出フェーズ (10-20%)
| ステージ | 開始時刻 | 完了時刻 | 所要時間 | 備考 |
|---------|---------|---------|---------|------|
| **Extract Video Metadata** | 16:41:54.062 | 16:41:55.790 | **1.73秒** | FFprobe: 1920x1080, 15秒 |
| **Detect Audio Stream** | 16:41:56.004 | 16:41:56.229 | **0.23秒** | 音声ストリーム検出 |
| **Extract Audio (16kHz mono)** | 16:41:56.229 | 16:41:57.200 | **0.97秒** | FFmpeg: 16kHz モノラル抽出 |

**小計**: **2.93秒** (全体の 5.8%)

### 3. VAD + Whisper処理フェーズ (30-50%)
| ステージ | 開始時刻 | 完了時刻 | 所要時間 | 備考 |
|---------|---------|---------|---------|------|
| **VAD + Whisper Pipeline** | 16:41:57.418 | 16:41:58.024 | **0.61秒** | 音声検出なし → Whisperスキップ |

**小計**: **0.61秒** (全体の 1.2%)  
**Whisper APIコール回数**: 0回（VADにより100%コスト削減）

### 4. シーン検出 + OCR + Excel生成フェーズ (50-90%)
| ステージ | 開始時刻 | 完了時刻 | 所要時間 | 備考 |
|---------|---------|---------|---------|------|
| **マルチパスシーン検出** | 16:41:58.231 | 16:42:16.230 | **17.99秒** | 3パス検出（閾値: 0.03, 0.05, 0.10） |
| - Pass 1 (threshold 0.03) | 16:41:58.638 | 16:42:04.303 | 5.67秒 | 10カット検出 |
| - Pass 2 (threshold 0.05) | 16:42:04.303 | 16:42:10.219 | 5.92秒 | 6カット検出 |
| - Pass 3 (threshold 0.10) | 16:42:10.219 | 16:42:16.230 | 6.01秒 | 5カット検出 |
| **フレーム抽出** | 16:42:16.231 | 16:42:20.914 | **4.68秒** | 6シーンの中間点抽出 |
| **並列OCR処理** | 16:42:20.915 | 16:42:34.222 | **13.31秒** | Gemini Vision API（並列度: 3） |
| **Excel生成** | 16:42:34.426 | 16:42:35.801 | **1.38秒** | ExcelJS: 2シート構成 |

**小計**: **37.57秒** (全体の 74.5%)

#### OCR処理の詳細（並列処理）
| シーン | 処理時刻 | 所要時間 | 文字数 | 備考 |
|--------|---------|---------|--------|------|
| Scene 1 | 16:42:23.981 | 3.07秒 | 103文字 | Gemini API 1回目 |
| Scene 2 | 16:42:27.175 | 6.26秒 | 151文字 | Gemini API 2回目 |
| Scene 3 | 16:42:27.682 | 6.77秒 | 123文字 | Gemini API 3回目（並列） |
| Scene 4 | 16:42:28.421 | 7.51秒 | 146文字 | Gemini API 4回目（並列） |
| Scene 5 | 16:42:32.634 | 11.72秒 | 78文字 | Gemini API 5回目（並列） |
| Scene 6 | 16:42:34.222 | 13.31秒 | 91文字 | Gemini API 6回目（並列） |

**平均処理時間**: 2.22秒/シーン  
**Gemini APIコール回数**: 6回  
**総OCR文字数**: 692文字

### 5. 結果アップロードフェーズ (90-100%)
| ステージ | 開始時刻 | 完了時刻 | 所要時間 | 備考 |
|---------|---------|---------|---------|------|
| **Upload Result File** | 16:42:36.022 | 16:42:39.187 | **3.16秒** | Vercel Blobへアップロード |

**小計**: **3.16秒** (全体の 6.3%)

---

## ボトルネック分析

### 最も時間がかかったステージ TOP 3

1. **シーン検出 + OCR + Excel生成**: **37.57秒** (74.5%)
   - 内訳:
     - マルチパスシーン検出: 17.99秒 (47.9%)
     - 並列OCR処理（Gemini API）: 13.31秒 (35.4%)
     - フレーム抽出: 4.68秒 (12.5%)
     - Excel生成: 1.38秒 (3.7%)

2. **動画ダウンロード＆準備**: **3.49秒** (6.9%)

3. **結果アップロード**: **3.16秒** (6.3%)

### ボトルネックの詳細

#### 1. シーン検出（17.99秒）
**現状**: マルチパス方式で3回のFFmpegスキャン（閾値: 0.03, 0.05, 0.10）

**影響要因**:
- 15秒動画で約18秒の処理時間（動画長の120%）
- 各パスで約6秒（動画長の40%）

**最適化の余地**: 
- ⚠️ **中程度** - 単一パス検出への変更は精度低下リスクあり
- 現在の実装は精度を優先した設計（設計意図により触らない推奨）

#### 2. Gemini OCR処理（13.31秒）
**現状**: 並列度3で6シーンを処理

**影響要因**:
- 平均2.22秒/シーン（Gemini API応答時間）
- ネットワークレイテンシー＋AI推論時間

**最適化の余地**:
- ⚠️ **低〜中程度** - 並列度を上げる選択肢あり（現在3 → 5-6に増加可能）
- リスク: Gemini APIレート制限に抵触する可能性

#### 3. 動画ダウンロード（2.40秒）
**現状**: 20MB動画を2.4秒でダウンロード（約8.3MB/秒）

**影響要因**:
- Cloud Run ↔ Vercel Blob間のネットワーク帯域
- us-central1 リージョン間レイテンシー

**最適化の余地**:
- ✅ **低** - 現在の速度は適切（帯域は十分）

---

## リソース使用状況

### メモリ使用
- **割り当て**: 2048 MB (2 GB)
- **使用状況**: 正常（エラーログなし）
- **OOMエラー**: なし

### CPU使用
- **割り当て**: 1 vCPU
- **使用状況**: 正常
- **スロットリング**: 検出されず

### タイムアウト
- **設定値**: 600秒（10分）
- **実際の処理時間**: 50.41秒
- **余裕**: 549.59秒（91.6%余裕あり）

### ネットワーク
- **ダウンロード**: 20.0 MB (2.40秒)
- **アップロード**: Excel結果ファイル（サイズ不明、3.16秒）
- **API呼び出し**: Gemini Vision API 6回

---

## APIコール統計

### Whisper API（OpenAI）
- **呼び出し回数**: 0回
- **処理時間**: 0秒
- **コスト削減率**: 100%（VADにより音声なしを検出）

### Gemini Vision API（Google）
- **呼び出し回数**: 6回（シーンごと1回）
- **平均応答時間**: 2.22秒/リクエスト
- **総処理時間**: 13.31秒（並列処理により短縮）
- **並列度**: 3（同時実行数）
- **総文字数**: 692文字

### Vercel Blob API
- **ダウンロード**: 1回（ソース動画取得）
- **アップロード**: 1回（Excel結果保存）
- **削除**: 1回（ソース動画自動削除）

---

## パフォーマンス評価

### 総合評価: ⭐⭐⭐⭐☆ (4/5)

#### 優れている点
1. ✅ **VADによるコスト最適化**: 音声なし動画を正しく検出し、Whisper APIコールを完全回避（100%削減）
2. ✅ **並列OCR処理**: 並列度3により、逐次処理より約2倍高速化
3. ✅ **高速ダウンロード**: 8.3MB/秒の安定した転送速度
4. ✅ **リソース効率**: タイムアウトまで91.6%の余裕、メモリ・CPUエラーなし
5. ✅ **自動クリーンアップ**: ソース動画を1.09秒で削除（Blob容量対策）

#### 改善の余地がある点
1. ⚠️ **シーン検出時間**: 15秒動画で18秒の処理時間（動画長の120%）
   - 原因: マルチパス方式（3回スキャン）
   - トレードオフ: 精度 vs 速度（現在は精度優先）

2. ⚠️ **OCR並列度**: 現在3 → 5-6に増加可能
   - 制約: Gemini APIレート制限
   - 推定改善: 13.31秒 → 8-9秒（約40%短縮）

---

## 他のセッションとの比較

### 動画の特性による処理時間の違い

| 動画タイプ | 処理時間（推定） | 主要ボトルネック |
|-----------|----------------|----------------|
| **音声なし動画** (今回) | **50秒** | シーン検出 + OCR |
| **音声あり動画** (推定) | 80-120秒 | Whisper処理 + OCR |
| **長尺動画** (5分、推定) | 180-300秒 | シーン検出 + Whisper + OCR |

**今回の動画は最速ケース**（音声なし、短尺、少シーン数）

---

## 最適化提案

### 即座に実装可能（リスク: 低）
1. **OCR並列度の増加**: 3 → 5
   - 推定効果: OCR処理時間を13.31秒 → 約8秒に短縮（5秒削減）
   - リスク: Gemini APIレート制限（要監視）
   - 実装難易度: 低（環境変数で調整可能）

### 中期的に検討（リスク: 中）
2. **シーン検出の最適化**:
   - オプションA: 最初のパス（0.03閾値）の結果で十分な場合、後続パスをスキップ
   - オプションB: 2パス方式に変更（0.03, 0.10のみ）
   - 推定効果: 18秒 → 12秒（6秒削減）
   - リスク: シーン検出精度の低下
   - 実装難易度: 中

3. **Cloud CDNの活用**:
   - Vercel Blobへのアップロード結果をキャッシュ
   - 推定効果: 再ダウンロード時の高速化（初回は効果なし）
   - リスク: 低
   - 実装難易度: 中

### 長期的に検討（リスク: 高）
4. **GPU対応インスタンスへの移行**:
   - VAD処理やシーン検出を高速化
   - 推定効果: 全体で10-20秒短縮
   - リスク: コスト増加（GPU料金）
   - 実装難易度: 高

---

## 結論

### パフォーマンスサマリー
- **15秒の動画を50.41秒で処理**（動画長の3.4倍）
- **主要ボトルネック**: シーン検出（18秒、36%）とOCR（13秒、26%）
- **リソース使用**: 健全（メモリ・CPU・タイムアウトすべて余裕あり）
- **API効率**: VADにより音声処理コストを100%削減

### 推奨アクション
1. ✅ **即座に実施**: OCR並列度を3 → 5に増加（約5秒短縮）
2. ⚠️ **慎重に検討**: シーン検出の最適化（精度とのトレードオフ）
3. ⏳ **将来的に検討**: GPU対応インスタンス、Cloud CDN活用

### 最終評価
現在のパフォーマンスは**本番運用として十分に実用的**です。最適化の余地はありますが、精度と安定性を優先した設計により、ユーザー体験は良好に保たれています。

---

**レポート作成日**: 2025年11月12日  
**分析者**: Claude Code (Performance Engineer)
